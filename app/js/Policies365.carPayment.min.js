"use strict";angular.module("paySuccessCar",["CoreComponentApp","LocalStorageModule","ngMessages"]).controller("paySuccessCarController",["RestAPI","$scope","$rootScope","$location","$window","$http","localStorageService","$timeout","$sce",function(RestAPI,$scope,$rootScope,$location,$window,$http,localStorageService,$timeout,$sce){$scope.authenticate={};var proposalId="",pospBackButtonEnabled=!1,p365UIVar={mobileNumber:"+91 9962411255",mobileNumberTrim:"+919962411255",salesAssistNumber:"(022) 68284343",salesAssistNumberTrim:"02268284343",salesAssistNumberLanding:"022-68284343",claimsNumber:"(022) 42114299",claimsNumberTrim:"02242114299",claimsNumberLanding:"022-42114299",infoEmailId:"contact@policies365.com"};if(agencyPortalEnabled&&($scope.agencyPortalEnabled=agencyPortalEnabled),$location.search().source&&"posp"==$location.search().source&&(pospBackButtonEnabled=!0),$scope.sendSMS=function(){var validateAuthParam={paramMap:{}};validateAuthParam.mobileNumber=$scope.proposalDataResponse.proposalRequest.proposerDetails.mobileNumber,validateAuthParam.paramMap.firstName=$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName,validateAuthParam.funcType="PaymentSuccess",getDocUsingParam(RestAPI,"sendSMS",validateAuthParam,function(createOTP){createOTP.responseCode==$scope.p365Labels.responseCode.success?console.log("sms sent successfully for payment success"):console.log("unable to  sent sms for payment success")})},$scope.sendPolicySuccessEmail=function(){var proposalDetailsEmail={paramMap:{},funcType:"ProposalSuccessTemplate"};console.log("$scope.proposalDataResponse is: ",$scope.proposalDataResponse),proposalDetailsEmail.username=$scope.proposalDataResponse.proposalRequest.proposerDetails.emailId.trim(),proposalDetailsEmail.paramMap.customerName=$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName.trim()+" "+$scope.proposalDataResponse.proposalRequest.proposerDetails.lastName.trim(),proposalDetailsEmail.paramMap.selectedPolicyType="Car",RestAPI.invoke("sendEmail",proposalDetailsEmail).then(function(emailResponse){emailResponse.responseCode,$scope.p365Labels.responseCode.success,$scope.sendSMS()})},$scope.redirectURL=function(){if(localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){localStorage.getItem("rampUniqueId");var rampRedirectURL=localStorage.getItem("rampRedirectURL");$window.location.href=rampRedirectURL}else if(localStorage.getItem("carEagerUniqueId")){var thirdPartyRedirectionURL="http://13.233.36.16:4000/api/job/callback/new/policy/?registration_no="+$scope.proposalDataResponse.proposalRequest.vehicleDetails.registrationNumber+"&policy_holder="+$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName+"&insurance_company="+$scope.proposalDataResponse.proposalRequest.premiumDetails.insuranceCompany+"&policy_no="+$scope.proposalDataResponse.carPolicyResponse.policyNo+"&premium="+$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium+"&expire="+$scope.proposalDataResponse.proposalRequest.insuranceDetails.policyEndDate+"&cashless=Yes&policy_type="+$scope.proposalDataResponse.proposalRequest.insuranceDetails.insuranceType+"&UniqueId="+localStorage.getItem("carEagerUniqueId");console.log("thirdPartyRedirectionURL is::",thirdPartyRedirectionURL),$window.location.href=$sce.trustAsResourceUrl(thirdPartyRedirectionURL)}else pospBackButtonEnabled?$window.location.href="http://pospuat.policies365.com":agencyPortalEnabled?idepProdEnv?$window.location.href="https://www.policies365.com":$window.location.href="https://www.policies365.com":(console.log("$rootScope.affilateURL is: ",$rootScope.affilateURL),$window.location.href=$rootScope.affilateURL)},$scope.isFromMobileApp=localStorage.getItem("isFromMobileApp"),$scope.isFromMobileApp){proposalId=$location.search().proposalId;RestAPI.invoke("proposalDataReader",{proposalId:proposalId,businessLineId:3}).then(function(response){(response.responseCode=1e3)&&($scope.policyInfo={carrierId:response.data.PolicyTransaction.carrierId,registrationNo:response.data.PolicyTransaction.proposalRequest.vehicleDetails.registrationNumber,policyNo:response.data.PolicyTransaction.carPolicyResponse.policyNo,idv:response.data.PolicyTransaction.proposalRequest.premiumDetails.insuredDeclareValue,ncb:response.data.PolicyTransaction.proposalRequest.premiumDetails.ncbPercentage,vehicle:response.data.PolicyTransaction.proposalRequest.vehicleDetails.make+" "+response.data.PolicyTransaction.proposalRequest.vehicleDetails.model+" "+response.data.PolicyTransaction.proposalRequest.vehicleDetails.variant,email:response.data.PolicyTransaction.proposalRequest.proposerDetails.emailId,transactionId:response.data.PolicyTransaction.proposalId,premium:response.data.PolicyTransaction.proposalRequest.premiumDetails.grossPremium,validity:response.data.PolicyTransaction.policyStartDate+" to "+response.data.PolicyTransaction.policyExpiryDate,mobileNo:response.data.PolicyTransaction.proposalRequest.proposerDetails.mobileNumber})})}else loadDatbase(function(){if(idepProdEnv&&($rootScope.modalSurvey=!0),wordPressEnabled?($rootScope.wordPressEnabled=wordPressEnabled,$rootScope.wp_path=wp_path):$rootScope.wp_path="",$scope.p365Labels=carPolicyLabels,policies365Details?$scope.policies365Details=policies365Details:(console.log("retrieving p365 labels using UI"),$scope.policies365Details=p365UIVar),$rootScope.title=$scope.p365Labels.policies365Title.PaySuccess,$location.search().proposalId?(proposalId=$location.search().proposalId,console.log("proposal id found ..")):$location.search().proposalNo?(proposalId=$location.search().proposalNo,console.log("proposal number found ..")):localStorageService.get("proposalIdEncrypted")&&(proposalId=localStorageService.get("proposalIdEncrypted")),proposalId){var proposalDocParam={};proposalDocParam.proposalId=proposalId,proposalDocParam.businessLineId=3,RestAPI.invoke("proposalDataReader",proposalDocParam).then(function(proposalDataResponse){if(proposalDataResponse.responsecode==$scope.p365Labels.responseCode.success){if($scope.proposalDataResponse=proposalDataResponse.data.PolicyTransaction,$scope.sendPolicySuccessEmail(),console.log("$scope.proposalDataResponse in car pay success",$scope.proposalDataResponse),$scope.proposalDataResponse.requestSource&&"posp"==$scope.proposalDataResponse.requestSource&&$location.search("userName",$scope.proposalDataResponse.userName),console.log("imauticAutomation flag is: ",imauticAutomation),$scope.proposalDataResponse.carPolicyResponse.policyNo?(console.log("inside if block as policy number found"),1==imauticAutomation&&imatEvent("PaymentGenerated")):(console.log("inside else block as no policy number found"),1==imauticAutomation&&imatEvent("PaymentSuccess")),$scope.carProposeFormDetails=$scope.proposalDataResponse.proposalRequest,localStorageService.get("quoteUserInfo")&&($scope.quoteUserInfo=localStorageService.get("quoteUserInfo"),$scope.quoteUserInfo.createLeadStatus=!0,localStorageService.set("quoteUserInfo",$scope.quoteUserInfo),$scope.quoteUserInfo&&(messageIDVar=$scope.quoteUserInfo.messageId)),$scope.loading=!1,$scope.showSuccessScreen=!1,localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){var policyEndDate,rampUniqueId=localStorage.getItem("rampUniqueId"),rampRedirectURL=localStorage.getItem("rampRedirectURL");policyEndDate=$scope.proposalDataResponse.proposalRequest.insuranceDetails.policyEndDate?$scope.proposalDataResponse.proposalRequest.insuranceDetails.policyEndDate:"NA";var policyDetails={rampUniqueId:rampUniqueId,policyDetails:{status:"success",ins_provider_name:$scope.proposalDataResponse.proposalRequest.premiumDetails.insuranceCompany,exp_date:policyEndDate,payment_amount:$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium}};console.log("redirection url is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:rampRedirectURL,headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("ramp api response is: ",callback)}).error(function(data,status){console.log("ramp api response in error is: ",data)})}if(localStorage.getItem("desiSkillUniqueId")){var desiSkillUniqueId=localStorage.getItem("desiSkillUniqueId"),desiSkillAgentId=localStorage.getItem("desiSkillAgentId"),selectedMake="",selectedModel="",selectedVariant="",selectedVehicleDetails={};localStorageService.get("carQuoteInputParamaters")?(selectedMake=(selectedVehicleDetails=localStorageService.get("carQuoteInputParamaters").vehicleInfo).make,selectedModel=selectedVehicleDetails.model,selectedVariant=selectedVehicleDetails.variant):(selectedMake=$scope.proposalDataResponse.proposalRequest.vehicleDetails.make,selectedModel=$scope.proposalDataResponse.proposalRequest.vehicleDetails.model,selectedVariant=$scope.proposalDataResponse.proposalRequest.vehicleDetails.variant),policyNo=$location.search().policyNo?$location.search().policyNo:$scope.proposalDataResponse.carPolicyResponse.policyNo;policyDetails={mblNum:$scope.proposalDataResponse.carPolicyResponse.mobile,txnId:desiSkillUniqueId,make:selectedMake,model:selectedModel,variant:selectedVariant,policyNumber:policyNo,type:"car",agentId:desiSkillAgentId,premiumAmount:$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium};console.log("policy details  is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:"https://crm.gkms.in/api/insurance/p365_callback.php",headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("desiskill api response is: ",callback)}).error(function(data,status){console.log("desiskill api response in error is: ",data)})}}else{if(localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){rampUniqueId=localStorage.getItem("rampUniqueId"),rampRedirectURL=localStorage.getItem("rampRedirectURL"),policyDetails={rampUniqueId:rampUniqueId,policyDetails:{status:"success",ins_provider_name:$scope.proposalDataResponse.proposalRequest.premiumDetails.insuranceCompany,exp_date:$scope.proposalDataResponse.proposalRequest.insuranceDetails.policyEndDate,payment_amount:$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium}};console.log("redirection url is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:rampRedirectURL,headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("ramp api response is: ",callback)}).error(function(data,status){console.log("ramp api response in error is: ",data)})}if(localStorage.getItem("desiSkillUniqueId")){var policyNo;desiSkillUniqueId=localStorage.getItem("desiSkillUniqueId"),desiSkillAgentId=localStorage.getItem("desiSkillAgentId");policyNo=$location.search().policyNo?$location.search().policyNo:$scope.proposalDataResponse.carPolicyResponse.policyNo;policyDetails={mblNum:$scope.proposalDataResponse.carPolicyResponse.mobile,txnId:desiSkillUniqueId,make:$scope.proposalDataResponse.proposalRequest.vehicleDetails.make,model:$scope.proposalDataResponse.proposalRequest.vehicleDetails.model,variant:$scope.proposalDataResponse.proposalRequest.vehicleDetails.variant,policyNumber:policyNo,type:"car",agentId:desiSkillAgentId,premiumAmount:$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium};console.log("policy details  is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:"https://crm.gkms.in/api/insurance/p365_callback.php",headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("ramp api response is: ",callback)}).error(function(data,status){console.log("ramp api response in error is: ",data)})}$scope.loading=!1,$rootScope.P365Alert("Policies365","Some error Occurred ","Ok")}})}$scope.viewPolicy=function(){$scope.modalOTP=!0,$scope.resendOTP()},$scope.closeAuthenticateForm=function(){$scope.modalOTP=!1},$scope.authenticateUser=function(){$scope.disableOTP=!1;var authenticateUserParam={};authenticateUserParam.mobileNumber=$scope.carProposeFormDetails.proposerDetails.mobileNumber,authenticateUserParam.OTP=Number($scope.authenticate.enteredOTP),getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.validateOTP,authenticateUserParam,function(createOTP){if(createOTP.responseCode==$scope.p365Labels.responseCode.success){$scope.invalidOTPError="",$scope.modalOTP=!1;var userLoginInfo={};userLoginInfo.username=createOTP.data.firstName,userLoginInfo.mobileNumber=createOTP.data.mobile,userLoginInfo.status=!0,localStorageService.set("userLoginInfo",userLoginInfo),localStorageService.set("userProfileDetails",createOTP.data),$location.path("/dashboard")}else createOTP.responseCode==$scope.p365Labels.responseCode.noRecordsFound?$scope.invalidOTPError=$scope.p365Labels.validationMessages.invalidOTP:createOTP.responseCode==$scope.p365Labels.responseCode.expiredOTP?$scope.invalidOTPError=$scope.p365Labels.validationMessages.expiredOTP:$scope.invalidOTPError=$scope.p365Labels.validationMessages.authOTP})},$scope.resendOTP=function(){var validateLoginParam={paramMap:{}};validateLoginParam.mobileNumber=$scope.carProposeFormDetails.proposerDetails.mobileNumber,validateLoginParam.funcType=$scope.p365Labels.functionType.optAuth,validateLoginParam.paramMap.OTP=$scope.p365Labels.functionType.otpGenerate,getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.sendSMS,validateLoginParam,function(createOTP){createOTP.responseCode==$scope.p365Labels.responseCode.success?$scope.invalidOTPError="":createOTP.responseCode==$scope.p365Labels.responseCode.blockedMobile?($scope.invalidOTPError=createOTP.message,$scope.disableOTP=!0):$scope.invalidOTPError=$scope.p365Labels.errorMessage.createOTP})}})}]),angular.module("payFailureCar",["CoreComponentApp","LocalStorageModule","ngMessages"]).controller("payFailureCarController",["RestAPI","$scope","$rootScope","$location","$window","$http","localStorageService","$timeout","$sce",function(RestAPI,$scope,$rootScope,$location,$window,$http,localStorageService,$timeout,$sce){console.log("agencyPortalEnabled flag is : ",agencyPortalEnabled);var pospBackButtonEnabled=!1,p365UIVar={mobileNumber:"+91 9962411255",mobileNumberTrim:"+919962411255",salesAssistNumber:"(022) 68284343",salesAssistNumberTrim:"02268284343",salesAssistNumberLanding:"022-68284343",claimsNumber:"(022) 42114299",claimsNumberTrim:"02242114299",claimsNumberLanding:"022-42114299",infoEmailId:"contact@policies365.com"};agencyPortalEnabled&&($scope.agencyPortalEnabled=agencyPortalEnabled),$location.search().source&&"posp"==$location.search().source&&(pospBackButtonEnabled=!0),$scope.sendSMS=function(){var validateAuthParam={paramMap:{}};validateAuthParam.mobileNumber=$scope.proposalDataResponse.proposalRequest.proposerDetails.mobileNumber,validateAuthParam.paramMap.firstName=$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName,validateAuthParam.funcType="ProposalFailed",getDocUsingParam(RestAPI,"sendSMS",validateAuthParam,function(createOTP){createOTP.responseCode==$scope.p365Labels.responseCode.success?console.log("sms sent successfully for payment success"):console.log("unable to  sent sms for payment success")})},$scope.sendPolicySuccessEmail=function(){var proposalDetailsEmail={paramMap:{},funcType:"ProposalFailureTemplate"};console.log("$scope.proposalDataResponse is: ",$scope.proposalDataResponse),proposalDetailsEmail.username=$scope.proposalDataResponse.proposalRequest.proposerDetails.emailId.trim(),proposalDetailsEmail.paramMap.customerName=$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName.trim()+" "+$scope.proposalDataResponse.proposalRequest.proposerDetails.lastName.trim(),proposalDetailsEmail.paramMap.selectedPolicyType="Car",RestAPI.invoke("sendEmail",proposalDetailsEmail).then(function(emailResponse){emailResponse.responseCode,$scope.p365Labels.responseCode.success,$scope.sendSMS()})},$scope.redirectURL=function(){if(localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){localStorage.getItem("rampUniqueId");var rampRedirectURL=localStorage.getItem("rampRedirectURL");window.location.href=rampRedirectURL}else if(localStorage.getItem("carEagerUniqueId")){var thirdPartyRedirectionURL="http://13.233.36.16:4000/api/job/callback/new/policy/?registration_no="+$scope.proposalDataResponse.proposalRequest.vehicleDetails.registrationNumber+"&policy_holder="+$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName+"&insurance_company="+$scope.proposalDataResponse.proposalRequest.premiumDetails.insuranceCompany+"&policy_no="+$scope.proposalDataResponse.carPolicyResponse.policyNo+"&premium="+$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium+"&expire="+$scope.proposalDataResponse.proposalRequest.insuranceDetails.policyEndDate+"&cashless=Yes&policy_type="+$scope.proposalDataResponse.proposalRequest.insuranceDetails.insuranceType+"&UniqueId="+localStorage.getItem("carEagerUniqueId");console.log("thirdPartyRedirectionURL is::",thirdPartyRedirectionURL),$window.location.href=$sce.trustAsResourceUrl(thirdPartyRedirectionURL)}else pospBackButtonEnabled?$window.location.href="http://pospuat.policies365.com":agencyPortalEnabled?idepProdEnv?$window.location.href="https://www.policies365.com":$window.location.href="https://www.policies365.com":$window.location.href=$rootScope.affilateURL},loadDatbase(function(){idepProdEnv&&($rootScope.modalSurvey=!0),wordPressEnabled?($rootScope.wordPressEnabled=wordPressEnabled,$rootScope.wp_path=wp_path):$rootScope.wp_path="",$rootScope.displayTimer=function(maxDuration){$timeout(function(){$rootScope.displayTime=maxDuration-1,maxDuration--,1==$rootScope.displayTime&&($window.top.location.href=$rootScope.affilateURL),$rootScope.displayTime>1&&$rootScope.displayTimer(maxDuration)},1e3)},console.log("$rootScope.affilateUser in paysucess :"+$rootScope.affilateUser),$rootScope.affilateRedirection&&!idepProdEnv&&($rootScope.displayTime=10,$rootScope.displayTimer($scope.displayTime)),$scope.p365Labels=carPolicyLabels,policies365Details?$scope.policies365Details=policies365Details:(console.log("retrieving p365 labels using UI"),$scope.policies365Details=p365UIVar),$scope.statusCode=$location.search().statusCode?$location.search().statusCode:void 0,$rootScope.title=$scope.p365Labels.policies365Title.PayFailure,console.log("Car Common Labels Received."),$scope.carReponseToken=localStorageService.get("carReponseToken"),console.log("Car Proposal Submission Response Received. : "+JSON.stringify($scope.carReponseToken));var quoteUserInfo=localStorageService.get("quoteUserInfo");console.log("Car Quote User Info Received. : "+JSON.stringify($scope.quoteUserInfo)),quoteUserInfo&&(messageIDVar=quoteUserInfo.messageId,$scope.$apply());var proposalId="";if($location.search().proposalId?proposalId=$location.search().proposalId:$scope.carReponseToken&&$scope.carReponseToken.proposalId&&(proposalId=$scope.carReponseToken.proposalId),proposalId){var proposalDocParam={};proposalDocParam.proposalId=proposalId,proposalDocParam.businessLineId=3,RestAPI.invoke("proposalDataReader",proposalDocParam).then(function(proposalDataResponse){if(proposalDataResponse.responsecode==$scope.p365Labels.responseCode.success){proposalDataResponse=proposalDataResponse.data.PolicyTransaction;$scope.proposalDataResponse=proposalDataResponse,$scope.sendPolicySuccessEmail(),console.log("$scope.proposalDataResponse in car failure",proposalDataResponse),proposalDataResponse.requestSource&&"posp"==proposalDataResponse.requestSource&&$location.search("userName",proposalDataResponse.userName),$scope.loading=!1}if(localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){var rampUniqueId=localStorage.getItem("rampUniqueId"),rampRedirectURL=localStorage.getItem("rampRedirectURL"),policyDetails={rampUniqueId:rampUniqueId,policyDetails:{status:"failure"}};console.log("redirection url is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:rampRedirectURL,headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("ramp api response is: ",callback)}).error(function(data,status){console.log("ramp api response in error is: ",data)})}})}if(localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){var rampUniqueId=localStorage.getItem("rampUniqueId"),rampRedirectURL=localStorage.getItem("rampRedirectURL"),policyDetails={rampUniqueId:rampUniqueId,policyDetails:{status:"failure"}};console.log("redirection url is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:rampRedirectURL,headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("ramp api response is: ",callback)}).error(function(data,status){console.log("ramp api response in error is: ",data)})}}),1==imauticAutomation&&imatEvent("PaymentFailure")}]),angular.module("fourWheelerPolicyPurchase",["LocalStorageModule"]).controller("fourWheelerPolicyPurchaseController",["$scope","localStorageService",function($scope,localStorageService){$scope.policyDocument=localStorageService.get("policyDocDetails"),$scope.businessLineId=localStorageService.get("selectedBusinessLineId"),1==$scope.businessLineId?$scope.lineOfBusiness="Life":2==$scope.businessLineId?$scope.lineOfBusiness="Bike":3==$scope.businessLineId?$scope.lineOfBusiness="Car":5==$scope.businessLineId?$scope.lineOfBusiness="Travel":$scope.lineOfBusiness="Health"}]);