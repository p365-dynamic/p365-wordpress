"use strict";angular.module("buyFourWheeler",["CoreComponentApp","LocalStorageModule","checklist-model","ngMessages"]).controller("buyFourWheelerController",["$scope","$rootScope","$timeout","RestAPI","localStorageService","$location","$window","$http","$filter","$interval","$sce",function($scope,$rootScope,$timeout,RestAPI,localStorageService,$location,$window,$http,$filter,$interval,$sce){$scope.carProposalSectionHTML=wp_path+"buy/car/html/CarProposalSection.html",$scope.saveProposal=!1,$scope.saveNomineeDetails=!1,$scope.savePrevPolicyDetails=!1,$scope.savePersonalDetails=!1,$scope.redirectForPayment=!1,$scope.proposalId=null,$scope.proposerInfo={},$scope.proposerDetails={},$scope.proposerDetails.communicationAddress={},$scope.organizationDetails={},$scope.nominationInfo={},$scope.nominationDetails={},$scope.appointeeInfo={},$scope.appointeeDetails={},$scope.insuranceInfo={},$scope.insuranceDetails={},$scope.vehicleInfo={},$scope.vehicleDetails={},$scope.vehicleDetails.registrationAddress={},$scope.carProposeFormCookieDetails={},$scope.authenticate={},$scope.premiumDetails={},$scope.inspectionDetails={},$scope.iposRequest={},$scope.prevPolDetails={},$scope.iposRequest.docId=$location.search().quoteId,$scope.iposRequest.carrierId=$location.search().carrierId,$scope.iposRequest.productId=$location.search().productId,$scope.screenOneStatus=!0,$scope.screenTwoStatus=!1,$scope.screenThreeStatus=!1,$scope.screenFourStatus=!1,$scope.screenFiveStatus=!1,$scope.proposalStatusForm=!1,$scope.alreadyExpiredPolicyError=!1,$scope.breakInInspectionStatus=!1,$scope.submitProposalClicked=!1,$scope.shortenURL="",$scope.longURL="",$rootScope.customEnvEnabled||($rootScope.customEnvEnabled=customEnvEnabled),$rootScope.baseEnvEnabled||($rootScope.baseEnvEnabled=baseEnvEnabled),$scope.maritalStatusType=maritalStatusListGeneric,$scope.drivingExpYearsList=drivingExperienceYears,$scope.vehicleDrivenOnList=vehicleDrivenPlaces,$scope.ncbList=buyScreenNcbList,$scope.mileageList=buyScreenMileageList,$scope.vehicleLoanTypes=vehicleLoanTypes,$scope.genderType=genderTypeGeneric,$scope.purchasedLoanStatus=purchasedLoanStatusGeneric,$scope.automobileMembershipList=automobileMembershipTypes,$scope.policyTypes=policyTypesGeneric,$scope.pucStatus=!0,$rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($rootScope.mainTabsMenu[0].active=!1,$rootScope.mainTabsMenu[1].active=!0),pospEnabled&&($scope.pospEnabled=pospEnabled),$scope.selectedVehicleDetails=localStorageService.get("selectedCarDetails"),localStorageService.get("professionalQuoteParams")&&localStorageService.get("professionalQuoteParams").commonInfo?$scope.commonInfo=localStorageService.get("professionalQuoteParams").commonInfo:localStorageService.get("quoteUserInfo")&&($scope.commonInfo=localStorageService.get("quoteUserInfo"),$scope.commonInfo.salutation="Female"==$scope.proposerDetails.gender?"Miss":"Mr"),$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.proposerDetails.maritalStatus=$scope.maritalStatusType[0].name,$rootScope.affilateUser?$scope.isThirdPartyResource=!0:$scope.isThirdPartyResource=!1,$scope.resetCommunicationAddress=function(){"undefined"!=String($scope.proposerDetails.communicationAddress.comDisplayArea)&&0!=$scope.proposerDetails.communicationAddress.comDisplayArea.length||($scope.proposerDetails.communicationAddress.comPincode="",$scope.proposerDetails.communicationAddress.comState="",$scope.proposerDetails.communicationAddress.comCity="",$scope.proposerDetails.communicationAddress.comDoorNo="")},$scope.resetRegistrationAddress=function(){"undefined"!=String($scope.vehicleDetails.registrationAddress.regDisplayArea)&&0!=$scope.vehicleDetails.registrationAddress.regDisplayArea.length||($scope.vehicleDetails.registrationAddress.regPincode="",$scope.vehicleDetails.registrationAddress.regState="",$scope.vehicleDetails.registrationAddress.regCity="",$scope.vehicleDetails.registrationAddress.regDoorNo="")},$scope.getPinCodeAreaList=function(searchValue){var docType=$scope.p365Labels.documentType.cityDetails,carrierId=$scope.selectedProduct.carrierId;return $http.get(getSearchServiceLink+docType+"&q="+searchValue+"&id="+carrierId).then(function(response){return JSON.parse(response.data).data})},$scope.calcDefaultRegAreaDetails=function(areaCode){if(null!=areaCode&&"undefined"!=String(areaCode)&&String(areaCode).length>0){var docType=$scope.p365Labels.documentType.cityDetails,carrierId=$scope.selectedProduct.carrierId;$http.get(getSearchServiceLink+docType+"&q="+areaCode+"&id="+carrierId).then(function(response){var areaDetails=JSON.parse(response.data);areaDetails.responseCode==$scope.p365Labels.responseCode.success&&$scope.onSelectVehiclePinOrArea(areaDetails.data[0])})}},$scope.carQuoteRequestFormation=function(){$scope.quote={},$scope.quote.vehicleInfo={},$scope.quote.quoteParam={},console.log("$scope.selectedProductInputParam in bikeQuoteRequestFormation is:",$scope.selectedProductInputParam),$scope.quote.vehicleInfo.IDV=$scope.selectedProductInputParam.vehicleInfo.IDV,$scope.quote.vehicleInfo.PreviousPolicyExpiryDate=$scope.selectedProductInputParam.vehicleInfo.PreviousPolicyExpiryDate,$scope.quote.vehicleInfo.TPPolicyExpiryDate=$scope.selectedProductInputParam.vehicleInfo.TPPolicyExpiryDate,$scope.quote.vehicleInfo.TPPolicyStartDate=$scope.selectedProductInputParam.vehicleInfo.TPPolicyStartDate,$scope.quote.vehicleInfo.RTOCode=$scope.selectedProductInputParam.vehicleInfo.RTOCode,$scope.quote.vehicleInfo.city=$scope.selectedProductInputParam.vehicleInfo.city,$scope.selectedProductInputParam.vehicleInfo.dateOfRegistration&&($scope.quote.vehicleInfo.dateOfRegistration=$scope.selectedProductInputParam.vehicleInfo.dateOfRegistration),$scope.quote.vehicleInfo.idvOption=$scope.selectedProductInputParam.vehicleInfo.idvOption,$scope.quote.vehicleInfo.best_quote_id=$scope.selectedProductInputParam.vehicleInfo.best_quote_id,$scope.quote.vehicleInfo.previousClaim=$scope.selectedProductInputParam.vehicleInfo.previousClaim,$scope.quote.vehicleInfo.registrationNumber=$scope.selectedProductInputParam.vehicleInfo.registrationNumber,$scope.quote.vehicleInfo.registrationPlace=$scope.selectedProductInputParam.vehicleInfo.registrationPlace,$scope.quote.vehicleInfo.state=$scope.selectedProductInputParam.vehicleInfo.state,$scope.quote.vehicleInfo.make=$scope.selectedProductInputParam.vehicleInfo.make,$scope.quote.vehicleInfo.model=$scope.selectedProductInputParam.vehicleInfo.model,$scope.quote.vehicleInfo.variant=$scope.selectedProductInputParam.vehicleInfo.variant.toString(),$scope.quote.vehicleInfo.fuel=$scope.selectedProductInputParam.vehicleInfo.fuel,$scope.quote.vehicleInfo.cubicCapacity=$scope.selectedProductInputParam.vehicleInfo.cubicCapacity,$scope.quote.quoteParam.ncb=$scope.selectedProductInputParam.quoteParam.ncb,$scope.quote.quoteParam.ownedBy=$scope.selectedProductInputParam.quoteParam.ownedBy,console.log("$scope.selectedProductInputParam.quoteParam.ownedBy in step 4 is: ",$scope.selectedProductInputParam.quoteParam.ownedBy),$scope.quote.quoteParam.policyType=$scope.selectedProductInputParam.quoteParam.policyType,$scope.quote.quoteParam.riders=$scope.selectedProductInputParam.quoteParam.riders},$scope.onSelectPinOrArea=function(item){console.log("item in $scope.onSelectPinOrArea is: ",item),$scope.selectedProductInputParamCopy=angular.copy($scope.selectedProductInputParam.vehicleInfo),item.address&&($scope.proposerDetails.communicationAddress.comDisplayArea=item.address),$scope.proposerDetails.communicationAddress.comPincode=item.pincode,$scope.proposerDetails.communicationAddress.comCity=item.city,$scope.proposerDetails.communicationAddress.comState=item.state,$scope.checkForSameAddress(),$scope.loadPlaceholder(),$scope.proposerDetails.communicationAddress.comDisplayArea&&(item.displayArea=$scope.proposerDetails.communicationAddress.comDisplayArea),localStorageService.set("commAddressDetails",item)},$scope.calcQuoteOnRegistrationNumber=function(regNumber){$scope.selectedProductInputParamCopy=angular.copy($scope.selectedProductInputParam),$scope.selectedProductInputParamCopy.vehicleInfo.registrationNumber?$scope.registrationNumberCopy=$scope.selectedProductInputParam.vehicleInfo.registrationNumber.toUpperCase():$scope.registrationNumberCopy="",$scope.newRegistrationNumber=$scope.vehicleDetails.RTOCode.toUpperCase()+regNumber.toUpperCase(),$scope.newRegistrationNumber!=$scope.registrationNumberCopy&&($scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.selectedProductInputParam.vehicleInfo.registrationNumber=$scope.newRegistrationNumber,$scope.selectedProductInputParamCopy.GSTIN&&($scope.selectedProductInputParam.GSTIN=$scope.selectedProductInputParamCopy.GSTIN),$rootScope.P365Confirm($scope.p365Labels.common.p365prompt,$scope.p365Labels.common.regNumberChangeMsg,"No","Yes",function(confirmStatus){if(confirmStatus)$scope.loading=!0,$scope.carQuoteRequestFormation(),RestAPI.invoke($scope.p365Labels.getRequest.getQuote,$scope.quote).then(function(proposeFormResponse){if($scope.carRecalculateQuoteRequest=[],proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1)$scope.responseRecalculateCodeList=[],$scope.quoteCalcResponse=[],"undefined"!=String($scope.quoteCalcResponse)&&$scope.quoteCalcResponse.length>0&&($scope.quoteCalcResponse.length=0),localStorageService.set("QUOTE_ID",proposeFormResponse.QUOTE_ID),$scope.carRecalculateQuoteRequest=proposeFormResponse.data,angular.forEach($scope.carRecalculateQuoteRequest,function(obj,i){var request={},header={};header.messageId=messageIDVar,header.campaignID=campaignIDVar,header.source=sourceOrigin,header.transactionName=getCarQuoteResult,header.deviceId=deviceIdOrigin,request.header=header,request.body=obj,$http({method:"POST",url:getQuoteCalcLink,data:request}).success(function(callback,status){var carQuoteResponse=JSON.parse(callback);if($scope.responseRecalculateCodeList.push(carQuoteResponse.responseCode),carQuoteResponse.responseCode==$scope.p365Labels.responseCode.success1)null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId&&($scope.loading=!1,$scope.selectedProductInputParamCopy=angular.copy($scope.selectedProductInputParam),$scope.premiumDetails.selectedProductDetails=carQuoteResponse.data.quotes[0],$scope.selectedProduct=carQuoteResponse.data.quotes[0],localStorageService.set("carSelectedProduct",$scope.selectedProduct)),carQuoteResponse.data.quotes[0].id=i,Number(carQuoteResponse.data.quotes[0].grossPremium)>0&&$scope.quoteCalcResponse.push(carQuoteResponse.data.quotes[0]);else if($scope.loading=!1,null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId){$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.selectedProductInputParam.vehicleInfo.registrationNumber="",$scope.vehicleInfo.registrationNumber="",$scope.selectedProductInputParam.vehicleInfo.registrationNumber&&delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,localStorageService.set("carQuoteInputParamaters",$scope.selectedProductInputParam);var screenCnfrmError=$scope.selectedProduct.insuranceCompany+""+$scope.p365Labels.errorMessage.regNumberScreenConfirmErrorMsg;$rootScope.P365Alert($scope.p365Labels.common.p365prompt,screenCnfrmError,"Ok")}}).error(function(data,status){delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,$scope.responseRecalculateCodeList.push($scope.p365Labels.responseCode.systemError),$scope.loading=!1})});else{$scope.loading=!1,$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.vehicleInfo.registrationNumber="",$scope.selectedProductInputParam.vehicleInfo.registrationNumber&&delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,localStorageService.set("carQuoteInputParamaters",$scope.selectedProductInputParam);var screenCnfrmError=$scope.selectedProduct.insuranceCompany+""+$scope.p365Labels.errorMessage.regNumberScreenConfirmErrorMsg;$rootScope.P365Alert($scope.p365Labels.common.p365prompt,screenCnfrmError,"Ok")}});else if($scope.selectedProductInputParam.vehicleInfo=$scope.selectedProductInputParamCopy.vehicleInfo,$scope.selectedProductInputParam.vehicleInfo.registrationNumber){var formatVehicleCode=$scope.selectedProductInputParam.vehicleInfo.registrationNumber;$scope.vehicleInfo.registrationNumber=formatVehicleCode.substring(4)}else $scope.vehicleInfo.registrationNumber="",delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber}))},$scope.checkGSTINNumber=function(selGSTIN){$scope.productValidation.regNumberReQuoteCalc&&selGSTIN&&$scope.calcQuoteOnGSTINNumber(selGSTIN)},$scope.calcQuoteOnGSTINNumber=function(selGSTIN){$scope.selectedProductInputParamCopy=angular.copy($scope.selectedProductInputParam),$scope.selectedProductInputParamCopy.GSTIN?$scope.GSTINCopy=$scope.selectedProductInputParamCopy.GSTIN:$scope.GSTINCopy="",$scope.newGSTINNumber=selGSTIN,$scope.newGSTINNumber!=$scope.GSTINCopy&&($scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.selectedProductInputParam.GSTIN=$scope.newGSTINNumber,$scope.selectedProductInputParamCopy.vehicleInfo.registrationNumber&&($scope.selectedProductInputParam.vehicleInfo.registrationNumber=$scope.selectedProductInputParamCopy.vehicleInfo.registrationNumber),$rootScope.P365Confirm($scope.p365Labels.common.p365prompt,$scope.p365Labels.common.GSTINNumberChangeMsg,"No","Yes",function(confirmStatus){confirmStatus?($scope.loading=!0,$scope.carQuoteRequestFormation(),RestAPI.invoke($scope.p365Labels.getRequest.getQuote,$scope.quote).then(function(proposeFormResponse){if($scope.carRecalculateQuoteRequest=[],proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1)$scope.responseRecalculateCodeList=[],$scope.quoteCalcResponse=[],"undefined"!=String($scope.quoteCalcResponse)&&$scope.quoteCalcResponse.length>0&&($scope.quoteCalcResponse.length=0),localStorageService.set("CAR_UNIQUE_QUOTE_ID",proposeFormResponse.QUOTE_ID),localStorageService.set("CAR_UNIQUE_QUOTE_ID_ENCRYPTED",proposeFormResponse.encryptedQuoteId),$scope.carRecalculateQuoteRequest=proposeFormResponse.data,angular.forEach($scope.carRecalculateQuoteRequest,function(obj,i){var request={},header={};header.messageId=messageIDVar,header.campaignID=campaignIDVar,header.source=sourceOrigin,header.transactionName=getCarQuoteResult,header.deviceId=deviceIdOrigin,request.header=header,request.body=obj,$http({method:"POST",url:getQuoteCalcLink,data:request}).success(function(callback,status){var carQuoteResponse=JSON.parse(callback);if($scope.responseRecalculateCodeList.push(carQuoteResponse.responseCode),carQuoteResponse.responseCode==$scope.p365Labels.responseCode.success1)null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId&&($scope.loading=!1,angular.copy($scope.selectedProductInputParam,$scope.selectedProductInputParamCopy),$scope.premiumDetails.selectedProductDetails=carQuoteResponse.data.quotes[0],$scope.selectedProduct=carQuoteResponse.data.quotes[0],localStorageService.set("carSelectedProduct",$scope.selectedProduct)),carQuoteResponse.data.quotes[0].id=i,$scope.quoteCalcResponse.push(carQuoteResponse.data.quotes[0]);else if($scope.loading=!1,null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId){$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.selectedProductInputParam.vehicleInfo.registrationNumber="",$scope.vehicleInfo.registrationNumber="",$scope.proposerDetails.GSTIN="",$scope.selectedProductInputParam.vehicleInfo.registrationNumber&&delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,localStorageService.set("carQuoteInputParamaters",$scope.selectedProductInputParam);var screenCnfrmError=$scope.selectedProduct.insuranceCompany+""+$scope.p365Labels.errorMessage.GSTINNumberScreenConfirmErrorMsg;$rootScope.P365Alert($scope.p365Labels.common.p365prompt,screenCnfrmError,"Ok")}}).error(function(data,status){delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,$scope.proposerDetails.GSTIN="",$scope.responseRecalculateCodeList.push($scope.p365Labels.responseCode.systemError),$scope.loading=!1})});else{$scope.loading=!1,$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.vehicleInfo.registrationNumber="",$scope.proposerDetails.GSTIN="",$scope.selectedProductInputParam.vehicleInfo.registrationNumber&&delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,localStorageService.set("carQuoteInputParamaters",$scope.selectedProductInputParam);var screenCnfrmError=$scope.selectedProduct.insuranceCompany+""+$scope.p365Labels.errorMessage.GSTINNumberScreenConfirmErrorMsg;$rootScope.P365Alert($scope.p365Labels.common.p365prompt,screenCnfrmError,"Ok")}})):($scope.selectedProductInputParam=$scope.selectedProductInputParamCopy,$scope.selectedProductInputParam.GSTIN?$scope.proposerDetails.GSTIN=$scope.selectedProductInputParam.GSTIN:$scope.proposerDetails.GSTIN="")}))},$scope.checkForSameAddress=function(){$scope.vehicleDetails.isVehicleAddressSameAsCommun&&($scope.vehicleDetails.registrationAddress.regPincode=$scope.proposerDetails.communicationAddress.comPincode,$scope.vehicleDetails.registrationAddress.regDoorNo=$scope.proposerDetails.communicationAddress.comDoorNo,$scope.vehicleDetails.registrationAddress.regDisplayArea=$scope.proposerDetails.communicationAddress.comDisplayArea,$scope.vehicleDetails.registrationAddress.regCity=$scope.proposerDetails.communicationAddress.comCity,$scope.vehicleDetails.registrationAddress.regState=$scope.proposerDetails.communicationAddress.comState)},$scope.onSelectVehiclePinOrArea=function(item){$scope.selectedProductInputParamCopy=angular.copy($scope.selectedProductInputParam.vehicleInfo),$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters");var selState=$scope.selectedProductInputParam.vehicleInfo.state;console.log("selState onSelectVehiclePinOrArea is: ",selState),selState&&($scope.vehicleDetails.registrationAddress.regState=selState.toUpperCase()),$scope.vehicleDetails.registrationAddress.regState!=item.state?($scope.selectedProductInputParam.vehicleInfo.state=item.state,$scope.selectedProductInputParam.vehicleInfo.city=item.city,$scope.selectedProductInputParam.quoteParam.customerCity=item.city,$scope.selectedProductInputParam.quoteParam.customerState=item.state,$scope.selectedProductInputParam.quoteParam.customerpinCode=item.pincode,$scope.proposerDetailsCopied=angular.copy(item),$rootScope.P365Confirm($scope.p365Labels.common.p365prompt,$scope.p365Labels.common.locationChangeMsg,"No","Yes",function(confirmStatus){confirmStatus?($scope.loading=!0,$scope.carQuoteRequestFormation(),RestAPI.invoke($scope.p365Labels.getRequest.getQuote,$scope.quote).then(function(proposeFormResponse){if($scope.carRecalculateQuoteRequest=[],proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1)$scope.responseRecalculateCodeList=[],$scope.quoteCalcResponse=[],"undefined"!=String($scope.quoteCalcResponse)&&$scope.quoteCalcResponse.length>0&&($scope.quoteCalcResponse.length=0),localStorageService.set("CAR_UNIQUE_QUOTE_ID",proposeFormResponse.QUOTE_ID),localStorageService.set("CAR_UNIQUE_QUOTE_ID_ENCRYPTED",proposeFormResponse.encryptedQuoteId),$scope.carRecalculateQuoteRequest=proposeFormResponse.data,angular.forEach($scope.carRecalculateQuoteRequest,function(obj,i){var request={},header={};header.messageId=messageIDVar,header.campaignID=campaignIDVar,header.source=sourceOrigin,header.transactionName=getCarQuoteResult,header.deviceId=deviceIdOrigin,request.header=header,request.body=obj,$http({method:"POST",url:getQuoteCalcLink,data:request}).success(function(callback,status){var carQuoteResponse=JSON.parse(callback);if($scope.responseRecalculateCodeList.push(carQuoteResponse.responseCode),carQuoteResponse.responseCode==$scope.p365Labels.responseCode.success1)null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId&&($scope.loading=!1,$scope.premiumDetails.selectedProductDetails=carQuoteResponse.data.quotes[0],$scope.selectedProduct=carQuoteResponse.data.quotes[0],localStorageService.set("carSelectedProduct",$scope.selectedProduct)),carQuoteResponse.data.quotes[0].id=i,$scope.quoteCalcResponse.push(carQuoteResponse.data.quotes[0]);else if($scope.loading=!1,null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId){$scope.vehicleDetails.pincode="",$scope.vehicleDetails.city="",$scope.vehicleDetails.state="",$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.selectedProductInputParam.vehicleInfo.state="",localStorageService.set("carQuoteInputParamaters",$scope.selectedProductInputParam);var screenCnfrmError=$scope.selectedProduct.insuranceCompany+""+$scope.p365Labels.errorMessage.screenConfirmErrorMsg;$rootScope.P365Alert($scope.p365Labels.common.p365prompt,screenCnfrmError,"Ok")}}).error(function(data,status){$scope.responseRecalculateCodeList.push($scope.p365Labels.responseCode.systemError),$scope.loading=!1})});else{$scope.loading=!1,$scope.vehicleDetails.pincode="",$scope.vehicleDetails.city="",$scope.vehicleDetails.state="",$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.selectedProductInputParam.vehicleInfo.state="",localStorageService.set("carQuoteInputParamaters",$scope.selectedProductInputParam);var screenCnfrmError=$scope.selectedProduct.insuranceCompany+""+$scope.p365Labels.errorMessage.screenConfirmErrorMsg;$rootScope.P365Alert($scope.p365Labels.common.p365prompt,screenCnfrmError,"Ok")}}),$scope.vehicleDetails.registrationAddress.regPincode=item.pincode,$scope.vehicleDetails.registrationAddress.regCity=item.city,$scope.vehicleDetails.registrationAddress.regState=item.state,$scope.checkForSameAddress()):($scope.vehicleDetails.registrationAddress=$scope.vehicleDetailsCopied,$scope.vehicleDetails.registrationAddress.regPincode=$scope.selectedProductInputParamCopy.pincode,$scope.vehicleDetails.registrationAddress.regCity=$scope.selectedProductInputParamCopy.city,$scope.vehicleDetails.registrationAddress.regState=$scope.selectedProductInputParamCopy.state,$scope.checkForSameAddress())})):(item.address&&($scope.vehicleDetails.registrationAddress.regDisplayArea=item.address),$scope.vehicleDetails.registrationAddress.regPincode=item.pincode,$scope.vehicleDetails.registrationAddress.regCity=item.city,$scope.vehicleDetails.registrationAddress.regState=item.state,$scope.checkForSameAddress()),$scope.loadPlaceholder(),localStorageService.set("carRegAddress",item)},$scope.getFinancialInstituteList=function(instituteName){var carrierId=$scope.selectedProduct.carrierId;return $http.get(getSearchServiceLink+"CarrierLoanFinancer&q="+instituteName+"&id="+carrierId).then(function(financeInstituteList){return JSON.parse(financeInstituteList.data).data})},$scope.onFinancialInstitute=function(item){$scope.vehicleDetails.financeInstitutionId=item.financerId,$scope.productValidation.isFinanceType&&($scope.vehicleDetails.financeType=item.financerType),$scope.productValidation.isFinanceCode&&($scope.vehicleDetails.financeInstitutionCode=item.financerId),$scope.loadPlaceholder()},$scope.changeMaritalStatus=function(){},$scope.changePrevInsurer=function(){$scope.insuranceDetails.insurerName=$scope.insuranceInfo.insurerName.carrierName,$scope.insuranceDetails.insurerId=$scope.insuranceInfo.insurerName.carrierId},$scope.changeVehicleLoanType=function(){$scope.vehicleDetails.vehicleLoanType=$scope.vehicleInfo.vehicleLoanType.name},$scope.changeGender=function(){"Male"==$scope.proposerDetails.gender?($scope.proposerDetails.salutation="Mr",$scope.commonInfo&&($scope.commonInfo.salutation="Mr")):($scope.proposerDetails.salutation="Mrs",$scope.commonInfo&&($scope.commonInfo.salutation="Miss"))},$scope.changeNomineeRelation=function(){"undefined"!=String($scope.nominationInfo.nominationRelation)&&($scope.nominationDetails.nominationRelation=$scope.nominationInfo.nominationRelation.relationship,$scope.nominationDetails.nominationRelationId=$scope.nominationInfo.nominationRelation.relationshipId)},$scope.changeAppointeeRelation=function(){"undefined"!=String($scope.appointeeInfo.appointeeRelation)&&($scope.appointeeDetails.appointeeRelation=$scope.appointeeInfo.appointeeRelation.relationship,$scope.appointeeDetails.appointeeRelationId=$scope.appointeeInfo.appointeeRelation.relationshipId)},$scope.changeRegAddress=function(){$scope.vehicleDetails.isVehicleAddressSameAsCommun?($scope.vehicleDetails.registrationAddress.regDoorNo=$scope.proposerDetails.communicationAddress.comDoorNo,$scope.vehicleDetails.registrationAddress.regDisplayArea=$scope.proposerDetails.communicationAddress.comDisplayArea,$scope.vehicleDetails.registrationAddress.regPincode=$scope.proposerDetails.communicationAddress.comPincode,$scope.vehicleDetails.registrationAddress.regCity=$scope.proposerDetails.communicationAddress.comCity,$scope.vehicleDetails.registrationAddress.regState=$scope.proposerDetails.communicationAddress.comState):localStorageService.get("carRegAddress")?($scope.vehicleDetails.registrationAddress.regPincode=localStorageService.get("carRegAddress").pincode,$scope.vehicleDetails.registrationAddress.regDisplayArea=localStorageService.get("carRegAddress").displayArea,$scope.vehicleDetails.registrationAddress.regCity=localStorageService.get("carRegAddress").city,$scope.vehicleDetails.registrationAddress.regState=localStorageService.get("carRegAddress").state):($scope.vehicleDetails.registrationAddress={},$scope.vehicleDetails.registrationAddress.regDisplayArea="",$scope.vehicleDetails.registrationAddress.regDoorNo="",$scope.vehicleDetails.registrationAddress.regPincode="",$scope.vehicleDetails.registrationAddress.regCity="",$scope.vehicleDetails.registrationAddress.regState=""),$scope.calcDefaultRegAreaDetails($scope.vehicleDetails.registrationAddress.regPincode)},$scope.changePrevPolType=function(){$scope.insuranceDetails.prevPolicyType==$scope.policyTypes[0].display&&($scope.prevPolStatusError=!1)},$scope.changePurchasedLoan=function(){"No"==$scope.vehicleDetails.purchasedLoan&&($scope.vehicleDetails.financeInstitution=""),$scope.loadPlaceholder()},$scope.validAppointeeRelation=function(relation){if("Y"==relation.isApointeeRelationship)return relation.relationship},$scope.validateNomineeDateOfBirth=function(){if($scope.nominationDetails.nomPersonAge=getAgeFromDOB($scope.nominationDetails.nomDateOfBirth),$scope.nominationDetails.nomPersonAge<18){$scope.appointeeStatus=!0;var appointeeDOBOption={};appointeeDOBOption.minimumYearLimit="-"+$scope.productValidation.proposerDateOfBirthMaxLimit+"Y",appointeeDOBOption.maximumYearLimit="-18Y",appointeeDOBOption.changeMonth=!0,appointeeDOBOption.changeYear=!0,appointeeDOBOption.dateFormat="dd/mm/yy",$scope.appointeeDOBOptions=setP365DatePickerProperties(appointeeDOBOption)}else $scope.appointeeStatus=!1;$scope.relationList=$scope.genericRelationshipList},$scope.calculateAppointeeAge=function(){$scope.appointeeDetails.appointeePersonAge=getAgeFromDOB($scope.appointeeDetails.appointeeDateOfBirth)},$scope.calculateProposerAge=function(){$scope.proposerDetails.personAge=getAgeFromDOB($scope.proposerDetails.dateOfBirth)},$scope.validateAadhar=function(){$scope.proposerDetails.aadharNumber=$scope.proposerDetails.aadharNumber},$scope.validateGSTN=function(){$scope.proposerDetails.GSTN=$scope.proposerDetails.GSTN},$scope.initCarBuyScreen=function(){var polStartDateOption={minimumYearLimit:"+0D"};polStartDateOption.maximumYearLimit="+"+$scope.productValidation.policyStartDateLimit+"D",polStartDateOption.changeMonth=!0,polStartDateOption.changeYear=!0,polStartDateOption.dateFormat="dd/mm/yy",$scope.polStartDateOptions=setP365DatePickerProperties(polStartDateOption);var proposerDOBOption={};proposerDOBOption.minimumYearLimit="-"+$scope.productValidation.proposerDateOfBirthMaxLimit+"Y",proposerDOBOption.maximumYearLimit="-"+$scope.productValidation.proposerDateOfBirthMinLimit+"Y",proposerDOBOption.changeMonth=!0,proposerDOBOption.changeYear=!0,proposerDOBOption.dateFormat="dd/mm/yy",$scope.proposerDOBOptions=setP365DatePickerProperties(proposerDOBOption);var nomineeDOBOption={};nomineeDOBOption.minimumYearLimit="-"+$scope.productValidation.proposerDateOfBirthMaxLimit+"Y",nomineeDOBOption.maximumYearLimit="-1Y",nomineeDOBOption.changeMonth=!0,nomineeDOBOption.changeYear=!0,nomineeDOBOption.dateFormat="dd/mm/yy",$scope.nomineeDOBOptions=setP365DatePickerProperties(nomineeDOBOption)},$scope.initiateInspectionDatePicker=function(){var inspectionDateOption={minimumDateStringFormat:"0",maximumDateStringFormat:"2W",changeMonth:!0,changeYear:!0,dateFormat:"dd/mm/yy"};$scope.inspectionDateOption=setP365DatePickerProperties(inspectionDateOption),$scope.inspectionTime=[{id:1,name:"09:00AM-11.00AM"},{id:2,name:"11.00AM-02.00PM"},{id:3,name:"02.00PM-04.00PM"},{id:4,name:"04.00PM-06.00PM"}],$scope.inspectionDetails.time=$scope.inspectionTime[0]},$scope.validatePolicyStartDate=function(){"undefined"!==String($scope.policyStartDate)&&(convertStringFormatToDate($scope.policyStartDate,function(formattedPolStartDate){if($scope.selectedProduct.ownDamagePolicyTerm&&($scope.ODPolicyStartDate=$scope.policyStartDate,console.log("$scope.ODPolicyStartDate is in step 1 ::",$scope.ODPolicyStartDate),console.log("$scope.policyStartDate is in step 1 ::",$scope.policyStartDate)),"renew"==$scope.vehicleInfo.insuranceType.value)var polEndDate=new Date(formattedPolStartDate.setFullYear(formattedPolStartDate.getFullYear()+1));else polEndDate=new Date(formattedPolStartDate.setFullYear(formattedPolStartDate.getFullYear()+3));polEndDate=new Date(polEndDate.setDate(polEndDate.getDate()-1)),convertDateFormatToString(polEndDate,function(formattedPolEndDate){$scope.policyEndDate=formattedPolEndDate;var tempPolicyEndDate=$scope.policyEndDate.split("/"),PolicyEndDate=tempPolicyEndDate[1]+"/"+tempPolicyEndDate[0]+"/"+tempPolicyEndDate[2],polStartDateOption={};polStartDateOption.minimumDateLimit=PolicyEndDate,polStartDateOption.maximumYearLimit="+"+$scope.productValidation.vehicleAutoMemberExpDateLimit+"Y",polStartDateOption.changeMonth=!0,polStartDateOption.changeYear=!0,polStartDateOption.dateFormat="dd/mm/yy",$scope.proposerAutoMemberExpDateOptions=setP365DatePickerProperties(polStartDateOption)})}),$scope.selectedProduct.ownDamagePolicyTerm&&convertStringFormatToDate($scope.ODPolicyStartDate,function(formattedODPolStartDate){var ODPolEndDate=new Date(formattedODPolStartDate.setFullYear(formattedODPolStartDate.getFullYear()+$scope.selectedProduct.ownDamagePolicyTerm));ODPolEndDate=new Date(ODPolEndDate.setDate(ODPolEndDate.getDate()-1)),convertDateFormatToString(ODPolEndDate,function(formattedODPolEndDate){$scope.ODPolicyEndDate=formattedODPolEndDate})}))},$scope.prevPolicyStatus=function(){if(console.log("$scope.vehicleInfo is : ",$scope.vehicleInfo),"renew"==$scope.vehicleInfo.insuranceType.value){console.log("inside if..."),$scope.previousPolicyStatus=!0,$scope.vehicleInfo.PreviousPolicyStartDate?$scope.prevPolDetails.prevPolicyStartDate=$scope.vehicleInfo.PreviousPolicyStartDate:$scope.selectedPreviousPolicyStartDate&&($scope.prevPolDetails.prevPolicyStartDate=$scope.selectedPreviousPolicyStartDate),$scope.prevPolDetails.prevPolicyEndDate=$scope.selectedProductInputParam.vehicleInfo.PreviousPolicyExpiryDate;$scope.prevPolDetails.prevPolicyEndDate;convertStringFormatToDate($scope.prevPolDetails.prevPolicyEndDate,function(formattedPrevPolEndDate){var todayDate=new Date;if(1==$scope.vehicleInfo.policyStatus.key||2==$scope.vehicleInfo.policyStatus.key)var policyStartDate=new Date(todayDate.setDate(todayDate.getDate()+3));else policyStartDate=new Date(formattedPrevPolEndDate.setDate(formattedPrevPolEndDate.getDate()+1));if("Y"==$scope.selectedVehicleDetails.previousPolicyExpired){$scope.alreadyExpiredPolicyError=!0;todayDate=new Date;policyStartDate=new Date(todayDate.setDate(todayDate.getDate())),$scope.initiateInspectionDatePicker()}convertDateFormatToString(policyStartDate,function(formattedPolicyStartDate){$scope.policyStartDate=formattedPolicyStartDate,console.log("$scope.policyStartDate is in step 2 ::",$scope.policyStartDate)})})}else{$scope.previousPolicyStatus=!1;var policyStartDate=new Date;convertDateFormatToString(policyStartDate,function(formattedPolicyStartDate){$scope.policyStartDate=formattedPolicyStartDate,console.log("$scope.policyStartDate is in step 3 ::",$scope.policyStartDate),$scope.selectedProduct.ownDamagePolicyTerm&&($scope.ODPolicyStartDate=formattedPolicyStartDate)})}$scope.validatePolicyStartDate()},$scope.validateMemebershipEndDate=function(){"undefined"!==String($scope.vehicleInfo.memebershipEndDate)?convertDateFormatToString($scope.vehicleInfo.memebershipEndDate,function(formattedMemEndDate){var memebershipExpiryDate=formattedMemEndDate.split("/"),tempMemebershipExpiryDate=memebershipExpiryDate[1]+"/"+memebershipExpiryDate[0]+"/"+memebershipExpiryDate[2],policyExpiryDate=$scope.policyEndDate.split("/"),tempPolicyExpiryDate=policyExpiryDate[1]+"/"+policyExpiryDate[0]+"/"+policyExpiryDate[2];new Date(tempMemebershipExpiryDate).setHours(0,0,0,0)<new Date(tempPolicyExpiryDate).setHours(0,0,0,0)?($scope.vehicleDetails.memebershipEndDate=void 0,$scope.vehicleInfo.memebershipEndDate=null):($scope.vehicleDetails.memebershipEndDate=formattedMemEndDate,$scope.loadPlaceholder())}):($scope.vehicleDetails.memebershipEndDate=void 0,$scope.vehicleInfo.memebershipEndDate=null,$scope.memebershipEndDateError=$scope.productValidation.messages.memebershipEndDateErrorOne)},$scope.changeDrivingExp=function(){$scope.proposerDetails.drivingExp=$scope.proposerInfo.drivingExp.display},$scope.changeVehicleDrivenOn=function(){$scope.proposerDetails.vehicleDrivenOn=$scope.proposerInfo.vehicleDrivenOn.name},$scope.changeMonthlyMileage=function(){$scope.vehicleDetails.monthlyMileage=$scope.vehicleInfo.monthlyMileage.value},$scope.accordion="1",$scope.editPesonalInfo=function(){$scope.screenOneStatus=!0,$scope.screenTwoStatus=!1,$scope.screenThreeStatus=!1,$scope.screenFiveStatus=!1,$scope.accordion="1"},$scope.editAddressInfo=function(){$scope.screenOneStatus=!1,$scope.screenTwoStatus=!0,$scope.screenThreeStatus=!1,$scope.accordion="2"},$scope.editNomineeInfo=function(){$scope.screenOneStatus=!1,$scope.screenTwoStatus=!1,$scope.screenThreeStatus=!0,$scope.screenFiveStatus=!1,$scope.accordion="3"},$scope.editPrevPolicyInfo=function(){$scope.screenOneStatus=!1,$scope.screenTwoStatus=!1,$scope.screenThreeStatus=!0,$scope.screenFiveStatus=!1,$scope.accordion="4"},$scope.Section2Inactive=!0,$scope.Section3Inactive=!0,$scope.Section4Inactive=!0,$scope.Section5Inactive=!0,$scope.submitPersonalDetails=function(){$scope.screenOneStatus=!0,$scope.screenTwoStatus=!0,$scope.screenThreeStatus=!1,$scope.screenFourStatus=!1,$scope.screenFiveStatus=!1,$scope.Section2Inactive=!1,$scope.accordion="2",1==imauticAutomation&&imatEvent("ProposalFilled"),$scope.organizationDetails.contactPersonName&&$scope.organizationDetails.contactPersonName.indexOf(" ")>=0&&($scope.proposerDetails.firstName=$scope.organizationDetails.contactPersonName.split(" ")[0],$scope.proposerDetails.lastName=$scope.organizationDetails.contactPersonName.split(" ")[1]),$scope.carProposeFormCookieDetails.proposerDetails=$scope.proposerDetails,$scope.carProposeFormCookieDetails.proposerInfo=$scope.proposerInfo,$rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($scope.saveProposal=!0,$scope.savePersonalDetails=!0,$scope.saveNomineeDetails=!1,$scope.savePrevPolicyDetails=!1,$scope.submitProposalData())},$scope.submitAddressDetails=function(){$scope.screenOneStatus=!0,$scope.screenTwoStatus=!0,$scope.screenThreeStatus=!0,$scope.screenFourStatus=!1,$scope.screenFiveStatus=!1,$scope.Section3Inactive=!1,$scope.accordion="3"},$scope.submitNomineeDetails=function(){$scope.screenOneStatus=!0,$scope.screenTwoStatus=!0,$scope.screenThreeStatus=!0,$scope.previousPolicyStatus?($scope.screenFourStatus=!0,$scope.screenFiveStatus=!1,$scope.Section3Inactive=!1,$scope.accordion="4"):($scope.screenFourStatus=!1,$scope.screenFiveStatus=!0,$scope.proceedPaymentStatus=!0,$scope.Section4Inactive=!1,$scope.accordion="5"),!$scope.personalDetailsFlag&&$scope.nominationDetails.nomFirstName&&$scope.nominationDetails.nomLastName?$scope.carProposeFormCookieDetails.nominationDetails=$scope.nominationDetails:$scope.personalDetailsFlag?$scope.carProposeFormCookieDetails.nominationDetails=$scope.nominationDetails:$scope.carProposeFormCookieDetails.nominationDetails={},$scope.carProposeFormCookieDetails.appointeeDetails=$scope.appointeeDetails,$scope.carProposeFormCookieDetails.nominationInfo=$scope.nominationInfo,$scope.carProposeFormCookieDetails.appointeeInfo=$scope.appointeeInfo,$rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($scope.saveProposal=!0,$scope.saveNomineeDetails=!0,$scope.savePersonalDetails=!0,$scope.savePrevPolicyDetails=!1,$scope.submitProposalData())},$scope.submitPrevPolicyDetails=function(){$scope.screenOneStatus=!0,$scope.screenTwoStatus=!0,$scope.screenThreeStatus=!0,$scope.screenFourStatus=!0,$scope.screenFiveStatus=!0,$scope.proceedPaymentStatus=!0,$scope.Section5Inactive=!1,$scope.accordion="5",$rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($scope.saveProposal=!0,$scope.savePrevPolicyDetails=!0,$scope.savePersonalDetails=!0,$scope.saveNomineeDetails=!0,$scope.submitProposalData())},$scope.backToResultScreen=function(){console.log("redirecting to result screen from proposal"),$rootScope.vehicleDetails.registrationNumber&&($scope.selectedVehicleDetails=localStorageService.get("selectedCarDetails"),$scope.selectedVehicleDetails.registrationNumber=$scope.vehicleDetails.registrationNumber,localStorageService.set("selectedCarDetails",$scope.selectedVehicleDetails)),$rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($rootScope.mainTabsMenu[0].active=!0,$rootScope.mainTabsMenu[1].active=!1),$location.path("/carResult")},$scope.showAuthenticateForm=function(){$scope.disableOTP=!1;var validateAuthParam={paramMap:{}};validateAuthParam.mobileNumber=$scope.proposerDetails.mobileNumber,validateAuthParam.funcType=$scope.p365Labels.functionType.optAuth,validateAuthParam.paramMap.OTP=$scope.p365Labels.functionType.otpGenerate,getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.sendSMS,validateAuthParam,function(createOTP){createOTP.responseCode==$scope.p365Labels.responseCode.success?($scope.createOTPError="",$scope.modalOTP=!0):createOTP.responseCode==$scope.p365Labels.responseCode.blockedMobile?($scope.createOTPError=createOTP.message,$scope.modalOTPError=!0):($scope.createOTPError=$scope.p365Labels.errorMessage.createOTP,$scope.modalOTPError=!0)})},$scope.hideModal=function(){$scope.modalOTP=!1,$scope.proceedPaymentStatus=!0,$scope.authenticate.enteredOTP=""},$scope.hideModalError=function(){$scope.modalOTPError=!1},$scope.resendOTP=function(){var validateAuthParam={paramMap:{}};validateAuthParam.mobileNumber=$scope.proposerDetails.mobileNumber,validateAuthParam.funcType=$scope.p365Labels.functionType.optAuth,validateAuthParam.paramMap.OTP=$scope.p365Labels.functionType.otpGenerate,getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.sendSMS,validateAuthParam,function(createOTP){createOTP.responseCode==$scope.p365Labels.responseCode.success?$scope.invalidOTPError="":createOTP.responseCode==$scope.p365Labels.responseCode.userNotExist?$scope.invalidOTPError=createOTP.message:createOTP.responseCode==$scope.p365Labels.responseCode.blockedMobile?($scope.invalidOTPError=createOTP.message,$scope.disableOTP=!0):createOTP.responseCode==$scope.p365Labels.responseCode.mobileInvalidCode?$scope.invalidOTPError=createOTP.message:$scope.invalidOTPError=$scope.p365Labels.errorMessage.createOTP})},$scope.createCarVehicleDetailsRequest=function(){var vehicleDetailRequest={registrationAddress:{}};vehicleDetailRequest.registrationAddress.regDoorNo=$scope.vehicleDetails.registrationAddress.regDoorNo,vehicleDetailRequest.purchasedLoan=$scope.vehicleDetails.purchasedLoan,vehicleDetailRequest.engineNumber=$scope.vehicleDetails.engineNumber,vehicleDetailRequest.isVehicleAddressSameAsCommun=$scope.vehicleDetails.isVehicleAddressSameAsCommun,vehicleDetailRequest.chassisNumber=$scope.vehicleDetails.chassisNumber,vehicleDetailRequest.registrationNumber=$scope.vehicleDetails.RTOCode.toUpperCase()+$scope.vehicleInfo.registrationNumber.toUpperCase(),$scope.vehicleDetails.vehicleLoanType&&(vehicleDetailRequest.vehicleLoanType=$scope.vehicleDetails.vehicleLoanType),$scope.vehicleDetails.financeInstitution&&(vehicleDetailRequest.financeInstitution=$scope.vehicleDetails.financeInstitution),$scope.vehicleDetails.financeInstitutionCode&&(vehicleDetailRequest.financeInstitutionCode=$scope.vehicleDetails.financeInstitutionCode),$scope.vehicleDetails.monthlyMileage&&(vehicleDetailRequest.monthlyMileage=$scope.vehicleDetails.monthlyMileage),vehicleDetailRequest.registrationAddress.regCity=$scope.vehicleDetails.registrationAddress.regCity,vehicleDetailRequest.registrationAddress.regDisplayArea=$scope.vehicleDetails.registrationAddress.regDisplayArea,vehicleDetailRequest.registrationAddress.regPincode=$scope.vehicleDetails.registrationAddress.regPincode,vehicleDetailRequest.registrationAddress.regState=$scope.vehicleDetails.registrationAddress.regState,vehicleDetailRequest.registrationAddress.regArea=$scope.vehicleDetails.registrationAddress.regArea,vehicleDetailRequest.registrationAddress.regDistrict=$scope.vehicleDetails.registrationAddress.regDistrict,vehicleDetailRequest.registrationAddress.regDisplayField=$scope.vehicleDetails.registrationAddress.regDisplayField,$scope.carProposeFormDetails.vehicleDetails=vehicleDetailRequest},$scope.proposalInfo=function(){var vehicleDetailsCookie={};if($rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($scope.carProposeFormDetails={},$scope.proposerDetails.panNumber="undefined"!=String($scope.proposerDetails.panNumber)?$scope.proposerDetails.panNumber.toUpperCase():"",$scope.savePersonalDetails&&($scope.carProposeFormDetails.proposerDetails=$scope.proposerDetails,$scope.carProposeFormDetails.organizationDetails={},$scope.personalDetailsFlag||($scope.carProposeFormDetails.organizationDetails.contactPersonName=$scope.organizationDetails.contactPersonName,$scope.carProposeFormDetails.organizationDetails.organizationName=$scope.organizationDetails.organizationName),$scope.vehicleInfo.insuranceType.value&&($scope.insuranceDetails.insuranceType=$scope.vehicleInfo.insuranceType.value),"Yes"==$scope.vehicleDetails.purchasedLoan&&($scope.vehicleDetails.vehicleLoanType=$scope.vehicleInfo.vehicleLoanType.name),"undefined"!=String($scope.vehicleInfo.registrationNumber)&&null!=$scope.vehicleInfo.registrationNumber&&(vehicleDetailsCookie.registrationNumber=$scope.vehicleDetails.registrationNumber,vehicleDetailsCookie.RTOCode=$scope.vehicleDetails.RTOCode.toUpperCase(),localStorageService.set("carRegistrationDetails",vehicleDetailsCookie)),$scope.carProposeFormDetails.insuranceDetails=$scope.insuranceDetails,$scope.createCarVehicleDetailsRequest()),$scope.saveNomineeDetails&&($scope.carProposeFormDetails.nominationDetails=$scope.nominationDetails,$scope.appointeeDetails&&($scope.carProposeFormDetails.appointeeDetails=$scope.appointeeDetails),localStorageService.get("proposalId")&&($scope.proposalId=localStorageService.get("proposalId"),$scope.carProposeFormDetails.proposalId=$scope.proposalId)),$scope.savePrevPolicyDetails&&($scope.carProposeFormDetails.insuranceDetails=$scope.insuranceDetails,localStorageService.get("proposalId")&&($scope.proposalId=localStorageService.get("proposalId"),$scope.carProposeFormDetails.proposalId=$scope.proposalId)),$scope.saveProposal||($scope.vehicleInfo.insuranceType.value&&($scope.insuranceDetails.insuranceType=$scope.vehicleInfo.insuranceType.value),$scope.createCarVehicleDetailsRequest(),localStorageService.get("proposalId")&&($scope.proposalId=localStorageService.get("proposalId"),$scope.carProposeFormDetails.proposalId=$scope.proposalId)),$scope.referralCode&&($scope.carProposeFormDetails.referralCode=$scope.referralCode),$scope.carProposeFormDetails.carrierId=$scope.selectedProduct.carrierId,$scope.carProposeFormDetails.productId=$scope.selectedProduct.productId),$rootScope.baseEnvEnabled&&$rootScope.wordPressEnabled){$scope.carProposeFormDetails={},$scope.proposerDetails.panNumber="undefined"!=String($scope.proposerDetails.panNumber)?$scope.proposerDetails.panNumber.toUpperCase():"",$scope.vehicleInfo.insuranceType&&($scope.insuranceDetails.insuranceType=$scope.vehicleInfo.insuranceType.value),"Yes"==$scope.vehicleDetails.purchasedLoan&&($scope.vehicleDetails.vehicleLoanType=$scope.vehicleInfo.vehicleLoanType.name),"undefined"!=String($scope.vehicleInfo.registrationNumber)&&null!=$scope.vehicleInfo.registrationNumber&&(vehicleDetailsCookie.registrationNumber=$scope.vehicleDetails.registrationNumber,vehicleDetailsCookie.RTOCode=$scope.vehicleDetails.RTOCode.toUpperCase(),localStorageService.set("carRegistrationDetails",vehicleDetailsCookie));var selectedInsuranceType=localStorageService.get("selectedInsuranceType");"new"==$scope.selectedProduct.policyType&&"comprehensive"==selectedInsuranceType&&($scope.policyStartDate=$scope.ODPolicyStartDate,$scope.policyEndDate=$scope.ODPolicyEndDate),$scope.carProposeFormDetails.proposerDetails=$scope.proposerDetails,!$scope.personalDetailsFlag&&$scope.nominationDetails.nomFirstName&&$scope.nominationDetails.nomLastName?$scope.carProposeFormDetails.nominationDetails=$scope.nominationDetails:$scope.personalDetailsFlag?$scope.carProposeFormDetails.nominationDetails=$scope.nominationDetails:$scope.carProposeFormDetails.nominationDetails={},$scope.carProposeFormDetails.appointeeDetails=$scope.appointeeDetails,$scope.carProposeFormDetails.insuranceDetails=$scope.insuranceDetails,$scope.carProposeFormDetails.organizationDetails={},$scope.personalDetailsFlag||($scope.carProposeFormDetails.organizationDetails.contactPersonName=$scope.organizationDetails.contactPersonName,$scope.carProposeFormDetails.organizationDetails.organizationName=$scope.organizationDetails.organizationName),$scope.createCarVehicleDetailsRequest(),$scope.referralCode&&($scope.carProposeFormDetails.referralCode=$scope.referralCode),$scope.carProposeFormDetails.carrierId=$scope.selectedProduct.carrierId,$scope.carProposeFormDetails.productId=$scope.selectedProduct.productId}},$scope.redirectToPaymentGateway=function(){$scope.paymentURLParam?$rootScope.affilateUser||$rootScope.agencyPortalEnabled?$window.top.location.href=$scope.paymentServiceResponse.paymentURL+$scope.paymentURLParam:$window.location.href=$scope.paymentServiceResponse.paymentURL+$scope.paymentURLParam:$timeout(function(){$scope.paymentForm.setAction($scope.paymentServiceResponse.paymentURL),$scope.paymentForm.commit(),$scope.$apply()},100)},$scope.proceedForPayment=function(){if($scope.proceedPaymentStatus=!1,$scope.submitProposalClicked=!1,$scope.proposalInfo(),$scope.carProposeFormDetails.QUOTE_ID=localStorageService.get("CAR_UNIQUE_QUOTE_ID"),$scope.carProposeFormDetails.businessLineId=$scope.p365Labels.businessLineType.car,$scope.carProposeFormDetails.personalDetailsFlag=$scope.personalDetailsFlag,$scope.carProposeFormDetails.requestSource=sourceOrigin,$scope.carProposeFormDetails.source=sourceOrigin,$rootScope.agencyPortalEnabled){delete $scope.carProposeFormDetails.proposalId,$scope.carProposeFormDetails.source=sourceOrigin;const localdata=JSON.parse(localStorage.getItem("finalLocalStorage"));localdata&&($scope.carProposeFormDetails.userName=localdata.username,$scope.carProposeFormDetails.agencyId=localdata.agencyId),localStorage.getItem("desiSkillUniqueId")&&(localStorage.getItem("desiSkillUserId")&&($scope.carProposeFormDetails.userName=localStorage.getItem("desiSkillUserId")),$scope.carProposeFormDetails.agencyId=localStorage.getItem("desiSkillAgencyId"))}$scope.carProposeFormDetails.QUOTE_ID?($scope.loading=!0,RestAPI.invoke("carProposal",$scope.carProposeFormDetails).then(function(proposeFormResponse){if($scope.modalOTP=!1,$scope.authenticate.enteredOTP="",$scope.modalOTPError=!1,$rootScope.wordPressEnabled||($scope.proceedPaymentStatus=!0),proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1){$scope.proposalId=proposeFormResponse.data.proposalId,$scope.encryptedProposalId=proposeFormResponse.data.encryptedProposalId,localStorageService.set("proposalIdEncrypted",$scope.encryptedProposalId),1==imauticAutomation&&imatCarProposal(localStorageService,$scope,"MakePayment",function(shortURLResponse){});var proposalId=$scope.proposalId;sharePaymentLink;$scope.responseToken=proposeFormResponse.data,$scope.responseToken.paymentGateway=$scope.paymentURL,$scope.responseToken.businessLineId=$scope.p365Labels.businessLineType.car,localStorageService.set("carReponseToken",$scope.responseToken),getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.paymentService,$scope.responseToken,function(paymentDetails){if(paymentDetails.responseCode==$scope.p365Labels.responseCode.success){$scope.paymentServiceResponse=paymentDetails.data;var paymentURLParamListLength=$scope.paymentServiceResponse.paramterList.length;if("GET"==$scope.paymentServiceResponse.method){$scope.paymentURLParam="?";paymentURLParamListLength=$scope.paymentServiceResponse.paramterList.length;for(var i=0;i<paymentURLParamListLength;i++)$scope.paymentURLParam+=i<paymentURLParamListLength-1?$scope.paymentServiceResponse.paramterList[i].name+"="+$scope.paymentServiceResponse.paramterList[i].value+"&":$scope.paymentServiceResponse.paramterList[i].name+"="+$scope.paymentServiceResponse.paramterList[i].value;$scope.redirectForPayment=!0,$scope.loading=!1,$scope.modalIPOS=!0}else $scope.paymentURLParam=null,$scope.redirectForPayment=!0,$scope.loading=!1,$scope.modalIPOS=!0}else{$scope.loading=!1,$rootScope.wordPressEnabled&&($scope.proceedPaymentStatus=!0);paymentDetails.responseCode,$scope.p365Labels.validationMessages.buyScreenCnfrmError.replace("INSURER_NAME",$scope.selectedProduct.insuranceCompany);proposeFormResponse.message?$rootScope.P365Alert("Policies365",proposeFormResponse.message,"Ok"):$rootScope.P365Alert("Policies365",proposeFormResponse.data,"Ok")}})}else if(proposeFormResponse.responseCode==$scope.p365Labels.responseCode.error||proposeFormResponse.responseCode==$scope.p365Labels.responseCode.error1||proposeFormResponse.responseCode==$scope.p365Labels.responseCode.serverError1)$scope.loading=!1,$rootScope.wordPressEnabled&&($scope.proceedPaymentStatus=!0),proposeFormResponse.responseCode,$scope.p365Labels.responseCode.serverError1,proposeFormResponse.message?$rootScope.P365Alert("Policies365",proposeFormResponse.message,"Ok"):$rootScope.P365Alert("Policies365",proposeFormResponse.data,"Ok");else if(proposeFormResponse.responseCode==$scope.p365Labels.responseCode.prevPolicyExpired)$scope.loading=!1,$scope.modalPrevPolExpiredError=!0,$scope.prevPolicyExpiredError=proposeFormResponse.message;else{1==imauticAutomation&&imatEvent("ProposalFailed"),$scope.loading=!1,$rootScope.wordPressEnabled&&($scope.proceedPaymentStatus=!0);proposeFormResponse.responseCode,$scope.p365Labels.validationMessages.buyScreenCnfrmError.replace("INSURER_NAME",$scope.selectedProduct.insuranceCompany);proposeFormResponse.message?$rootScope.P365Alert("Policies365",proposeFormResponse.message,"Ok"):$rootScope.P365Alert("Policies365",proposeFormResponse.data,"Ok")}})):($scope.proceedPaymentStatus=!0,$rootScope.P365Alert("Policies365",$scope.p365Labels.errorMessage.generalisedErrMsg,"Ok"))},$scope.loadPlaceholder=function(){setTimeout(function(){$(".buyform-control").on("focus blur",function(e){$(this).parents(".buyform-group").toggleClass("focusedInput","focus"===e.type||this.value.length>0)}).trigger("blur")},100)},$scope.fillDataForRenewal=function(){$scope.proposerDetails=localStorageService.get("CarProposalResForRenewal").proposerDetails,$scope.vehicleDetails=localStorageService.get("CarProposalResForRenewal").vehicleDetails,$scope.vehicleInfo.registrationNumber=$scope.vehicleDetails.regNumberPrefix+""+$scope.vehicleDetails.regNumber,$scope.nominationDetails=localStorageService.get("CarProposalResForRenewal").nominationDetails;for(var i=0;i<$scope.genericRelationshipList.length;i++)if($scope.genericRelationshipList[i].relationship==$scope.nominationDetails.nominationRelation){$scope.nominationInfo.nominationRelation=$scope.genericRelationshipList[i];break}$scope.appointeeDetails=localStorageService.get("CarProposalResForRenewal").appointeeDetails;for(i=0;i<$scope.genericRelationshipList.length;i++)if($scope.genericRelationshipList[i].relationship==$scope.appointeeDetails.appointeeRelation){$scope.appointeeInfo.nominationRelation=$scope.genericRelationshipList[i];break}$scope.insuranceDetails=localStorageService.get("CarProposalResForRenewal").insuranceDetails;for(i=0;i<$scope.carrierList.length;i++)if($scope.carrierList[i].carrierId==$scope.insuranceDetails.insurerId){$scope.insuranceInfo.insurerName=$scope.carrierList[i];break}},$scope.prepopulateFields=function(){if($scope.authenticate.enteredOTP="",$scope.vehicleDetails.registrationNumber=angular.copy($rootScope.vehicleDetails.registrationNumber),$scope.vehicleInfo.registrationNumber="",$location.search().isForRenewal&&$scope.fillDataForRenewal(),$scope.selectedVehicleDetails=localStorageService.get("selectedCarDetails"),$rootScope.vehicleDetails.registrationNumber&&0==$rootScope.showCarRegAreaStatus){var formatRegisCode=$rootScope.vehicleDetails.registrationNumber;$scope.vehicleInfo.registrationNumber=formatRegisCode.substring(4)}$scope.vehicleInfo.registrationNumber&&($scope.selectedVehicleDetails.isregNumberDisabled?$rootScope.isregNumber=!0:$rootScope.isregNumber=!1),$scope.selectedProductInputParam.vehicleInfo.regYear&&($scope.vehicleDetails.regYear=$scope.selectedProductInputParam.vehicleInfo.regYear),$scope.selectedVehicleDetails.chassisNumber&&($scope.vehicleDetails.chassisNumber=$scope.selectedVehicleDetails.chassisNumber),$scope.selectedVehicleDetails.engineNumber&&($scope.vehicleDetails.engineNumber=$scope.selectedVehicleDetails.engineNumber),$scope.proposerDetails.GSTIN&&$scope.checkGSTINNumber($scope.proposerDetails.GSTIN),$scope.insuranceDetails.ncb=$scope.selectedProductInputParam.quoteParam.ncb;var regDate=$scope.selectedProductInputParam.vehicleInfo.dateOfRegistration.split("/");if($scope.displayRegistrationDate=regDate[0]+"-"+monthListGeneric[Number(regDate[1])-1]+"-"+regDate[2],$scope.panCardStaus=Number($scope.selectedProduct.grossPremium)>=1e5,$scope.insuranceDetails.prevPolicyType=policyTypesGeneric[0].display,"renew"==$scope.selectedProductInputParam.quoteParam.policyType&&$scope.selectedProductInputParam.quoteParam.onlyODApplicable&&($scope.insuranceDetails.prevPolicyType=policyTypesGeneric[1].display),$scope.vehicleDetails.RTOCode=$scope.selectedProductInputParam.vehicleInfo.RTOCode,$scope.riderStatus=!1,null!=$scope.selectedProduct.ridersList&&"undefined"!=String($scope.selectedProduct.ridersList))for(var i=0;i<$scope.selectedProduct.ridersList.length;i++)null!=$scope.selectedProduct.ridersList[i].riderValue&&($scope.riderStatus=!0,delete $scope.selectedProduct.ridersList[i].$$hashKey);"expired"==$scope.vehicleInfo.policyStatus.policyType&&"> 90 days"==$scope.vehicleInfo.policyStatus.displayText2?$scope.showPaymentButton=!1:$scope.showPaymentButton=!0,$scope.proposerAgeValue=function(personAge){$scope.proposerDetails.personAge=personAge,$scope.proposerDetails.personAgeCaption=personAge<=35?"Up to 35":personAge>35&&personAge<=45?"35 to 45":"More than 45"},$scope.proposerAgeValue($scope.selectedProductInputParam.quoteParam.personAge),$scope.calcDefaultAreaDetails=function(areaCode){if(null!=areaCode&&"undefined"!=String(areaCode)&&String(areaCode).length>0){var docType=$scope.p365Labels.documentType.cityDetails,carrierId=$scope.selectedProduct.carrierId;$http.get(getSearchServiceLink+docType+"&q="+areaCode+"&id="+carrierId).then(function(response){var areaDetails=JSON.parse(response.data);areaDetails.responseCode==$scope.p365Labels.responseCode.success&&$scope.onSelectPinOrArea(areaDetails.data[0])})}},localStorageService.get("commAddressDetails")?($scope.proposerDetails.communicationAddress.comPincode=localStorageService.get("commAddressDetails").pincode,$scope.proposerDetails.communicationAddress.comDisplayArea=localStorageService.get("commAddressDetails").displayArea,$scope.proposerDetails.communicationAddress.comCity=localStorageService.get("commAddressDetails").city,$scope.proposerDetails.communicationAddress.comState=localStorageService.get("commAddressDetails").state):($scope.proposerDetails.communicationAddress.comPincode="",$scope.proposerDetails.communicationAddress.comDoorNo="",$scope.proposerDetails.communicationAddress.comDisplayArea="",$scope.proposerDetails.communicationAddress.comCity="",$scope.proposerDetails.communicationAddress.comState=""),localStorageService.get("carRegAddress")?($scope.vehicleDetails.registrationAddress.regPincode=localStorageService.get("carRegAddress").pincode,$scope.vehicleDetails.registrationAddress.regDisplayArea=localStorageService.get("carRegAddress").displayArea,$scope.vehicleDetails.registrationAddress.regCity=localStorageService.get("carRegAddress").city,$scope.vehicleDetails.registrationAddress.regState=localStorageService.get("carRegAddress").state):($scope.vehicleDetails.registrationAddress.regPincode="",$scope.vehicleDetails.registrationAddress.regDoorNo="",$scope.vehicleDetails.registrationAddress.regDisplayArea="",$scope.vehicleDetails.registrationAddress.regCity="",$scope.vehicleDetails.registrationAddress.regState=""),$scope.calcDefaultRegAreaDetails($scope.vehicleDetails.registrationAddress.regPincode)},$scope.getRelationshipList=function(){getDocUsingId(RestAPI,"relationshipdetailslist",function(relationList){$scope.genericRelationshipList=relationList.relationships,localStorageService.get("selectedCarDetails")&&($scope.vehicleInfo=localStorageService.get("selectedCarDetails")),$scope.proposerDetails.gender="Male",$scope.proposerDetails.salutation="Mr",$scope.quoteUserInfo&&($scope.proposerDetails.firstName="undefined"!==String($scope.quoteUserInfo.firstName)?$scope.quoteUserInfo.firstName:$scope.proposerDetails.firstName,$scope.proposerDetails.lastName="undefined"!==String($scope.quoteUserInfo.lastName)?$scope.quoteUserInfo.lastName:$scope.proposerDetails.lastName,$scope.proposerDetails.emailId="undefined"!==String($scope.quoteUserInfo.emailId)?$scope.quoteUserInfo.emailId:$scope.proposerDetails.emailId,$scope.proposerDetails.mobileNumber="undefined"!==String($scope.quoteUserInfo.mobileNumber)?$scope.quoteUserInfo.mobileNumber:$scope.proposerDetails.mobileNumber,console.log("$scope.selectedProductInputParam.quoteParam.ownedBy in step 2 is: ",$scope.selectedProductInputParam.quoteParam.ownedBy),"Individual"==$scope.selectedProductInputParam.quoteParam.ownedBy?$scope.personalDetailsFlag=!0:"Organization"==$scope.selectedProductInputParam.quoteParam.ownedBy?($scope.personalDetailsFlag=!1,$scope.organizationDetails.salutation="M/S",$scope.organizationDetails.organizationName||($scope.organizationDetails.organizationName=""),$scope.proposerDetails.firstName?$scope.organizationDetails.contactPersonName=$scope.proposerDetails.firstName:$scope.proposerDetails.firstName&&$scope.proposerDetails.lastName?$scope.organizationDetails.contactPersonName=$scope.proposerDetails.firstName+" "+$scope.proposerDetails.lastName:$scope.organizationDetails.contactPersonName="",$scope.organizationDetails.emailId=$scope.proposerDetails.emailId,$scope.organizationDetails.mobileNumber=$scope.proposerDetails.mobileNumber):$scope.personalDetailsFlag=!0),$scope.proposerDetails.dateOfBirth=$scope.selectedProductInputParam.vehicleInfo.dateOfBirth;var nominationDateOfBirth=new Date((new Date).setYear(Number((new Date).getFullYear())-35));convertDateFormatToString(nominationDateOfBirth,function(formattedDOB){$scope.nominationDetails.nomDateOfBirth=formattedDOB,$scope.validateNomineeDateOfBirth()}),$scope.vehicleDetails.isVehicleAddressSameAsCommun=!1,$scope.vehicleDetails.purchasedLoan="No",$scope.prepopulateFields(),$scope.prevPolicyStatus(),$scope.changeRegAddress(),$scope.loadPlaceholder()})},$scope.validateRegistrationNumber=function(registrationNumber){"undefined"!=String(registrationNumber)&&((registrationNumber=registrationNumber.replace(/[^a-zA-Z0-9]/gi,"")).trim().match(/^[a-zA-Z]{0,3}[0-9]{1,4}$/)&&registrationNumber.trim().length<=7&&registrationNumber.trim().length>=2?($scope.regNumStatus=!1,$scope.vehicleDetailsForm.RegistrationNumber.$setValidity("RegistrationNumber",!0),$scope.productValidation.regNumberReQuoteCalc&&$scope.calcQuoteOnRegistrationNumber(registrationNumber)):($scope.regNumStatus=!0,$scope.vehicleDetailsForm.RegistrationNumber.$setValidity("RegistrationNumber",!1)),$scope.vehicleInfo.registrationNumber=registrationNumber.trim())},$scope.onSelectPinInVehicleInspctionModal=function(item){$scope.inspectionDetails.state=item.state,$scope.inspectionDetails.pincode=item.pincode,$scope.inspectionDetails.city=item.city},$scope.closePrevPolExpiredError=function(){$scope.prevPolExpiredError=!1},$scope.closeInspectionModal=function(){$scope.modalVehicleInspection=!1},$scope.submitVehicleInsectionDetails=function(){$scope.prevPolExpiredError=!1,$scope.proceedPaymentStatus=!1,$scope.proposalInfo(),$scope.carProposeFormDetails.QUOTE_ID=localStorageService.get("CAR_UNIQUE_QUOTE_ID"),$scope.carProposeFormDetails.businessLineId=$scope.p365Labels.businessLineType.car,$rootScope.wordPressEnabled,$scope.carProposeFormDetails.source=sourceOrigin,$scope.carProposeFormDetails.inspectionDetails=$scope.inspectionDetails,$scope.loading=!0,RestAPI.invoke("carProposal",$scope.carProposeFormDetails).then(function(proposeFormResponse){proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1?($scope.loading=!1,proposeFormResponse.data.inspectionReferenceNo&&($scope.inspectionReferenceNo=proposeFormResponse.data.inspectionReferenceNo),$scope.longURL=""+sharePaymentLink+proposeFormResponse.data.proposalId+"&lob=3",$scope.modalVehicleInspection=!0):proposeFormResponse.responseCode==$scope.p365Labels.responseCode.error||$rootScope.agencyPortalEnabled&&proposeFormResponse.responseCode==$scope.p365Labels.responseCode.error1||$rootScope.agencyPortalEnabled&&proposeFormResponse.responseCode==$scope.p365Labels.responseCode.serverError1?($scope.loading=!1,$scope.responseToken=proposeFormResponse.data,$scope.responseToken.proposalId&&localStorageService.set("proposalIdEncrypted",$scope.responseToken.encryptedProposalId),$scope.responseToken.proposalId&&1==imauticAutomation&&(console.log("calling mautic proposal function for sharing payment link"),imatCarProposal(localStorageService,$scope,"SubmitProposal",function(shortURLResponse){shortURLResponse.responseCode==$scope.p365Labels.responseCode.success?($scope.shortURLResponse=shortURLResponse,console.log("$scope.shortURLResponse in imatCarProposal  1 is: ",$scope.shortURLResponse),$scope.shortURLResponse.data.shortURL?$scope.shortenURL=$scope.shortURLResponse.data.shortURL:$scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",$scope.sendProposalEmail()):($scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",$scope.sendProposalEmail(),$scope.loading=!1),console.log("$scope.shortURLResponse in bike expired case is:",$scope.shortURLResponse)})),$rootScope.P365Alert("Error",proposeFormResponse.message,"Ok"),$scope.proceedPaymentStatus=!0):($scope.loading=!1,proposeFormResponse.message?$rootScope.P365Alert("Error",proposeFormResponse.message,"Ok"):$rootScope.P365Alert("Error",proposeFormResponse.data,"Ok"),$scope.proceedPaymentStatus=!0)})},$scope.scheduleVehicleInspection=function(){$scope.inspectionDetails.mobNumber=$scope.proposerDetails.mobileNumber,$scope.inspectionDetails.address=$scope.proposerDetails.communicationAddress.comDisplayArea,$scope.inspectionDetails.state=$scope.proposerDetails.communicationAddress.comState,$scope.inspectionDetails.pincode=$scope.proposerDetails.communicationAddress.comPincode,$scope.inspectionDetails.city=$scope.proposerDetails.communicationAddress.comCity,$scope.prevPolExpiredError=!0},$rootScope.signout=function(){$rootScope.userLoginStatus=!1;var userLoginInfo={username:""};userLoginInfo.status=$rootScope.userLoginStatus,localStorageService.set("userLoginInfo",userLoginInfo),$location.path("/quote")},$scope.missionCompled=function(){$scope.loading=!1},$scope.getCarrierList=function(){getListFromDB(RestAPI,"",$scope.p365Labels.documentType.carCarrier,$scope.p365Labels.request.findAppConfig,function(carCarrierList){carCarrierList.responseCode==$scope.p365Labels.responseCode.success?($scope.carrierList=carCarrierList.data,console.log("$scope.carrierList is : ",JSON.stringify($scope.carrierList)),$scope.getRelationshipList(),$rootScope.loading=!1):($scope.carrierList=carProposalLabels.carCarrierList,console.log("$scope.carrierList from application label",$scope.carrierList),$scope.getRelationshipList(),$rootScope.loading=!1)})},$scope.sendProposalEmail=function(){var proposalDetailsEmail={paramMap:{}};proposalDetailsEmail.funcType=$scope.p365Labels.functionType.proposalDetailsTemplate,proposalDetailsEmail.username=$scope.proposerDetails.emailId.trim(),proposalDetailsEmail.isBCCRequired="Y",proposalDetailsEmail.paramMap.customerName=$scope.proposerDetails.firstName.trim()+" "+$scope.proposerDetails.lastName.trim(),proposalDetailsEmail.paramMap.selectedPolicyType=$scope.p365Labels.insuranceType.car,$scope.iposRequest.docId?proposalDetailsEmail.paramMap.quoteId=$scope.iposRequest.docId:proposalDetailsEmail.paramMap.quoteId=localStorageService.get("CAR_UNIQUE_QUOTE_ID"),proposalDetailsEmail.paramMap.premiumAmount=String($scope.selectedProduct.grossPremium),proposalDetailsEmail.paramMap.docId=String($scope.responseToken.proposalId),proposalDetailsEmail.paramMap.LOB="2",console.log("$rootScope.encryptedProposalID in bike is:",$rootScope.encryptedProposalID),$scope.shortenURL?proposalDetailsEmail.paramMap.url=$scope.shortURLResponse.data.shortURL:($scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",proposalDetailsEmail.paramMap.url=$scope.longURL),console.log("**$scope.longURL **: ",$scope.longURL),RestAPI.invoke($scope.p365Labels.transactionName.sendEmail,proposalDetailsEmail).then(function(emailResponse){if(emailResponse.responseCode==$scope.p365Labels.responseCode.success)if($scope.sendSMS(),1==baseEnvEnabled&&1==agencyPortalEnabled){var frameURL=agencyPortalUrl+proposalDetailsEmail.paramMap.docId+"&lob="+proposalDetailsEmail.paramMap.LOB;$scope.URLforPayment=$sce.trustAsResourceUrl(frameURL),$scope.alreadyExpiredPolicyError||($scope.modalAP=!0),$scope.loading=!1}else $scope.redirectForPayment=!1,$scope.loading=!1,$scope.alreadyExpiredPolicyError||($scope.modalIPOS=!0);else $scope.sendSMS(),$rootScope.P365Alert("Policies365",$scope.p365Labels.errorMessage.emailSentFailed,"Ok"),$scope.loading=!1})},$scope.submitProposalData=function(){if($scope.submitProposalClicked=!0,$scope.proposalInfo(),$scope.carProposeFormDetails.QUOTE_ID=$scope.iposRequest.docId,$scope.carProposeFormDetails.businessLineId=$scope.p365Labels.businessLineType.car,$scope.carProposeFormDetails.personalDetailsFlag=$scope.personalDetailsFlag,$rootScope.wordPressEnabled?$scope.carProposeFormDetails.source=sourceOrigin:($scope.carProposeFormDetails.requestSource=sourceOrigin,$scope.carProposeFormDetails.source=sourceOrigin),$scope.loading=!0,$scope.saveProposal)RestAPI.invoke($scope.transactionSaveProposal,$scope.carProposeFormDetails).then(function(proposeFormResponse){proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success?($scope.proposalId=proposeFormResponse.data,localStorageService.set("proposalId",$scope.proposalId),$scope.loading=!1,$scope.saveProposal=!1):($scope.loading=!1,$scope.saveProposal=!1)});else{if(delete $scope.carProposeFormDetails.proposalId,$rootScope.agencyPortalEnabled){const localdata=JSON.parse(localStorage.getItem("finalLocalStorage"));$scope.carProposeFormDetails.requestSource=sourceOrigin,$scope.carProposeFormDetails.source=sourceOrigin,localdata&&($scope.carProposeFormDetails.userName=localdata.username,$scope.carProposeFormDetails.agencyId=localdata.agencyId),localStorage.getItem("desiSkillUniqueId")&&(localStorage.getItem("desiSkillUserId")&&($scope.carProposeFormDetails.userName=localStorage.getItem("desiSkillUserId")),$scope.carProposeFormDetails.agencyId=localStorage.getItem("desiSkillAgencyId"))}$scope.carProposeFormDetails.QUOTE_ID?RestAPI.invoke("carProposal",$scope.carProposeFormDetails).then(function(proposeFormResponse){if(proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1)if($scope.proposalId=proposeFormResponse.data.proposalId,$scope.encryptedProposalId=proposeFormResponse.data.encryptedProposalId,localStorageService.set("proposalIdEncrypted",$scope.encryptedProposalId),$scope.responseToken=proposeFormResponse.data,$scope.responseToken.paymentGateway=$scope.paymentURL,$scope.responseToken.businessLineId=$scope.p365Labels.businessLineType.car,localStorageService.set("carReponseToken",$scope.responseToken),$rootScope.encryptedLOB=$scope.p365Labels.businessLineType.car,$rootScope.encryptedProposalID=$scope.encryptedProposalId,1==imauticAutomation)imatCarProposal(localStorageService,$scope,"SubmitProposal",function(shortURLResponse){shortURLResponse.responseCode==$scope.p365Labels.responseCode.success?($scope.shortURLResponse=shortURLResponse,console.log("$scope.shortURLResponse in imatCarProposal is: ",$scope.shortURLResponse),$scope.shortURLResponse.data.shortURL?($scope.shortenURL=$scope.shortURLResponse.data.shortURL,$scope.sendProposalEmail()):($scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",$scope.sendProposalEmail())):($scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",console.log("long url is: ",$scope.longURL),$scope.sendProposalEmail())});else{var body={};body.longURL=sharePaymentLink+String($scope.responseToken.proposalId)+"&lob="+String($scope.p365Labels.businessLineType.car),$scope.longURL=body.longURL,$http({method:"POST",url:getShortURLLink,data:body}).success(function(shortURLResponse){shortURLResponse.responseCode==$scope.p365Labels.responseCode.success?($scope.shortURLResponse=shortURLResponse,$scope.shortenURL=$scope.shortURLResponse.data.shortURL,$scope.sendProposalEmail()):($scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",$scope.sendProposalEmail(),$scope.loading=!1)})}else if(proposeFormResponse.responseCode==$scope.p365Labels.responseCode.error||proposeFormResponse.responseCode==$scope.p365Labels.responseCode.error1||proposeFormResponse.responseCode==$scope.p365Labels.responseCode.serverError1)$scope.loading=!1,$rootScope.wordPressEnabled&&($scope.proceedPaymentStatus=!0),proposeFormResponse.responseCode,$scope.p365Labels.responseCode.serverError1,proposeFormResponse.message?$rootScope.P365Alert("Policies365",proposeFormResponse.message,"Ok"):$rootScope.P365Alert("Policies365",proposeFormResponse.data,"Ok");else if(proposeFormResponse.responseCode==$scope.p365Labels.responseCode.prevPolicyExpired)$scope.loading=!1,$scope.modalPrevPolExpiredError=!0,$scope.prevPolicyExpiredError=proposeFormResponse.message;else{1==imauticAutomation&&imatEvent("ProposalFailed"),$scope.loading=!1,$rootScope.wordPressEnabled&&($scope.proceedPaymentStatus=!0);proposeFormResponse.responseCode,$scope.p365Labels.validationMessages.buyScreenCnfrmError.replace("INSURER_NAME",$scope.selectedProduct.insuranceCompany);proposeFormResponse.message?$rootScope.P365Alert("Policies365",proposeFormResponse.message,"Ok"):$rootScope.P365Alert("Policies365",proposeFormResponse.data,"Ok")}}):($scope.loading=!1,$rootScope.P365Alert("Policies365",$scope.p365Labels.errorMessage.generalisedErrMsg,"Ok"))}},$scope.sendSMS=function(){var validateAuthParam={paramMap:{}};validateAuthParam.mobileNumber=$scope.proposerDetails.mobileNumber,validateAuthParam.paramMap.firstName=$scope.proposerDetails.firstName,validateAuthParam.funcType="ProposalFilled",validateAuthParam.paramMap.OTP=$scope.p365Labels.functionType.otpGenerate,getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.sendSMS,validateAuthParam,function(createOTP){$scope.submitProposalClicked||(createOTP.responseCode,$scope.p365Labels.responseCode.success,$scope.redirectToPaymentGateway())})},$scope.sendPaymentSuccessEmail=function(){var proposalDetailsEmail={paramMap:{}};proposalDetailsEmail.funcType=$scope.p365Labels.functionType.proposalDetailsTemplate,console.log("$scope.shortenURL in send email is: ",$scope.shortenURL),$scope.shortenURL?proposalDetailsEmail.paramMap.url=$scope.shortURLResponse.data.shortURL:($scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",proposalDetailsEmail.paramMap.url=$scope.longURL),console.log("$scope.longURL  in car is:",$scope.longURL),proposalDetailsEmail.username=$scope.proposerDetails.emailId.trim(),proposalDetailsEmail.paramMap.customerName=$scope.proposerDetails.firstName.trim()+" "+$scope.proposerDetails.lastName.trim(),proposalDetailsEmail.paramMap.selectedPolicyType=$scope.p365Labels.insuranceType.car,RestAPI.invoke($scope.p365Labels.transactionName.sendEmail,proposalDetailsEmail).then(function(emailResponse){emailResponse.responseCode,$scope.p365Labels.responseCode.success,$scope.sendSMS()})},$scope.hideModalIPOS=function(){$scope.modalIPOS=!1,1==$scope.redirectForPayment&&$scope.sendPaymentSuccessEmail()},$scope.hideModalAP=function(){$scope.modalAP=!1},$scope.closeModal=function(){$scope.modalPrevPolExpiredError=!1};var getLeadInfodata={};if(localStorageService.get("renewPolicyDetails")){var renewPolicyDetails=localStorageService.get("renewPolicyDetails");getLeadInfodata.proposalId=renewPolicyDetails.productId}getLeadInfodata.messageId=messageIDVar,RestAPI.invoke("getLeadInfo",getLeadInfodata).then(function(callback){if(1e3==callback.responseCode)if(callback.data&&(callback.data.proposerDetails&&0!==Object.keys(callback.data.proposerDetails).length&&callback.data.proposerDetails.communicationAddress&&($scope.proposerDetails.communicationAddress.comCity=callback.data.proposerDetails.communicationAddress.comCity,$scope.proposerDetails.communicationAddress.comDisplayArea=callback.data.proposerDetails.communicationAddress.comDisplayArea,$scope.proposerDetails.communicationAddress.comPincode=callback.data.proposerDetails.communicationAddress.comPincode,$scope.proposerDetails.communicationAddress.comState=callback.data.proposerDetails.communicationAddress.comState,localStorageService.set("commAddressDetails",$scope.proposerDetails.communicationAddress)),callback.data.vehicleDetails&&0!==Object.keys(callback.data.vehicleDetails).length&&($scope.vehicleDetails.registrationAddress.regDoorNo=callback.data.vehicleDetails.doorNo,$scope.vehicleDetails.purchasedLoan=callback.data.vehicleDetails.purchasedLoan,$scope.vehicleDetails.isVehicleAddressSameAsCommun=callback.data.vehicleDetails.isVehicleAddressSameAsCommun,$scope.vehicleDetails.chassisNumber=callback.data.vehicleDetails.chassisNumber,$scope.vehicleDetails.registrationNumber=callback.data.vehicleDetails.registrationNumber,callback.data.vehicleDetails.registrationAddress&&($scope.vehicleDetails.registrationAddress.regCity=callback.data.vehicleDetails.registrationAddress.regCity,$scope.vehicleDetails.registrationAddress.regDisplayArea=callback.data.vehicleDetails.registrationAddress.regDisplayArea,$scope.vehicleDetails.registrationAddress.regPincode=callback.data.vehicleDetails.registrationAddress.regPincode,$scope.vehicleDetails.registrationAddress.regState=callback.data.vehicleDetails.registrationAddress.regState,$rootScope.vehicleDetails.registrationNumber=callback.data.vehicleDetails.registrationNumber,$rootScope.showCarRegAreaStatus=!1)),callback.data.appointeeDetails&&0!==Object.keys(callback.data.appointeeDetails).length&&($scope.appointeeDetails=callback.data.appointeeDetails),callback.data.nominationDetails&&0!==Object.keys(callback.data.nominationDetails).length&&($scope.nominationDetails.nomDateOfBirth=callback.data.nominationDetails.nomDateOfBirth,$scope.nominationDetails.nomFirstName=callback.data.nominationDetails.nomFirstName,$scope.nominationDetails.nomLastName=callback.data.nominationDetails.nomLastName,$scope.nominationDetails.nominationRelation=callback.data.nominationDetails.nominationRelation,$scope.nominationDetails.nominationRelationId=callback.data.nominationDetails.nominationRelationId,$scope.nominationDetails.nomPersonAge=callback.data.nominationDetails.nomPersonAge),callback.data.insuranceDetails&&0!==Object.keys(callback.data.insuranceDetails).length&&($scope.insuranceDetails.policyNumber=callback.data.insuranceDetails.policyNumber,$scope.insuranceDetails.insuranceType=callback.data.insuranceDetails.insuranceType,$scope.insuranceDetails.ncb=callback.data.insuranceDetails.ncb,$scope.insuranceDetails.insurerId=callback.data.insuranceDetails.insurerId,$scope.insuranceDetails.insurerName=callback.data.insuranceDetails.insurerName,$scope.insuranceDetails.prevPolicyType=callback.data.insuranceDetails.prevPolicyType),callback.data.insuranceInfo&&0!==Object.keys(callback.data.insuranceInfo).length&&($scope.insuranceInfo=callback.data.insuranceInfo)),$scope.iposRequest.docId)$scope.p365Labels=carProposalLabels,$rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($rootScope.iquoteRedirectionURL="/sharefromAPI",$scope.isIquoteEnabled=!1,$rootScope.iquoteRequestParam={lob:$scope.p365Labels.businessLineType.bike,createLeadFlag:$location.search().createLeadFlag,leaddetails:$location.search().leaddetails,orgName:$location.search().orgName},$rootScope.iquoteRequestParam.docId=$scope.iposRequest.docId,$rootScope.iposRedirectionURL="/proposalresdata",$rootScope.iposRequestParam={proposalId:$location.search().proposalId,messageId:$location.search().messageId,leaddetails:$location.search().leaddetails,orgName:$location.search().orgName},$rootScope.isActiveTab="ipos",$rootScope.mainTabsMenu=[{url:$rootScope.iquoteRedirectionURL,requestParam:$rootScope.iquoteRequestParam,className:"iQuoteTab tabs wp_border32",name:"iquote",title:"iQuote",active:$scope.isIquoteEnabled},{url:$rootScope.iposRedirectionURL,requestParam:$rootScope.iposRequestParam,className:"iPosTab tabs wp_border32",name:"ipos",title:"iPos",active:!$scope.isIquoteEnabled}]),$scope.quoteUserInfo=localStorageService.get("quoteUserInfo"),$scope.vehicleData={},$scope.vehicleData.occupationObject={},$scope.vehicleData.deductibleObject={},$scope.vehicleData.addOnCoverCustomAmount={},$rootScope.vehicleDetails={},$scope.carInsuranceTypes=carInsuranceTypeGeneric,RestAPI.invoke("quoteDataReader",$scope.iposRequest).then(function(quoteData){if(quoteData.responseCode==$scope.p365Labels.responseCode.success){$scope.quoteInfo=quoteData.data,$scope.selectedProductInputParam=$scope.quoteInfo.carQuoteRequest,$scope.vehicleInfo=localStorageService.get("selectedCarDetails"),$scope.insuranceDetails.insuranceType=$scope.quoteInfo.carQuoteRequest.quoteParam.policyType,$scope.quoteCalcResponse=$scope.quoteInfo.carQuoteResponse;for(var j=0;j<$scope.quoteCalcResponse.length;j++)$scope.quoteCalcResponse[j].id=j+1;for(var i=0;i<$scope.quoteCalcResponse.length;i++)if($scope.quoteCalcResponse[i].carrierId==$scope.iposRequest.carrierId&&$scope.quoteCalcResponse[i].productId==$scope.iposRequest.productId){$scope.premiumDetails.selectedProductDetails=$scope.quoteCalcResponse[i],$scope.selectedProduct=$scope.premiumDetails.selectedProductDetails;break}for(console.log("$scope.selectedProductInputParam.quoteParam.ownedBy in step 1 from quote response is: ",$scope.selectedProductInputParam.quoteParam.ownedBy),"Individual"==$scope.selectedProductInputParam.quoteParam.ownedBy?$scope.personalDetailsFlag=!0:"Organization"==$scope.selectedProductInputParam.quoteParam.ownedBy?$scope.personalDetailsFlag=!1:$scope.personalDetailsFlag=!0,$scope.changeInsuranceCompany=function(){$location.path("/buyFourWheeler").search({quoteId:localStorageService.get("CAR_UNIQUE_QUOTE_ID"),carrierId:$scope.premiumDetails.selectedProductDetails.carrierId,productId:$scope.premiumDetails.selectedProductDetails.productId,lob:localStorageService.get("selectedBusinessLineId")})},i=0;i<$scope.carInsuranceTypes.length;i++)if($scope.selectedProductInputParam.quoteParam.policyType==$scope.carInsuranceTypes[i].value){$scope.vehicleData.insuranceType=$scope.carInsuranceTypes[i];break}var todayDate=new Date,formatedTodaysDate=("0"+(todayDate.getMonth()+1).toString()).substr(-2)+"/"+("0"+todayDate.getDate().toString()).substr(-2)+"/"+todayDate.getFullYear().toString();getPolicyStatusList(formatedTodaysDate),$scope.policyStatusList=policyStatusListGeneric;var dateArray=$scope.selectedProductInputParam.vehicleInfo.PreviousPolicyExpiryDate.split("/"),previousPolicyExpiredDays=getDays(dateArray[2]+","+dateArray[1]+","+dateArray[0]);for("N"==$scope.selectedVehicleDetails.previousPolicyExpired?$scope.vehicleData.policyStatusKey=3:$scope.vehicleData.policyStatusKey=previousPolicyExpiredDays>90?1:2,i=0;i<$scope.policyStatusList.length;i++)if($scope.vehicleData.policyStatusKey==$scope.policyStatusList[i].key){$scope.vehicleData.policyStatus=$scope.policyStatusList[i];break}if($scope.selectedProductInputParam.quoteParam.riders)for(i=0;i<$scope.selectedProductInputParam.quoteParam.riders.length;i++)21==$scope.selectedProductInputParam.quoteParam.riders[i].riderId&&($scope.vehicleData.addOnCoverCustomAmount.passengerCover=$scope.selectedProductInputParam.quoteParam.riders[i].riderAmount),20==$scope.selectedProductInputParam.quoteParam.riders[i].riderId&&($scope.vehicleData.addOnCoverCustomAmount.driverAccidentCover=$scope.selectedProductInputParam.quoteParam.riders[i].riderAmount),25==$scope.selectedProductInputParam.quoteParam.riders[i].riderId&&($scope.vehicleData.addOnCoverCustomAmount.electricalAccessories=$scope.selectedProductInputParam.quoteParam.riders[i].riderAmount),30==$scope.selectedProductInputParam.quoteParam.riders[i].riderId&&($scope.vehicleData.addOnCoverCustomAmount.nonElectricalAccessories=$scope.selectedProductInputParam.quoteParam.riders[i].riderAmount),35==$scope.selectedProductInputParam.quoteParam.riders[i].riderId&&($scope.vehicleData.addOnCoverCustomAmount.lpgCngKitCover=$scope.selectedProductInputParam.quoteParam.riders[i].riderAmount);$scope.vehicleData.manufacturingYear=Number($scope.selectedProductInputParam.vehicleInfo.regYear),$rootScope.vehicleDetails.registrationNumber=$scope.selectedProductInputParam.vehicleInfo.registrationNumber,$scope.vehicleData.maxVehicleAge=15,$rootScope.voluntaryDeductable=0,$rootScope.antiTheftDeviceAmount=0;var buyScreenParam={documentType:"proposalScreenConfig"};buyScreenParam.carrierId=Number($scope.iposRequest.carrierId);for(i=0;i<$scope.quoteInfo.carQuoteResponse.length;i++)Number($scope.iposRequest.carrierId)==$scope.quoteInfo.carQuoteResponse[i].carrierId&&$scope.quoteCalcResponse[i].productId==$scope.iposRequest.productId?($scope.selectedProduct=$scope.quoteInfo.carQuoteResponse[i],buyScreenParam.productId=$scope.quoteInfo.carQuoteResponse[i].productId,buyScreenParam.businessLineId=$scope.p365Labels.businessLineType.car):$rootScope.loading=!0;for(i=0;i<$scope.selectedProduct.discountList.length;i++)"Voluntary Deductible Discount"==$scope.selectedProduct.discountList[i].type&&$scope.selectedProduct.discountList[i].discountAmount>0&&($rootScope.voluntaryDeductable=$scope.selectedProduct.discountList[i].discountAmount),"Anti-Theft Discount"==$scope.selectedProduct.discountList[i].type&&$scope.selectedProduct.discountList[i].discountAmount>0&&($rootScope.antiTheftDeviceAmount=$scope.selectedProduct.discountList[i].discountAmount);getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.productDataReader,buyScreenParam,function(buyScreen){if(buyScreen.responseCode==$scope.p365Labels.responseCode.success){var buyScreens=buyScreen.data;$scope.ownerDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[0].template),$scope.nominationDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[1].template),$scope.prevPolicyDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[2].template),$scope.vehicleDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[3].template),$scope.productValidation=buyScreens.validation,$scope.requestFormat=buyScreens.requestFormat,$scope.transactionName=buyScreens.transaction.proposalService.name,$scope.transactionNameCopy=$scope.transactionName,$scope.transactionSaveProposal="saveProposalService",$scope.transactionSubmitProposal="submitProposal",$scope.productValidation.PUCValidation?$scope.PUCValidation=!0:$scope.PUCValidation=!1,$scope.initCarBuyScreen(),$scope.getCarrierList()}})}else $rootScope.P365Alert("Policies365",$scope.p365Labels.validationMessages.iposFormErrorMsg,"Ok")});else{$scope.p365Labels=carProposalLabels,$scope.quoteUserInfo=localStorageService.get("quoteUserInfo"),$rootScope.loaderContent={businessLine:"3",header:"Car Insurance",desc:$sce.trustAsHtml($scope.p365Labels.common.proverbBuyProduct)},$rootScope.title=$scope.p365Labels.policies365Title.carBuyQuote;localStorageService.get("quoteUserInfo");var buyScreens=localStorageService.get("buyScreen");$scope.selectedProduct=localStorageService.get("carSelectedProduct"),$scope.insuranceDetails.insuranceType=$scope.selectedProduct.policyType,$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.addOnCovers=localStorageService.get("addOnCoverListForCar"),"Individual"==$scope.selectedProductInputParam.quoteParam.ownedBy?$scope.personalDetailsFlag=!0:"Organization"==$scope.selectedProductInputParam.quoteParam.ownedBy&&($scope.personalDetailsFlag=!1),$scope.ownerDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[0].template),$scope.nominationDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[1].template),$scope.prevPolicyDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[2].template),$scope.vehicleDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[3].template),$scope.productValidation=buyScreens.validation,$scope.requestFormat=buyScreens.requestFormat,$scope.transactionName=buyScreens.transaction.proposalService.name,$scope.paymentURL=buyScreens.paymentUrl,$scope.productValidation.PUCValidation?$scope.PUCValidation=!0:$scope.PUCValidation=!1,localStorageService.get("commAddressDetails")?($scope.proposerDetails.communicationAddress.comDisplayArea=localStorageService.get("commAddressDetails").displayArea,$scope.proposerDetails.communicationAddress.comPincode=localStorageService.get("commAddressDetails").pincode,$scope.proposerDetails.communicationAddress.comState=localStorageService.get("commAddressDetails").state,$scope.proposerDetails.communicationAddress.comCity=localStorageService.get("commAddressDetails").city):($scope.proposerDetails.communicationAddress.comDisplayArea="",$scope.proposerDetails.communicationAddress.comPincode="",$scope.proposerDetails.communicationAddress.comState="",$scope.proposerDetails.communicationAddress.comCity=""),$scope.initCarBuyScreen(),$scope.getCarrierList()}else $rootScope.P365Alert("Policies365","Server Error","Ok")}),$scope.$watch("proposerDetails.communicationAddress.comDisplayArea",function(newValue){$scope.vehicleDetails.isVehicleAddressSameAsCommun&&$scope.changeRegAddress()}),$scope.$watch("proposerDetails.communicationAddress.comDoorNo",function(newValue){$scope.vehicleDetails.isVehicleAddressSameAsCommun&&$scope.changeRegAddress()}),$scope.$on("setCommAddressByAPI",function(){setTimeout(function(){var googleAddressObject=angular.copy($rootScope.chosenCommPlaceDetails);getAddressFields(googleAddressObject,function(fomattedAddress,formattedCity,formattedState,formattedPincode){$scope.proposerDetails.communicationAddress.comDisplayArea=fomattedAddress,"undefined"!=String(formattedPincode)&&""!=formattedPincode?$scope.calcDefaultAreaDetails(formattedPincode):($scope.proposerDetails.communicationAddress.comPincode="",$scope.proposerDetails.communicationAddress.comState="",$scope.proposerDetails.communicationAddress.comCity=""),$scope.$apply()})},10)}),$scope.$on("setRegAddressByAPI",function(){setTimeout(function(){var googleAddressObject=angular.copy($rootScope.chosenRegPlaceDetails);getAddressFields(googleAddressObject,function(fomattedAddress,formattedCity,formattedState,formattedPincode){$scope.vehicleDetails.registrationAddress.regDisplayArea=fomattedAddress,"undefined"!=String(formattedPincode)&&""!=formattedPincode?$scope.calcDefaultRegAreaDetails(formattedPincode):($scope.vehicleDetails.registrationAddress.regPincode="",$scope.vehicleDetails.registrationAddress.regState="",$scope.vehicleDetails.registrationAddress.regCity=""),$scope.$apply()})},10)}),$(".activateFooter").hide(),$(".activateHeader").hide()}]),angular.module("FourWheelerscheduleInspection",["CoreComponentApp","LocalStorageModule","checklist-model","ngMessages"]).controller("FourWheelerscheduleInspectionController",["$scope","$timeout","RestAPI","localStorageService","$location","$window","$http","$filter","$interval",function($scope,$timeout,RestAPI,localStorageService,$location,$window,$http,$filter,$interval){var applicationLabels=localStorageService.get("applicationLabels");$scope.globalLabel=applicationLabels.globalLabels,$scope.proposerDetails={},$scope.insuranceDetails={},$scope.insuredInfo={},$scope.insuredDiseases=[],$scope.insuredDiseaseList=[],$scope.insuredList=[],$scope.insuredObjectList=[],$scope.vehicleDetails={},$scope.screenOneStatus=!0,$scope.screenTwoStatus=!1,$scope.selectedProduct=localStorageService.get("carSelectedProduct"),console.log("car selected product :"+JSON.stringify($scope.selectedProduct)),$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),console.log("car quote input param :"+JSON.stringify($scope.selectedProductInputParam)),$scope.carrierList=companyNamesCarGeneric,$scope.addOnCovers=localStorageService.get("addOnCoverListForCar");var quoteUserInfo=localStorageService.set("quoteUserInfo");$scope.vehicleDetails=localStorageService.get("selectedCarDetails"),console.log("vehicle details :"+JSON.stringify($scope.vehicleDetails)),"renew"==$scope.vehicleDetails.insuranceType.value?$scope.showPreviousPolicyForm=!0:$scope.showPreviousPolicyForm=!1,"expired"==$scope.vehicleDetails.policyStatus.policyType&&"> 90 days"==$scope.vehicleDetails.policyStatus.displayText2?($scope.showInspectionButton=!0,$scope.showPaymentButton=!1):($scope.showInspectionButton=!1,$scope.showPaymentButton=!0);var todayDate=new Date;if("Not yet expired"==$scope.vehicleDetails.policyStatus.label){var tempPolicyStartDate=$scope.vehicleDetails.policyStatus.expiryDate.split("/");$scope.insuranceDetails.policyStartDate=tempPolicyStartDate[1]+"/"+tempPolicyStartDate[0]+"/"+tempPolicyStartDate[2]}else{var tomorrow=new Date;tomorrow.setDate(todayDate.getDate()+1),$scope.insuranceDetails.policyStartDate=tomorrow.getDate()+"/"+(Number(tomorrow.getMonth())+1)+"/"+tomorrow.getFullYear()}if("undefined"!==String($scope.insuranceDetails.policyStartDate)){todayDate=new Date;var polEndDate,polStartDate=$scope.insuranceDetails.policyStartDate.split("/"),tempPolStartDate=polStartDate[1]+"/"+polStartDate[0]+"/"+polStartDate[2];new Date(tempPolStartDate)<todayDate?($scope.insuranceDetails.policyStartDate=todayDate.getDate()+"/"+(Number(todayDate.getMonth())+1)+"/"+todayDate.getFullYear(),tempPolStartDate=(polStartDate=$scope.insuranceDetails.policyStartDate.split("/"))[1]+"/"+polStartDate[0]+"/"+polStartDate[2],polEndDate=new Date((new Date).setDate(new Date(String(tempPolStartDate)).getDate()+364)),$scope.insuranceDetails.policyEndDate=polEndDate.getDate()+"/"+(Number(polEndDate.getMonth())+1)+"/"+polEndDate.getFullYear()):(polEndDate=new Date((new Date).setDate(new Date(String(tempPolStartDate)).getDate()+364)),$scope.insuranceDetails.policyEndDate=polEndDate.getDate()+"/"+(Number(polEndDate.getMonth())+1)+"/"+polEndDate.getFullYear())}var tempNcbPosition,buyScreenParam={};buyScreenParam.businessLineId=localStorageService.get("selectedBusinessLineId"),buyScreenParam.carrierId=$scope.selectedProduct.carrierId,buyScreenParam.productId=$scope.selectedProduct.productId,buyScreenParam.documentType="CarPlan",getDocUsingParam(RestAPI,$scope.globalLabel.transactionName.getPlanRiders,buyScreenParam,function(buyScreenRiders){buyScreenRiders.responseCode==$scope.globalLabel.responseCode.success?localStorageService.set("buyScreenRidersForCar",buyScreenRiders.data):localStorageService.set("buyScreenRidersForCar",void 0)}),$scope.selectedProductInputParam.vehicleInfo=localStorageService.get("carQuoteInputParamaters").vehicleInfo,$scope.selectedProductInputParam.quoteParam=localStorageService.get("carQuoteInputParamaters").quoteParam,$scope.maritalStatusType=[{name:"MARRIED",id:1},{name:"BACHELOR/SINGLE/UNMARRIED",id:2},{name:"DIVORCEE/WIDOW(ER)",id:3}],$scope.relationList=[{name:"Son"},{name:"Daughter"},{name:"Father"},{name:"Mother"},{name:"Spouse"}],$scope.ncbList=[{value:"15"},{value:"20"},{value:"25"},{value:"30"},{value:"35"},{value:"40"},{value:"45"}],$scope.proposerDetails.gender="Male",$scope.proposerDetails.emailId="undefined"!==String(quoteUserInfo.emailId)?quoteUserInfo.emailId:"",$scope.proposerDetails.mobileNumber="undefined"!==String(quoteUserInfo.mobileNumber)?quoteUserInfo.mobileNumber:"",$scope.proposerDetails.lastName="undefined"!==String(quoteUserInfo.lastName)?quoteUserInfo.lastName:"",$scope.proposerDetails.firstName="undefined"!==String(quoteUserInfo.firstName)?quoteUserInfo.firstName:"",$scope.proposerDetails.dateOfBirth=$scope.vehicleDetails.dateOfBirth,$scope.proposerDetails.occupation=localStorageService.get("selectedOccupationForCar"),$scope.previousPolicyDetails={},$scope.previousPolicyDetails.expiryDate=$scope.vehicleDetails.policyStatus.displayText2;for(var i=0;i<$scope.ncbList.length;i++)if($scope.selectedProduct.ncbPercentage==$scope.ncbList[i].value){tempNcbPosition=i;break}$scope.previousPolicyDetails.ncb=$scope.ncbList[tempNcbPosition].value,$scope.putNomineeLastName=function(){$scope.nominationDetails.lastName=$scope.proposerDetails.lastName},$scope.updatePremium=function(){for(var i=0;i<$scope.selectedAddOnCovers.length;i++)for(var j=0;j<$scope.selectedProduct.riderList.length;j++)$scope.selectedAddOnCovers[i].riderId==$scope.selectedProduct.riderList[j]["com.sutrr.quote.carquotecalc.AddOnCover"].riderId&&($scope.selectedProduct.grossPremium+=$scope.selectedProduct.riderList[j]["com.sutrr.quote.carquotecalc.AddOnCover"].riderPremiumWithServiceTax)},$scope.calcDefaultAreaDetails=function(areaCode){$http.get(getServiceLink+"Pincode&q="+areaCode).then(function(response){var areaDetails=JSON.parse(response.data);areaDetails.responseCode==$scope.globalLabel.responseCode.success&&$scope.onSelectPinOrArea(areaDetails.data[0])})},$scope.proposerDetails.pincode=localStorageService.get("cityDataFromIP")&&1==localStorageService.get("cityDataFromIP").cityStatus?localStorageService.get("cityDataFromIP").pincode:"110002",$scope.calcDefaultAreaDetails($scope.proposerDetails.pincode),$scope.nominationDetails={},$scope.vehicleDetails={},$scope.nominationDetails.dateOfBirth="01/07/1976",$scope.vehicleDetails.carMake=$scope.selectedProductInputParam.vehicleInfo.name,$scope.vehicleDetails.carModel=$scope.selectedProductInputParam.vehicleInfo.model,$scope.vehicleDetails.carVariant=$scope.selectedProductInputParam.vehicleInfo.variant,$scope.vehicleDetails.fuelType=$scope.selectedProductInputParam.vehicleInfo.fuel,$scope.vehicleDetails.regYear=$scope.selectedProductInputParam.vehicleInfo.regYear,$scope.vehicleDetails.manufacturingDate="01/01/"+$scope.selectedProductInputParam.vehicleInfo.regYear,$scope.modalPIN=!1,$scope.togglePin=function(){$scope.modalPIN=!$scope.modalPIN,$scope.hideModal=function(){$scope.modalPIN=!1}},$scope.getPinCodeAreaList=function(areaName){var docType;return docType=isNaN(areaName)?"Area":"Pincode",$http.get(getServiceLink+docType+"&q="+areaName).then(function(response){return JSON.parse(response.data).data})},$scope.onSelectPinOrArea=function(item){$scope.displayArea=item.area+", "+item.district,$scope.modalPIN=!1,$scope.proposerDetails.area=item.area,$scope.proposerDetails.pincode=item.pincode,$scope.proposerDetails.city=item.district,$scope.proposerDetails.state=item.state,localStorageService.set("userGeoDetails",item)},$scope.validateProposerDateOfBirth=function(){getAgeFromDOB($scope.proposerDetails.dateOfBirth)<18&&($scope.proposerDetails.dateOfBirth="")},$scope.validateNomineeDateOfBirth=function(){getAgeFromDOB($scope.nominationDetails.dateOfBirth)<18&&($scope.nominationDetails.dateOfBirth="")},$scope.validateInsuredDateOfBirth=function(){if("Self"==$scope.insuredRelation.relation||"Spouse"==$scope.insuredRelation.relation)getAgeFromDOB($scope.insuredDateOfBirth)<18&&($scope.insuredDateOfBirth=$scope.insuredRelation.dob);else if("Son"==$scope.insuredRelation.relation||"Daughter"==$scope.insuredRelation.relation)for(var i=0;i<$scope.insuredList.length;i++)if("Self"==$scope.insuredList[i].relation.relation&&$scope.insuredList[i].relation.age-getAgeFromDOB($scope.insuredDateOfBirth)<18){$scope.insuredDateOfBirth=$scope.insuredRelation.dob;break}},$scope.changePolicyTerm=function(){var polStartDate,tempPolStartDate,polEndDate;1==$scope.proposerDetails.policyTerm.term?(tempPolStartDate=(polStartDate=$scope.insuranceDetails.policyStartDate.split("/"))[1]+"/"+polStartDate[0]+"/"+polStartDate[2],polEndDate=new Date((new Date).setDate(new Date(String(tempPolStartDate)).getDate()+364)),$scope.insuranceDetails.policyEndDate=polEndDate.getDate()+"/"+(Number(polEndDate.getMonth())+1)+"/"+polEndDate.getFullYear()):(tempPolStartDate=(polStartDate=$scope.insuranceDetails.policyStartDate.split("/"))[1]+"/"+polStartDate[0]+"/"+polStartDate[2],polEndDate=new Date((new Date).setDate(new Date(String(tempPolStartDate)).getDate()+364)),$scope.insuranceDetails.policyEndDate=polEndDate.getDate()+"/"+(Number(polEndDate.getMonth())+1)+"/"+(Number(polEndDate.getFullYear())+1))},$scope.calcPolicyEndDate=function(){var polEndDate;if("undefined"!==String($scope.insuranceDetails.policyStartDate)){var todayDate=new Date,polStartDate=$scope.insuranceDetails.policyStartDate.split("/"),tempPolStartDate=polStartDate[1]+"/"+polStartDate[0]+"/"+polStartDate[2];new Date(tempPolStartDate)<todayDate?($scope.insuranceDetails.policyStartDate=todayDate.getDate()+"/"+(Number(todayDate.getMonth())+1)+"/"+todayDate.getFullYear(),tempPolStartDate=(polStartDate=$scope.insuranceDetails.policyStartDate.split("/"))[1]+"/"+polStartDate[0]+"/"+polStartDate[2],polEndDate=new Date((new Date).setDate(new Date(String(tempPolStartDate)).getDate()+364)),$scope.insuranceDetails.policyEndDate=polEndDate.getDate()+"/"+(Number(polEndDate.getMonth())+1)+"/"+polEndDate.getFullYear()):(polEndDate=new Date((new Date).setDate(new Date(String(tempPolStartDate)).getDate()+364)),$scope.insuranceDetails.policyEndDate=polEndDate.getDate()+"/"+(Number(polEndDate.getMonth())+1)+"/"+polEndDate.getFullYear())}},$scope.validatePrevPolStartDate=function(){if("undefined"!==String($scope.insuranceDetails.prevPolicyStartDate)){var oneYearPrevDate=new Date((new Date).setDate((new Date).getDate()-364)),prePolStartDate=$scope.insuranceDetails.prevPolicyStartDate.split("/"),tempPrePolStartDate=prePolStartDate[1]+"/"+prePolStartDate[0]+"/"+prePolStartDate[2];if(new Date(tempPrePolStartDate)>oneYearPrevDate)$scope.prevPolStartDateErr=!0,$scope.insuranceDetails.prevPolicyStartDate="";else{$scope.prevPolStartDateErr=!1,tempPrePolStartDate=(prePolStartDate=$scope.insuranceDetails.prevPolicyStartDate.split("/"))[1]+"/"+prePolStartDate[0]+"/"+prePolStartDate[2];var prePolEndDate=new Date(tempPrePolStartDate);prePolEndDate.setFullYear(Number(prePolStartDate[2])+1),$scope.insuranceDetails.prevPolicyEndDate=prePolEndDate.getDate()+"/"+(Number(prePolEndDate.getMonth())+1)+"/"+prePolEndDate.getFullYear()}}},$scope.validatePrevPolEndDate=function(){if("undefined"!==String($scope.insuranceDetails.prevPolicyEndDate)&&"undefined"!==String($scope.insuranceDetails.prevPolicyStartDate)){var currentDate=new Date,prePolEndDate=$scope.insuranceDetails.prevPolicyEndDate.split("/"),tempPrePolEndDate=prePolEndDate[1]+"/"+prePolEndDate[0]+"/"+prePolEndDate[2],prePolStartDate=$scope.insuranceDetails.prevPolicyStartDate.split("/"),tempPrePolStartDate=prePolStartDate[1]+"/"+prePolStartDate[0]+"/"+prePolStartDate[2],calcPrePolStartDate=new Date(tempPrePolStartDate);calcPrePolStartDate.setFullYear(Number(prePolStartDate[2])+1),new Date(tempPrePolEndDate)>currentDate||new Date(tempPrePolEndDate)<calcPrePolStartDate?($scope.prevPolEndDateErr=!0,$scope.insuranceDetails.prevPolicyEndDate=""):$scope.prevPolEndDateErr=!1}},$scope.cancel=function(){$scope.insuredFirstName="",$scope.insuredLastName="",$scope.insuredGender="Male",$scope.insuredRelation="",$scope.insuredDateOfBirth="",$scope.insuredOccupation="",$scope.insuredHeight="",$scope.insuredWeight="",$scope.isPersonalAccidentApplicable="",$scope.insuredMedicineLastOneYear="No",$scope.insuredInfo.insuredCriticalDrug="",$scope.insuredDiseases=[],$scope.updateBtnStatus=!1,$scope.addBtnStatus=!0},$scope.updateInsured=function(){var i;if(!$scope.addInsuredForm.$invalid){$scope.updateBtnStatus=!1,$scope.addBtnStatus=!0;var selectedDiseaseList=[];for(i=0;i<$scope.insuredDiseases.length;i++)for(var j=0;j<$scope.insuredDiseaseList.length;j++)if($scope.insuredDiseases[i].id==$scope.insuredDiseaseList[j].id){delete $scope.insuredDiseaseList[j].$$hashKey,selectedDiseaseList.push($scope.insuredDiseaseList[j]);break}var criticalCancer="false",criticalRenal="false",criticalHeart="false",criticalPsychiatric="false";for(i=0;i<selectedDiseaseList.length;i++)"Cancer"==selectedDiseaseList[i].disease&&(criticalCancer="true"),"Kidney related"==selectedDiseaseList[i].disease&&(criticalRenal="true"),"Heart ailments"==selectedDiseaseList[i].disease&&(criticalHeart="true"),"Brain & Spinal cord disorders"==selectedDiseaseList[i].disease&&(criticalPsychiatric="true");var udatedInsured={name:$scope.insuredFirstName+" "+("undefined"!=String($scope.insuredLastName)?$scope.insuredLastName:""),gender:$scope.insuredGender,relation:$scope.insuredRelation,relationshipId:$scope.insuredRelation.id,dateofbirth:$scope.insuredDateOfBirth,occupation:$scope.insuredOccupation,height:Number($scope.insuredHeight),weight:Number($scope.insuredWeight),selectedDiseases:selectedDiseaseList,isPersonalAccidentApplicable:$scope.isPersonalAccidentApplicable,takingMedicineLastOneYear:$scope.insuredMedicineLastOneYear,criticalDrugName:"Yes"==$scope.insuredMedicineLastOneYear?$scope.insuredInfo.insuredCriticalDrug:"",criticalDrugs:"Yes"==$scope.insuredMedicineLastOneYear?"true":"false",criticalCancer:criticalCancer,criticalRenal:criticalRenal,criticalHeart:criticalHeart,criticalPsychiatric:criticalPsychiatric};$scope.insuredList[$scope.selEditInsuredIndex]=udatedInsured,$scope.insuredFirstName="",$scope.insuredLastName="",$scope.insuredGender="Male",$scope.insuredRelation="",$scope.insuredDateOfBirth="",$scope.insuredOccupation="",$scope.insuredHeight="",$scope.insuredWeight="",$scope.isPersonalAccidentApplicable="",$scope.insuredMedicineLastOneYear="No",$scope.insuredInfo.insuredCriticalDrug="",$scope.insuredDiseases=[]}},$scope.editInsured=function(selectedInsured,selectedIndex){$scope.updateBtnStatus=!0,$scope.addBtnStatus=!1,$scope.selEditInsuredIndex=selectedIndex;var selectedDiseaseList=[],insuredName=selectedInsured.name.split(" ");$scope.insuredFirstName="undefined"!=insuredName[0]?insuredName[0]:"",$scope.insuredLastName="undefined"!=insuredName[2]?insuredName[2]:"",$scope.insuredGender=selectedInsured.gender,$scope.insuredRelation=selectedInsured.relation,$scope.insuredDateOfBirth=selectedInsured.dateofbirth,$scope.insuredOccupation=selectedInsured.occupation,$scope.insuredHeight=selectedInsured.height,$scope.insuredWeight=selectedInsured.weight,$scope.insuredMedicineLastOneYear=selectedInsured.takingMedicineLastOneYear,$scope.insuredInfo.insuredCriticalDrug=selectedInsured.criticalDrugName;for(var i=0;i<selectedInsured.selectedDiseases.length;i++){var diseaseId={};diseaseId.id=selectedInsured.selectedDiseases[i].id,selectedDiseaseList.push(diseaseId)}$scope.insuredDiseases=selectedDiseaseList},$scope.insertInsured=function(){var i;if(!$scope.addInsuredForm.$invalid){var selectedDiseaseList=[];for(i=0;i<$scope.insuredDiseases.length;i++)for(var j=0;j<$scope.insuredDiseaseList.length;j++)if($scope.insuredDiseases[i].id==$scope.insuredDiseaseList[j].id){delete $scope.insuredDiseaseList[j].$$hashKey,selectedDiseaseList.push($scope.insuredDiseaseList[j]);break}var criticalCancer="false",criticalRenal="false",criticalHeart="false",criticalPsychiatric="false";for(i=0;i<selectedDiseaseList.length;i++)"Cancer"==selectedDiseaseList[i].disease&&(criticalCancer="true"),"Kidney related"==selectedDiseaseList[i].disease&&(criticalRenal="true"),"Heart ailments"==selectedDiseaseList[i].disease&&(criticalHeart="true"),"Brain & Spinal cord disorders"==selectedDiseaseList[i].disease&&(criticalPsychiatric="true");$scope.insuredList.push({name:$scope.insuredFirstName+" "+("undefined"!=String($scope.insuredLastName)?$scope.insuredLastName:""),gender:$scope.insuredGender,relation:$scope.insuredRelation,relationshipId:$scope.insuredRelation.id,dateofbirth:$scope.insuredDateOfBirth,occupation:$scope.insuredOccupation,height:Number($scope.insuredHeight),weight:Number($scope.insuredWeight),selectedDiseases:selectedDiseaseList,isPersonalAccidentApplicable:$scope.isPersonalAccidentApplicable,takingMedicineLastOneYear:$scope.insuredMedicineLastOneYear,criticalDrugName:"Yes"==$scope.insuredMedicineLastOneYear?$scope.insuredInfo.insuredCriticalDrug:"",criticalDrugs:"Yes"==$scope.insuredMedicineLastOneYear?"true":"false",criticalCancer:criticalCancer,criticalRenal:criticalRenal,criticalHeart:criticalHeart,criticalPsychiatric:criticalPsychiatric}),$scope.insuredFirstName="",$scope.insuredLastName="",$scope.insuredGender="Male",$scope.insuredRelation="",$scope.insuredDateOfBirth="",$scope.insuredOccupation="",$scope.insuredHeight="",$scope.insuredWeight="",$scope.isPersonalAccidentApplicable="",$scope.insuredMedicineLastOneYear="No",$scope.insuredInfo.insuredCriticalDrug="",$scope.insuredDiseases=[]}},$scope.submitPersonalAndNominationInfo=function(){$scope.screenOneStatus=!1,$scope.screenTwoStatus=!0,$(".proposerInfo").removeClass("active"),$(".proposerInfo").addClass("complete"),$(".prevPolicyInfo").removeClass("disabled"),$(".prevPolicyInfo").addClass("active")},$scope.submitPreviousPolicyAndVehicleInfo=function(){$scope.screenOneStatus=!1,$scope.screenTwoStatus=!0,$(".prevPolicyInfo").removeClass("active"),$(".prevPolicyInfo").addClass("complete")},$scope.editPesonalInfo=function(){$scope.screenOneStatus=!0,$scope.screenTwoStatus=!1,$scope.screenThreeStatus=!1,$scope.screenFourStatus=!1},$scope.proceedForPayment=function(){if(!$scope.insuranceDetailsForm.$invalid&&$scope.insuranceDetails.undertakingStatus){var proposalSubmitConfirmMsg="Please make sure you have entered the right Mobile Number and Email ID. All our communication will be sent to your Mobile "+$scope.proposerDetails.mobileNumber+" or Email "+$scope.proposerDetails.emailId+". Is the entered Mobile No. and Email ID right?";$rootScope.P365Confirm("Policies365",proposalSubmitConfirmMsg,"No","Yes",function(confirmStatus){if(confirmStatus){var proposeForm={proposerDetails:{}};$scope.proposerDetails.panNumber="undefined"!=String($scope.proposerDetails.panNumber)?$scope.proposerDetails.panNumber.toUpperCase():"",proposeForm.proposerDetails=$scope.proposerDetails,proposeForm.insuranceDetails=$scope.insuranceDetails,proposeForm.proposerDetails.insuredDetails=$scope.insuredList,proposeForm.documentType="BuyProduct",proposeForm.carrierId=Number($scope.selectedProduct.carrierId),proposeForm.planId=Number($scope.selectedProduct.planId),localStorageService.set("medicalFinalProposeForm",proposeForm),RestAPI.invoke($scope.transactionName,proposeForm).then(function(proposeFormResponse){if(proposeFormResponse.responseCode==$scope.globalLabel.responseCode.success){var getTokenRequest={},reponseToken={};reponseToken.premium=null!=proposeFormResponse.data.premium||"undefined"!=String(proposeFormResponse.data.premium)?proposeFormResponse.data.premium:0,reponseToken.serviceTax=null!=proposeFormResponse.data.serviceTax||"undefined"!=String(proposeFormResponse.data.serviceTax)?proposeFormResponse.data.serviceTax:0,reponseToken.totalPremium=null!=proposeFormResponse.data.totalPremium||"undefined"!=String(proposeFormResponse.data.totalPremium)?proposeFormResponse.data.totalPremium:0,reponseToken.proposalId=proposeFormResponse.data.proposalId,1==$scope.getRefToken?(getTokenRequest.referenceId=proposeFormResponse.data.referenceId,RestAPI.invoke("getReferenceToken",getTokenRequest).then(function(referenceTokenResp){referenceTokenResp.responseCode==$scope.globalLabel.responseCode.success?(reponseToken.redirectToken=referenceTokenResp.data.redirectToken,reponseToken.referenceId=referenceTokenResp.data.referenceId,localStorageService.set("medicalReponseToken",reponseToken),$window.location.href=buyScreens.paymentUrl.replace("PROPOSAL_ID",referenceTokenResp.data.redirectToken)):$rootScope.P365Alert("Policies365","We are not able to connect insurance company to issue your policy. Kindly try after some time.","Ok")})):(reponseToken.purchaseToken=proposeFormResponse.data.referenceId,$scope.proposalNum=proposeFormResponse.data.referenceId,localStorageService.set("medicalReponseToken",reponseToken),$scope.PAYMENTFORM.commit())}else $rootScope.P365Alert("Policies365","We are facing internal issue. Kindly try after some time.","Ok")})}})}else $rootScope.P365Alert("Policies365","Please fill all the fields.","Ok")},$scope.scheduleInspection=function(){$location.path("/FourWheelerscheduleInspection")},$(".activateFooter").hide(),$(".activateHeader").hide()}]),angular.module("proposalresdatacar",["CoreComponentApp","LocalStorageModule","checklist-model","ngMessages"]).controller("proposalResponseDataCarController",["$scope","$rootScope","$timeout","RestAPI","localStorageService","$location","$window","$http","$filter","$interval","$sce",function($scope,$rootScope,$timeout,RestAPI,localStorageService,$location,$window,$http,$filter,$interval,$sce){loadDatbase(function(){var inspectionNumber;$scope.carProposalSectionHTML=wp_path+"buy/car/html/CarProposalSection.html",$scope.p365Labels=carProposalLabels,$rootScope.loading=!0,$scope.saveProposal=!1,$scope.saveNomineeDetails=!1,$scope.savePrevPolicyDetails=!1,$scope.modalPropScreenError=!1,$scope.modalPrevPolExpiredError=!1,$scope.screenOneStatus=!0,$scope.screenTwoStatus=!1,$scope.screenThreeStatus=!1,$scope.screenFourStatus=!1,$scope.redirectForPayment=!1,$scope.alreadyExpiredPolicyError=!1,$scope.breakInInspectionStatus=!1,$scope.submitProposalClicked=!1,$scope.accordion="1",$scope.proposerDetails={},$scope.proposerDetails.communicationAddress={},$scope.vehicleDetails={},$scope.vehicleDetails.registrationAddress={},$scope.organizationDetails={},$rootScope.customEnvEnabled||($rootScope.customEnvEnabled=customEnvEnabled),$rootScope.baseEnvEnabled||($rootScope.baseEnvEnabled=baseEnvEnabled),$scope.createCarVehicleDetailsRequest=function(){var vehicleDetailRequest={registrationAddress:{}};vehicleDetailRequest.registrationAddress.regDoorNo=$scope.vehicleDetails.registrationAddress.regDoorNo,vehicleDetailRequest.purchasedLoan=$scope.vehicleDetails.purchasedLoan,vehicleDetailRequest.engineNumber=$scope.vehicleDetails.engineNumber,vehicleDetailRequest.isVehicleAddressSameAsCommun=$scope.vehicleDetails.isVehicleAddressSameAsCommun,vehicleDetailRequest.chassisNumber=$scope.vehicleDetails.chassisNumber,vehicleDetailRequest.registrationNumber=$scope.vehicleDetails.RTOCode.toUpperCase()+$scope.vehicleInfo.registrationNumber.toUpperCase(),$scope.vehicleDetails.vehicleLoanType&&(vehicleDetailRequest.vehicleLoanType=$scope.vehicleDetails.vehicleLoanType),$scope.vehicleDetails.financeInstitution&&(vehicleDetailRequest.financeInstitution=$scope.vehicleDetails.financeInstitution),$scope.vehicleDetails.financeInstitutionCode&&(vehicleDetailRequest.financeInstitutionCode=$scope.vehicleDetails.financeInstitutionCode),$scope.vehicleDetails.monthlyMileage&&(vehicleDetailRequest.monthlyMileage=$scope.vehicleDetails.monthlyMileage),inspectionNumber&&(vehicleDetailRequest.inspectionReferenceNo=inspectionNumber),vehicleDetailRequest.registrationAddress.regCity=$scope.vehicleDetails.registrationAddress.regCity,vehicleDetailRequest.registrationAddress.regDisplayArea=$scope.vehicleDetails.registrationAddress.regDisplayArea,vehicleDetailRequest.registrationAddress.regPincode=$scope.vehicleDetails.registrationAddress.regPincode,vehicleDetailRequest.registrationAddress.regState=$scope.vehicleDetails.registrationAddress.regState,vehicleDetailRequest.registrationAddress.regArea=$scope.vehicleDetails.registrationAddress.regArea,vehicleDetailRequest.registrationAddress.regDistrict=$scope.vehicleDetails.registrationAddress.regDistrict,vehicleDetailRequest.registrationAddress.regDisplayField=$scope.vehicleDetails.registrationAddress.regDisplayField,$scope.carProposeFormDetails.vehicleDetails=vehicleDetailRequest},$scope.editPesonalInfo=function(){$scope.screenOneStatus=!0,$scope.screenTwoStatus=!0,$scope.screenThreeStatus=!1,$scope.accordion="1",$scope.disableAllFields()},$scope.editNomineeInfo=function(){$scope.screenOneStatus=!1,$scope.screenTwoStatus=!0,$scope.screenThreeStatus=!1,$scope.accordion="2",$scope.disableAllFields()},$scope.editPrevPolicyInfo=function(){$scope.screenOneStatus=!1,$scope.screenTwoStatus=!1,$scope.screenThreeStatus=!0,$scope.accordion="3",$scope.disableAllFields()},$scope.Section2Inactive=!0,$scope.Section3Inactive=!0,$scope.Section4Inactive=!0,$scope.submitPersonalDetails=function(){$scope.screenOneStatus=!0,$scope.screenTwoStatus=!0,$scope.screenThreeStatus=!1,$scope.screenFourStatus=!1,$scope.Section2Inactive=!1,$scope.accordion="2",$scope.disableAllFields(),1==imauticAutomation&&imatEvent("ProposalFilled"),$scope.organizationDetails.contactPersonName&&$scope.organizationDetails.contactPersonName.indexOf(" ")>=0&&($scope.proposerDetails.firstName=$scope.organizationDetails.contactPersonName.split(" ")[0],$scope.proposerDetails.lastName=$scope.organizationDetails.contactPersonName.split(" ")[1]),$rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($scope.ownerDetailsForm.$dirty||$scope.changeCompanyName)&&($scope.responseProduct.proposalRequest.proposerDetails=$scope.proposerDetails,$scope.responseProduct.proposalRequest.insuranceDetails=$scope.insuranceDetails,$scope.vehicleDetailsForm.$dirty&&($scope.responseProduct.vehicleDetails=$scope.vehicleDetails),$scope.saveProposal=!0,$scope.submitProposalData(),$scope.ownerDetailsForm.$setPristine(),$scope.changeCompanyName=!1)},$scope.submitAddressDetails=function(){$scope.screenOneStatus=!0,$scope.screenTwoStatus=!0,$scope.screenThreeStatus=!0,$scope.screenFourStatus=!1,$scope.screenFiveStatus=!1,$scope.Section3Inactive=!1,$scope.accordion="3"},$scope.submitNomineeDetails=function(){$scope.screenOneStatus=!0,$scope.screenTwoStatus=!0,$scope.screenThreeStatus=!0,$scope.previousPolicyStatus?($scope.screenFourStatus=!0,$scope.screenFiveStatus=!1,$scope.Section3Inactive=!1,$scope.accordion="4"):($scope.screenFourStatus=!1,$scope.screenFiveStatus=!0,$scope.proceedPaymentStatus=!0,$scope.Section4Inactive=!1,$scope.accordion="5",$scope.disableAllFields()),$rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($scope.responseProduct.proposalRequest.nominationDetails&&!$scope.nomineeDetailsForm.$dirty||($scope.saveProposal=!0,$scope.saveNomineeDetails=!0,$scope.savePrevPolicyDetails=!1,$scope.responseProduct.proposalRequest.nominationDetails=$scope.nominationDetails,$scope.responseProduct.proposalRequest.appointeeDetails=$scope.appointeeDetails,$scope.submitProposalData(),$scope.nomineeDetailsForm.$setPristine()))},$scope.submitPrevPolicyDetails=function(){$scope.screenOneStatus=!0,$scope.screenTwoStatus=!0,$scope.screenThreeStatus=!0,$scope.screenFourStatus=!0,$scope.screenFiveStatus=!0,$scope.proceedPaymentStatus=!0,$scope.Section5Inactive=!1,$scope.accordion="5",$scope.disableAllFields(),$rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($scope.responseProduct.proposalRequest.insuranceDetails.policyNumber&&!$scope.prevPolicyDetailsForm.$dirty||($scope.saveProposal=!0,$scope.saveNomineeDetails=!0,$scope.savePrevPolicyDetails=!0,$scope.responseProduct.proposalRequest.insuranceDetails=$scope.insuranceDetails,$scope.submitProposalData(),$scope.prevPolicyDetailsForm.$setPristine()))},$scope.disableAllFields=function(){$scope.proposalStatus&&"completed"==$scope.proposalStatus.statusPaym&&setTimeout(function(){$("form md-option").attr("disabled","disabled"),$("form md-select").attr("disabled","disabled"),$("input").attr("disabled","disabled"),$("md-radio-button").attr("disabled","disabled"),$("md-checkbox").attr("disabled","disabled"),$scope.vehicleDetailsForm.$invalid=!0},1e3)},$scope.sendSMS=function(){var validateAuthParam={paramMap:{}};validateAuthParam.mobileNumber=$scope.proposerDetails.mobileNumber,validateAuthParam.paramMap.firstName=$scope.proposerDetails.firstName,validateAuthParam.funcType="ProposalFilled",getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.sendSMS,validateAuthParam,function(createOTP){$scope.submitProposalClicked||(createOTP.responseCode,$scope.p365Labels.responseCode.success,$scope.redirectToPaymentGateway())})},$scope.sendPaymentSuccessEmail=function(){var proposalDetailsEmail={paramMap:{},funcType:"ProposalDetailsTemplate"};$scope.shortenURL?proposalDetailsEmail.paramMap.url=$scope.shortURLResponse.data.shortURL:($scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",proposalDetailsEmail.paramMap.url=$scope.longURL),proposalDetailsEmail.username=$scope.proposerDetails.emailId.trim(),proposalDetailsEmail.paramMap.customerName=$scope.proposerDetails.firstName.trim()+" "+$scope.proposerDetails.lastName.trim(),proposalDetailsEmail.paramMap.selectedPolicyType=$scope.p365Labels.insuranceType.car,RestAPI.invoke($scope.p365Labels.transactionName.sendEmail,proposalDetailsEmail).then(function(emailResponse){emailResponse.responseCode,$scope.p365Labels.responseCode.success,$scope.sendSMS()})},$scope.hideModalIPOS=function(){$scope.modalIPOS=!1,1==$scope.redirectForPayment&&$scope.sendPaymentSuccessEmail()},$scope.hideModalAP=function(){$scope.modalAP=!1},$scope.resetCommunicationAddress=function(){"undefined"!=String($scope.proposerDetails.communicationAddress.comDisplayArea)&&0!=$scope.proposerDetails.communicationAddress.comDisplayArea.length||($scope.proposerDetails.communicationAddress.comPincode="",$scope.proposerDetails.communicationAddress.comState="",$scope.proposerDetails.communicationAddress.comCity="",$scope.proposerDetails.communicationAddress.comDoorNo="")},$scope.resetRegistrationAddress=function(){"undefined"!=String($scope.vehicleDetails.registrationAddress.regDisplayArea)&&0!=$scope.vehicleDetails.registrationAddress.regDisplayArea.length||($scope.vehicleDetails.registrationAddress.regPincode="",$scope.vehicleDetails.registrationAddress.regState="",$scope.vehicleDetails.registrationAddress.regCity="",$scope.vehicleDetails.registrationAddress.regDoorNo="")},$scope.PolicyTransaction={},$scope.proposerDetails={},$scope.proposerDetails.communicationAddress={},$scope.proposalRequest={},$scope.productType={},$scope.carrierPolicyUpdateReq={},$scope.communicationAddress={},$scope.nominationDetails={},$scope.vehicleDetails={},$scope.vehicleDetails.registrationAddress={},$scope.carProposalResponse={},$scope.paymentResponse={},$scope.carPolicyResponse={},$scope.vehicleInfo={},$scope.nominationInfo={},$scope.appointeeInfo={},$scope.appointeeDetails={},$scope.previousPolicyStatus={},$scope.authenticate={},$scope.vehicleInfo.insuranceType={},$scope.vehicleDetails.RTOCode={},$scope.insuranceDetails={},$scope.selectedProduct={},$scope.proposerInfo={},$scope.proposerInfo.drivingExp={},$scope.proposerInfo.vehicleDrivenOn={},$scope.quoteUserInfo={},$scope.request={},$scope.request.proposalId=$location.search().proposalId,$scope.request.businessLineId=$scope.p365Labels.businessLineType.car,$scope.premiumDetails={},$scope.selectedProductInputParam=[],$scope.selectedProductInputParam.vehicleInfo=[],$scope.relationList=[],$scope.nominationInfo=[],$scope.proposalStatus=[],$scope.insuranceInfo=[],$scope.undertakingStatus=[],$scope.proposalStatusForm=[],$scope.carProposeFormDetails={},$scope.genderType=genderTypeGeneric,$scope.maritalStatusType=maritalStatusListGeneric,$scope.purchasedLoanStatus=purchasedLoanStatusGeneric,$scope.vehicleLoanTypes=vehicleLoanTypes,$scope.drivingExpYearsList=drivingExperienceYears,$scope.vehicleDrivenOnList=vehicleDrivenPlaces,$scope.ncbList=buyScreenNcbList,$scope.mileageList=buyScreenMileageList,$scope.automobileMembershipList=automobileMembershipTypes,$scope.policyTypes=policyTypesGeneric,pospEnabled&&($scope.pospEnabled=pospEnabled),$scope.carQuoteRequestFormation=function(carQuoteRequestParam){$scope.quote={},$scope.quote.vehicleInfo={},$scope.quote.quoteParam={},$scope.quote.vehicleInfo.IDV=carQuoteRequestParam.vehicleInfo.IDV,$scope.quote.vehicleInfo.PreviousPolicyExpiryDate=carQuoteRequestParam.vehicleInfo.PreviousPolicyExpiryDate,$scope.quote.vehicleInfo.TPPolicyExpiryDate=carQuoteRequestParam.vehicleInfo.TPPolicyExpiryDate,$scope.quote.vehicleInfo.TPPolicyStartDate=carQuoteRequestParam.vehicleInfo.TPPolicyStartDate,$scope.quote.vehicleInfo.RTOCode=carQuoteRequestParam.vehicleInfo.RTOCode,$scope.quote.vehicleInfo.city=carQuoteRequestParam.vehicleInfo.city,carQuoteRequestParam.vehicleInfo.dateOfRegistration&&($scope.quote.vehicleInfo.dateOfRegistration=carQuoteRequestParam.vehicleInfo.dateOfRegistration),$scope.quote.vehicleInfo.idvOption=carQuoteRequestParam.vehicleInfo.idvOption,$scope.quote.vehicleInfo.best_quote_id=carQuoteRequestParam.vehicleInfo.best_quote_id,$scope.quote.vehicleInfo.previousClaim=carQuoteRequestParam.vehicleInfo.previousClaim,$scope.quote.vehicleInfo.registrationNumber=carQuoteRequestParam.vehicleInfo.registrationNumber,$scope.quote.vehicleInfo.registrationPlace=carQuoteRequestParam.vehicleInfo.registrationPlace,$scope.quote.vehicleInfo.state=carQuoteRequestParam.vehicleInfo.state,carQuoteRequestParam.vehicleInfo.make?$scope.quote.vehicleInfo.make=carQuoteRequestParam.vehicleInfo.make:carQuoteRequestParam.vehicleInfo.name&&($scope.quote.vehicleInfo.make=carQuoteRequestParam.vehicleInfo.name),$scope.quote.vehicleInfo.model=carQuoteRequestParam.vehicleInfo.model,carQuoteRequestParam.vehicleInfo.variant&&($scope.quote.vehicleInfo.variant=carQuoteRequestParam.vehicleInfo.variant.toString()),$scope.quote.vehicleInfo.fuel=carQuoteRequestParam.vehicleInfo.fuel,$scope.quote.vehicleInfo.cubicCapacity=carQuoteRequestParam.vehicleInfo.cubicCapacity,$scope.quote.quoteParam.ncb=carQuoteRequestParam.quoteParam.ncb,$scope.quote.quoteParam.ownedBy=carQuoteRequestParam.quoteParam.ownedBy,$scope.quote.quoteParam.policyType=carQuoteRequestParam.quoteParam.policyType,$scope.quote.quoteParam.riders=carQuoteRequestParam.quoteParam.riders},RestAPI.invoke("proposalDataReader",$scope.request).then(function(proposalDataResponse){if(proposalDataResponse.responsecode==$scope.p365Labels.responseCode.success){$scope.responseProduct=proposalDataResponse.data.PolicyTransaction,$rootScope.responseProduct=proposalDataResponse.data.PolicyTransaction,proposalDataResponse.data.PolicyTransaction.breakInInspectionStatus&&($scope.breakInInspectionStatus=proposalDataResponse.data.PolicyTransaction.breakInInspectionStatus),$rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($rootScope.iquoteRedirectionURL="/sharefromAPI",$scope.isIquoteEnabled=!1,$rootScope.iquoteRequestParam={lob:$scope.p365Labels.businessLineType.bike,createLeadFlag:$location.search().createLeadFlag,leaddetails:$location.search().leaddetails,orgName:$location.search().orgName},$scope.responseProduct.encryptedQuoteId?$rootScope.iquoteRequestParam.docId=$scope.responseProduct.encryptedQuoteId:$rootScope.iquoteRequestParam.docId=$scope.responseProduct.QUOTE_ID,$rootScope.iposRedirectionURL="/proposalresdata",$rootScope.iposRequestParam={proposalId:$location.search().proposalId,messageId:$location.search().messageId,leaddetails:$location.search().leaddetails,orgName:$location.search().orgName},$rootScope.mainTabsMenu=[{url:$rootScope.iquoteRedirectionURL,requestParam:$rootScope.iquoteRequestParam,className:"iQuoteTab tabs wp_border32",name:"iquote",title:"iQuote",active:$scope.isIquoteEnabled},{url:$rootScope.iposRedirectionURL,requestParam:$rootScope.iposRequestParam,className:"iPosTab tabs wp_border32",name:"ipos",title:"iPos",active:!$scope.isIquoteEnabled}]),$scope.carProposeFormDetails.carrierId=$scope.responseProduct.carrierId,$scope.carProposeFormDetails.productId=$scope.responseProduct.productId,$scope.carProposeFormDetails.QUOTE_ID=$scope.responseProduct.QUOTE_ID,$scope.carProposeFormDetails.businessLineId=$scope.p365Labels.businessLineType.car,messageIDVar=$scope.responseProduct.messageId,campaign_id=$scope.responseProduct.campaign_id,requestSource=$scope.responseProduct.requestSource,sourceOrigin=$scope.responseProduct.source,$scope.selectedProduct.userName=$scope.responseProduct.userName,$scope.selectedProduct.agencyId=$scope.responseProduct.agencyId,$scope.carProposeFormDetails.agencyId=$scope.responseProduct.agencyId,$scope.carProposeFormDetails.userName=$scope.responseProduct.userName,$scope.selectedProduct.grossPremium=$scope.responseProduct.proposalRequest.premiumDetails.grossPremium,$scope.responseProduct.referralCode&&($scope.referralCode=$scope.responseProduct.referralCode);var buyScreenParam={documentType:"proposalScreenConfig"};buyScreenParam.businessLineId=Number($scope.p365Labels.businessLineType.car),buyScreenParam.carrierId=$scope.responseProduct.carrierId,buyScreenParam.productId=$scope.responseProduct.productId,getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.productDataReader,buyScreenParam,function(buyScreen){if(buyScreen.responseCode==$scope.p365Labels.responseCode.success){var buyScreens=buyScreen.data;$scope.ownerDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[0].template),$scope.nominationDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[1].template),$scope.prevPolicyDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[2].template),$scope.vehicleDetailsTemplate=$sce.trustAsHtml(buyScreens.templates[3].template),$scope.productValidation=buyScreens.validation,$scope.requestFormat=buyScreens.requestFormat,$scope.transactionName=buyScreens.transaction.proposalService.name,$scope.transactionSaveProposal="saveProposalService",$scope.transactionSubmitProposal="submitProposal",$scope.paymentURL=buyScreens.paymentUrl,$scope.productValidation.PUCValidation?$scope.PUCValidation=!0:$scope.PUCValidation=!1,getDocUsingIdQuoteDB(RestAPI,$scope.carProposeFormDetails.QUOTE_ID,function(quoteCalcDetails){var quoteCalcRequest={};if($scope.quoteCalcResponse=[],$scope.quoteCalcResponse=quoteCalcDetails.carQuoteResponse,quoteCalcRequest=quoteCalcDetails.carQuoteRequest,$scope.vehicleInfoCopy=quoteCalcRequest.vehicleInfo,quoteCalcDetails.carQuoteRequest.systemPolicyStartDate&&($scope.policyStartDate=quoteCalcDetails.carQuoteRequest.systemPolicyStartDate.sysPolicyStartDate,$scope.policyEndDate=quoteCalcDetails.carQuoteRequest.systemPolicyStartDate.sysPolicyEndDate),$scope.vehicleInfoCopy=quoteCalcRequest.vehicleInfo,$scope.vehicleInfo={},$scope.vehicleInfo.IDV=quoteCalcDetails.carQuoteRequest.vehicleInfo.IDV,$scope.vehicleInfo.PreviousPolicyExpiryDate=quoteCalcDetails.carQuoteRequest.vehicleInfo.PreviousPolicyExpiryDate,$scope.vehicleInfo.TPPolicyExpiryDate=quoteCalcDetails.carQuoteRequest.vehicleInfo.TPPolicyExpiryDate,$scope.vehicleInfo.TPPolicyStartDate=quoteCalcDetails.carQuoteRequest.vehicleInfo.TPPolicyStartDate,$scope.vehicleInfo.RTOCode=quoteCalcDetails.carQuoteRequest.vehicleInfo.RTOCode,$scope.vehicleInfo.city=quoteCalcDetails.carQuoteRequest.vehicleInfo.city,quoteCalcDetails.carQuoteRequest.vehicleInfo.dateOfRegistration){$scope.vehicleInfo.dateOfRegistration=quoteCalcDetails.carQuoteRequest.vehicleInfo.dateOfRegistration;var carRegistrationYearList=$scope.vehicleInfo.dateOfRegistration.split("/");$scope.vehicleDetails.regYear=carRegistrationYearList[2]}$scope.vehicleInfo.idvOption=quoteCalcDetails.carQuoteRequest.vehicleInfo.idvOption,$scope.vehicleInfo.best_quote_id=quoteCalcDetails.carQuoteRequest.vehicleInfo.best_quote_id,$scope.vehicleInfo.previousClaim=quoteCalcDetails.carQuoteRequest.vehicleInfo.previousClaim,$scope.vehicleInfo.registrationNumber=quoteCalcDetails.carQuoteRequest.vehicleInfo.registrationNumber,$scope.vehicleInfo.registrationPlace=quoteCalcDetails.carQuoteRequest.vehicleInfo.registrationPlace,$scope.vehicleInfo.state=quoteCalcDetails.carQuoteRequest.vehicleInfo.state,quoteCalcDetails.carQuoteRequest.vehicleInfo.make?$scope.vehicleInfo.make=quoteCalcDetails.carQuoteRequest.vehicleInfo.make:quoteCalcDetails.carQuoteRequest.vehicleInfo.name&&($scope.vehicleInfo.make=quoteCalcDetails.carQuoteRequest.vehicleInfo.name),$scope.vehicleInfo.model=quoteCalcDetails.carQuoteRequest.vehicleInfo.model,quoteCalcDetails.carQuoteRequest.vehicleInfo.variant&&($scope.vehicleInfo.variant=quoteCalcDetails.carQuoteRequest.vehicleInfo.variant.toString()),$scope.vehicleInfo.cubicCapacity=quoteCalcDetails.carQuoteRequest.vehicleInfo.cubicCapacity,$scope.vehicleInfo.fuel=quoteCalcDetails.carQuoteRequest.vehicleInfo.fuel,$scope.quoteParam={},$scope.quoteParam.ncb=quoteCalcDetails.carQuoteRequest.quoteParam.ncb,$scope.quoteParam.ownedBy=quoteCalcDetails.carQuoteRequest.quoteParam.ownedBy,$scope.quoteParam.policyType=quoteCalcDetails.carQuoteRequest.quoteParam.policyType,$scope.quoteParam.riders=quoteCalcDetails.carQuoteRequest.quoteParam.riders,$scope.quote={},$scope.quote.quoteParam=$scope.quoteParam,$scope.quote.vehicleInfo=$scope.vehicleInfo,$scope.prevPolDetails={},$scope.prevPolDetails.prevPolicyStartDate=quoteCalcDetails.carQuoteRequest.vehicleInfo.PreviousPolicyStartDate,$scope.prevPolDetails.prevPolicyEndDate=$scope.vehicleInfo.PreviousPolicyExpiryDate,quoteCalcRequest.carrierId=$scope.responseProduct.carrierId,quoteCalcRequest.productId=$scope.responseProduct.productId;for(var i=0;i<$scope.quoteCalcResponse.length;i++)if($scope.quoteCalcResponse[i].carrierId==$scope.responseProduct.proposalRequest.premiumDetails.carrierId&&$scope.quoteCalcResponse[i].productId==$scope.responseProduct.proposalRequest.premiumDetails.productId){$scope.premiumDetails.selectedProductDetails=$scope.quoteCalcResponse[i],$scope.selectedProduct=$scope.premiumDetails.selectedProductDetails;break}$scope.changeInsuranceCompany=function(){$scope.selectedProduct=$scope.premiumDetails.selectedProductDetails,$scope.responseProduct.proposalRequest.premiumDetails=$scope.selectedProduct,$scope.changeCompanyName=!0},quoteCalcRequest.quoteParam.userIdv=parseInt($scope.responseProduct.proposalRequest.premiumDetails.insuredDeclareValue),localStorageService.set("carQuoteInputParamaters",quoteCalcRequest),$scope.productValidation.reQuoteCalc?(quoteCalcRequest.vehicleInfo.IDV_QUOTE_ID||(quoteCalcRequest.vehicleInfo.IDV_QUOTE_ID=quoteCalcRequest.QUOTE_ID),localStorageService.set("CAR_IDV_QUOTE_ID",quoteCalcRequest.QUOTE_ID),$scope.carQuoteRequestFormation(quoteCalcRequest),RestAPI.invoke($scope.p365Labels.getRequest.quoteCar,$scope.quote).then(function(proposeFormResponse){$scope.carRecalculateQuoteRequest=[],proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1?($scope.responseRecalculateCodeList=[],$scope.responseProduct.QUOTE_ID=proposeFormResponse.QUOTE_ID,localStorageService.set("QUOTE_ID",proposeFormResponse.QUOTE_ID),$scope.carRecalculateQuoteRequest=proposeFormResponse.data,$scope.quoteCalcResponse=[],angular.forEach($scope.carRecalculateQuoteRequest,function(obj,i){var request={},header={};header.transactionName=$scope.p365Labels.transactionName.carQuoteResult,header.deviceId=deviceIdOrigin,request.header=header,request.body=obj,$http({method:"POST",url:getQuoteCalcLink,data:request}).success(function(callback,status){var carQuoteResponse=JSON.parse(callback);$scope.responseRecalculateCodeList.push(carQuoteResponse.responseCode),carQuoteResponse.responseCode==$scope.p365Labels.responseCode.success1?null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0]&&(carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId&&($scope.loading=!1,$scope.premiumDetails.selectedProductDetails=carQuoteResponse.data.quotes[0],$scope.selectedProduct=carQuoteResponse.data.quotes[0],$scope.proposalDataReader()),carQuoteResponse.data.quotes[0].id=carQuoteResponse.messageId,Number(carQuoteResponse.data.quotes[0].grossPremium)>0&&$scope.quoteCalcResponse.push(carQuoteResponse.data.quotes[0])):null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0]&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId&&($scope.loading=!1,$scope.propScreenError=$scope.p365Labels.validationMessages.generalisedErrMsg,$scope.modalPropScreenError=!0)})}),$scope.loading=!1):($scope.propScreenError=$scope.p365Labels.validationMessages.generalisedErrMsg,$scope.modalPropScreenError=!0,$scope.loading=!1)})):$scope.proposalDataReader()})}}),$scope.redirectToQuote=function(){$location.path("/quote")}}else{$scope.loading=!1;var buyScreenCnfrmError=$scope.p365Labels.validationMessages.buyScreenCnfrmError.replace("INSURER_NAME",$scope.selectedProduct.insuranceCompany);$rootScope.P365Alert("Policies365",buyScreenCnfrmError,"Ok")}$scope.proposalDataReader=function(){if(getDocUsingId(RestAPI,"relationshipdetailslist",function(relationList){$scope.relationList=relationList.relationships,getListFromDB(RestAPI,"",carCarrier,findAppConfig,function(carCarrierList){carCarrierList.responseCode==$scope.p365Labels.responseCode.success&&($scope.carrierList=carCarrierList.data)})}),$rootScope.loading=!1,$scope.responseProduct.proposalRequest.insuranceDetails.policyNumber||($scope.isPolicyNumber=!1),$scope.responseProduct.proposalRequest.insuranceDetails&&($scope.insuranceDetails.insurerName=$scope.responseProduct.proposalRequest.insuranceDetails.insurerName,$scope.insuranceDetails.insuranceType=$scope.responseProduct.proposalRequest.insuranceDetails.insuranceType,$scope.insuranceDetails.prevPolicyType=$scope.responseProduct.proposalRequest.insuranceDetails.prevPolicyType,$scope.insuranceDetails.policyNumber=$scope.responseProduct.proposalRequest.insuranceDetails.policyNumber,$scope.insuranceDetails.insurerId=$scope.responseProduct.proposalRequest.insuranceDetails.insurerId,$scope.insuranceDetails.ncb=$scope.responseProduct.proposalRequest.insuranceDetails.ncb),"new"==$scope.insuranceDetails.insuranceType?$scope.previousPolicyStatus=!1:$scope.previousPolicyStatus=!0,console.log("$scope.insuranceDetails is : ",$scope.insuranceDetails),$scope.responseProduct.personalDetailsFlag?$scope.personalDetailsFlag=$scope.responseProduct.personalDetailsFlag:$scope.personalDetailsFlag=!0,$scope.responseProduct.organizationDetails&&($scope.organizationDetails.contactPersonName=$scope.responseProduct.organizationDetails.contactPersonName,$scope.organizationDetails.organizationName=$scope.responseProduct.organizationDetails.organizationName),$scope.responseProduct.proposalRequest.proposerDetails&&($scope.responseProduct.proposalRequest.proposerDetails.drivingExp&&($scope.proposerDetails.drivingExp=$scope.responseProduct.proposalRequest.proposerDetails.drivingExp.display),$scope.responseProduct.proposalRequest.proposerDetails.vehicleDrivenOn&&($scope.proposerDetails.vehicleDrivenOn=$scope.responseProduct.proposalRequest.proposerDetails.vehicleDrivenOn.name),$scope.proposerDetails.firstName=$scope.responseProduct.proposalRequest.proposerDetails.firstName,$scope.proposerDetails.lastName=$scope.responseProduct.proposalRequest.proposerDetails.lastName,$scope.proposerDetails.emailId=$scope.responseProduct.proposalRequest.proposerDetails.emailId,$scope.proposerDetails.mobileNumber=$scope.responseProduct.proposalRequest.proposerDetails.mobileNumber,$scope.proposerDetails.maritalStatus=$scope.responseProduct.proposalRequest.proposerDetails.maritalStatus,$scope.proposerDetails.dateOfBirth=$scope.responseProduct.proposalRequest.proposerDetails.dateOfBirth,$scope.proposerDetails.gender=$scope.responseProduct.proposalRequest.proposerDetails.gender,$scope.proposerDetails.personAge=$scope.responseProduct.proposalRequest.proposerDetails.personAge,$scope.proposerDetails.salutation=$scope.responseProduct.proposalRequest.proposerDetails.salutation,$scope.responseProduct.proposalRequest.proposerDetails.panNumber&&($scope.proposerDetails.panNumber=$scope.responseProduct.proposalRequest.proposerDetails.panNumber),$scope.responseProduct.proposalRequest.proposerDetails.communicationAddress&&($scope.proposerDetails.communicationAddress={},$scope.proposerDetails.communicationAddress.comDisplayArea=$scope.responseProduct.proposalRequest.proposerDetails.communicationAddress.comDisplayArea,$scope.proposerDetails.communicationAddress.comPincode=$scope.responseProduct.proposalRequest.proposerDetails.communicationAddress.comPincode,$scope.proposerDetails.communicationAddress.comCity=$scope.responseProduct.proposalRequest.proposerDetails.communicationAddress.comCity,$scope.proposerDetails.communicationAddress.comState=$scope.responseProduct.proposalRequest.proposerDetails.communicationAddress.comState,$scope.proposerDetails.communicationAddress.comDoorNo=$scope.responseProduct.proposalRequest.proposerDetails.communicationAddress.comDoorNo),$scope.quoteUserInfo.firstName=$scope.proposerDetails.firstName,$scope.quoteUserInfo.lastName=$scope.proposerDetails.lastName,$scope.quoteUserInfo.emailId=$scope.proposerDetails.emailId,$scope.quoteUserInfo.mobileNumber=$scope.proposerDetails.mobileNumber,$scope.quoteUserInfo.termsCondition=!0,localStorageService.set("quoteUserInfo",$scope.quoteUserInfo)),$scope.previousPolicyStatus){if($scope.insuranceDetails.policyNumber=$scope.responseProduct.proposalRequest.insuranceDetails.policyNumber,$scope.insuranceInfo.insurerName=$scope.responseProduct.proposalRequest.insuranceDetails.insurerName,$scope.responseProduct.proposalRequest.insuranceDetails.insurerName){var insurerName={};insurerName.carrierName=$scope.responseProduct.proposalRequest.insuranceDetails.insurerName,insurerName.carrierId=$scope.responseProduct.proposalRequest.insuranceDetails.insurerId,$scope.insuranceInfo.insurerName=insurerName}}else $scope.insuranceDetails.policyNumber="",$scope.insuranceInfo.insurerName="";$scope.selectedProduct.grossPremium&&($scope.panCardStaus=Number($scope.selectedProduct.grossPremium)>=1e5),$rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled&&($scope.screenOneStatus=!0,$scope.screenTwoStatus=!0,"renew"==$scope.insuranceDetails.insuranceType&&($scope.screenThreeStatus=!0,$scope.Section3Inactive=!1),$scope.screenFourStatus=!0,$scope.proceedPaymentStatus=!0,$scope.Section1Inactive=!1,$scope.Section2Inactive=!0,$scope.Section3Inactive=!0,$scope.Section4Inactive=!0,$scope.accordion="1");var polStartDateOption={minimumYearLimit:"+0D"};polStartDateOption.maximumYearLimit="+"+$scope.productValidation.policyStartDateLimit+"D",polStartDateOption.changeMonth=!0,polStartDateOption.changeYear=!0,polStartDateOption.dateFormat="dd/mm/yy",$scope.polStartDateOptions=setP365DatePickerProperties(polStartDateOption);var proposerDOBOption={};proposerDOBOption.minimumYearLimit="-"+$scope.productValidation.proposerDateOfBirthMaxLimit+"Y",proposerDOBOption.maximumYearLimit="-"+$scope.productValidation.proposerDateOfBirthMinLimit+"Y",proposerDOBOption.changeMonth=!0,proposerDOBOption.changeYear=!0,proposerDOBOption.dateFormat="dd/mm/yy",$scope.proposerDOBOptions=setP365DatePickerProperties(proposerDOBOption);var nomineeDOBOption={};if(nomineeDOBOption.minimumYearLimit="-"+$scope.productValidation.proposerDateOfBirthMaxLimit+"Y",nomineeDOBOption.maximumYearLimit="-1Y",nomineeDOBOption.changeMonth=!0,nomineeDOBOption.changeYear=!0,nomineeDOBOption.dateFormat="dd/mm/yy",$scope.nomineeDOBOptions=setP365DatePickerProperties(nomineeDOBOption),$scope.responseProduct.proposalRequest.nominationDetails&&($scope.nominationDetails.nomFirstName=$scope.responseProduct.proposalRequest.nominationDetails.nomFirstName,$scope.nominationDetails.nomLastName=$scope.responseProduct.proposalRequest.nominationDetails.nomLastName,$scope.nominationDetails.nomDateOfBirth=$scope.responseProduct.proposalRequest.nominationDetails.nomDateOfBirth,$scope.responseProduct.proposalRequest.nominationDetails.nomPersonAge&&($scope.nominationDetails.nomPersonAge=$scope.responseProduct.proposalRequest.nominationDetails.nomPersonAge),$scope.responseProduct.proposalRequest.nominationDetails&&($scope.nominationInfo.nominationRelation={},$scope.nominationInfo.nominationRelation.relationship=$scope.responseProduct.proposalRequest.nominationDetails.nominationRelation,$scope.nominationInfo.nominationRelation.relationshipId=$scope.responseProduct.proposalRequest.nominationDetails.nominationRelationId),$scope.responseProduct.proposalRequest.nominationDetails.nomPersonAge<18?$scope.appointeeStatus=!0:$scope.appointeeStatus=!1,$scope.appointeeStatus&&($scope.appointeeDetails.appointeeFirstName=$scope.responseProduct.proposalRequest.appointeeDetails.appointeeFirstName,$scope.appointeeDetails.appointeeLastName=$scope.responseProduct.proposalRequest.appointeeDetails.appointeeLastName,$scope.appointeeDetails.appointeeDateOfBirth=$scope.responseProduct.proposalRequest.appointeeDetails.appointeeDateOfBirth,$scope.responseProduct.proposalRequest.appointeeDetails.appointeeRelation&&($scope.appointeeInfo.appointeeRelation={},$scope.appointeeInfo.appointeeRelation.relationship=$scope.responseProduct.proposalRequest.appointeeDetails.appointeeRelation,$scope.appointeeInfo.appointeeRelation.relationshipId=$scope.responseProduct.proposalRequest.appointeeDetails.appointeeRelationId))),$scope.responseProduct.proposalRequest.vehicleDetails){if($scope.responseProduct.proposalRequest.vehicleDetails.registrationNumber){var formatRegisCode=$scope.responseProduct.proposalRequest.vehicleDetails.registrationNumber;$scope.vehicleInfo.registrationNumber=formatRegisCode.substring(4)}$scope.selectedProductInputParam.vehicleInfo.name=$scope.responseProduct.proposalRequest.vehicleDetails.make,$scope.selectedProductInputParam.vehicleInfo.model=$scope.responseProduct.proposalRequest.vehicleDetails.model,$scope.selectedProductInputParam.vehicleInfo.variant=$scope.responseProduct.proposalRequest.vehicleDetails.variant,$scope.displayRegistrationDate=$scope.responseProduct.proposalRequest.vehicleDetails.registrationDate;var regDate=$scope.vehicleInfo.dateOfRegistration.split("/");if($scope.displayRegistrationDate=regDate[0]+"-"+monthListGeneric[Number(regDate[1])-1]+"-"+regDate[2],$scope.vehicleInfo.manufacturingYear=regDate[2],$scope.responseProduct.proposalRequest.vehicleDetails.registrationNumber){formatRegisCode=$scope.responseProduct.proposalRequest.vehicleDetails.registrationNumber;$scope.vehicleInfo.registrationNumber=formatRegisCode.substring(4)}$scope.vehicleDetails.RTOCode=$scope.responseProduct.proposalRequest.vehicleDetails.RTOCode,$scope.vehicleDetails.engineNumber=$scope.responseProduct.proposalRequest.vehicleDetails.engineNumber,$scope.vehicleDetails.chassisNumber=$scope.responseProduct.proposalRequest.vehicleDetails.chassisNumber,$scope.vehicleDetails.registrationNumber=$scope.responseProduct.proposalRequest.vehicleDetails.registrationNumber,$scope.vehicleDetails.isVehicleAddressSameAsCommun=$scope.responseProduct.proposalRequest.vehicleDetails.isVehicleAddressSameAsCommun,$scope.vehicleDetails.registrationAddress={},$scope.vehicleDetails.registrationAddress.regDoorNo=$scope.responseProduct.proposalRequest.vehicleDetails.registrationAddress.regDoorNo,$scope.vehicleDetails.registrationAddress.regDisplayArea=$scope.responseProduct.proposalRequest.vehicleDetails.registrationAddress.regDisplayArea,$scope.vehicleDetails.registrationAddress.regPincode=$scope.responseProduct.proposalRequest.vehicleDetails.registrationAddress.regPincode,$scope.vehicleDetails.registrationAddress.regCity=$scope.responseProduct.proposalRequest.vehicleDetails.registrationAddress.regCity,$scope.vehicleDetails.registrationAddress.regState=$scope.responseProduct.proposalRequest.vehicleDetails.registrationAddress.regState,$scope.responseProduct.proposalRequest.vehicleDetails.purchasedLoan?$scope.vehicleDetails.purchasedLoan=$scope.responseProduct.proposalRequest.vehicleDetails.purchasedLoan:($scope.vehicleInfo.vehicleLoanType="",$scope.vehicleDetails.purchasedLoan=$scope.responseProduct.proposalRequest.vehicleDetails.purchasedLoan),$scope.responseProduct.proposalRequest.vehicleDetails.financeInstitutionCode&&($scope.vehicleDetails.financeInstitutionCode=$scope.responseProduct.proposalRequest.vehicleDetails.financeInstitutionCode),$scope.responseProduct.proposalRequest.vehicleDetails.financeInstitution&&($scope.vehicleDetails.financeInstitution=$scope.responseProduct.proposalRequest.vehicleDetails.financeInstitution)}$scope.getFinancialInstituteList=function(instituteName){var carrierId=$scope.responseProduct.carrierId;return $http.get(getSearchServiceLink+"CarrierLoanFinancer&q="+instituteName+"&id="+carrierId).then(function(financeInstituteList){return JSON.parse(financeInstituteList.data).data})},$scope.onFinancialInstitute=function(item){$scope.vehicleDetails.financeInstitutionId=item.financerId,$scope.loadPlaceholder()},$scope.loadPlaceholder=function(){setTimeout(function(){$(".buyform-control").on("focus blur",function(e){$(this).parents(".buyform-group").toggleClass("focusedInput","focus"===e.type||this.value.length>0)}).trigger("blur")},100)};var vehicleDrivenOn={};vehicleDrivenOn.name=$scope.responseProduct.proposalRequest.proposerDetails.vehicleDrivenOn,$scope.proposerInfo.vehicleDrivenOn=vehicleDrivenOn,$scope.proposerInfo.vehicleDrivenOn&&($scope.proposerDetails.vehicleDrivenOn=$scope.proposerInfo.vehicleDrivenOn);var drivingExp={};$scope.responseProduct.proposalRequest.proposerDetails.drivingExp&&(drivingExp.display=$scope.responseProduct.proposalRequest.proposerDetails.drivingExp,$scope.proposerInfo.drivingExp=drivingExp,$scope.proposerDetails.drivingExp=$scope.proposerInfo.drivingExp),$scope.changeDrivingExp=function(){$scope.proposerDetails.drivingExp=$scope.proposerInfo.drivingExp.display},$scope.changeVehicleDrivenOn=function(){$scope.proposerDetails.vehicleDrivenOn=$scope.proposerInfo.vehicleDrivenOn.name},$scope.changePrevInsurer=function(){$scope.insuranceDetails.insurerName=$scope.insuranceInfo.insurerName.carrierName,$scope.insuranceDetails.insurerId=$scope.insuranceInfo.insurerName.carrierId},$scope.changeVehicleLoanType=function(){$scope.vehicleDetails.vehicleLoanType=$scope.vehicleInfo.vehicleLoanType.name},$scope.pucStatus=!0,$scope.undertakingStatus=!0,$scope.proposalStatusform=!0,null!=$scope.responseProduct.carProposalResponse&&($scope.proposalStatus.statusDateProp=$scope.responseProduct.carProposalResponse.updatedDate,$scope.proposalStatus.statusProp="completed",$scope.responseProduct.carProposalResponse.inspectionReferenceNo&&(inspectionNumber=$scope.responseProduct.carProposalResponse.inspectionReferenceNo)),null!=$scope.responseProduct.paymentResponse?1==$scope.responseProduct.paymentResponse.transactionStatusCode?($scope.proposalStatus.statusDatePaym=$scope.responseProduct.paymentResponse.updatedDate,$scope.proposalStatus.statusPaym="completed",$scope.disablePaymentButton=!0,$scope.disableAllFields=function(){setTimeout(function(){$("form md-option").attr("disabled","disabled"),$("form md-select").attr("disabled","disabled"),$("input").attr("disabled","disabled"),$("md-radio-button").attr("disabled","disabled"),$("md-checkbox").attr("disabled","disabled"),$scope.vehicleDetailsForm.$invalid=!0},1e3)}):0==$scope.responseProduct.paymentResponse.transactionStatusCode?($scope.proposalStatus.statusDatePaym=$scope.responseProduct.paymentResponse.updatedDate,$scope.proposalStatus.statusPaym="failed"):$scope.proposalStatusform=!1:($scope.proposalStatus.statusPaym="pending",$scope.proposalStatus.statusPoli="pending"),null!=$scope.responseProduct.carPolicyResponse&&(1==$scope.responseProduct.carPolicyResponse.transactionStatusCode?($scope.proposalStatus.statusDatePoli=$scope.responseProduct.carPolicyResponse.updatedDate,$scope.proposalStatus.statusPoli="completed"):0==$scope.responseProduct.carPolicyResponse.transactionStatusCode&&($scope.proposalStatus.statusDatePoli=$scope.responseProduct.carPolicyResponse.updatedDate,$scope.proposalStatus.statusPoli="failed")),$scope.validatePolicyStartDate=function(){"undefined"!==String($scope.policyStartDate)&&(convertStringFormatToDate($scope.policyStartDate,function(formattedPolStartDate){if($scope.selectedProduct.ownDamagePolicyTerm&&($scope.insuranceDetails.ODPolicyStartDate=$scope.policyStartDate),"renew"==$scope.vehicleInfo.insuranceType.value)var polEndDate=new Date(formattedPolStartDate.setFullYear(formattedPolStartDate.getFullYear()+1));else polEndDate=new Date(formattedPolStartDate.setFullYear(formattedPolStartDate.getFullYear()+3));polEndDate=new Date(polEndDate.setDate(polEndDate.getDate()-1)),convertDateFormatToString(polEndDate,function(formattedPolEndDate){$scope.insuranceDetails.policyEndDate=formattedPolEndDate;var tempPolicyEndDate=$scope.insuranceDetails.policyEndDate.split("/"),PolicyEndDate=tempPolicyEndDate[1]+"/"+tempPolicyEndDate[0]+"/"+tempPolicyEndDate[2],polStartDateOption={};polStartDateOption.minimumDateLimit=PolicyEndDate,polStartDateOption.maximumYearLimit="+"+$scope.productValidation.vehicleAutoMemberExpDateLimit+"Y",polStartDateOption.changeMonth=!0,polStartDateOption.changeYear=!0,polStartDateOption.dateFormat="dd/mm/yy",$scope.proposerAutoMemberExpDateOptions=setP365DatePickerProperties(polStartDateOption)})}),$scope.selectedProduct.ownDamagePolicyTerm&&convertStringFormatToDate($scope.insuranceDetails.ODPolicyStartDate,function(formattedODPolStartDate){var ODPolEndDate=new Date(formattedODPolStartDate.setFullYear(formattedODPolStartDate.getFullYear()+$scope.selectedProduct.ownDamagePolicyTerm));ODPolEndDate=new Date(ODPolEndDate.setDate(ODPolEndDate.getDate()-1)),convertDateFormatToString(ODPolEndDate,function(formattedODPolEndDate){$scope.insuranceDetails.ODPolicyEndDate=formattedODPolEndDate})}))},$scope.showAuthenticateForm=function(){var validateAuthParam={paramMap:{}};validateAuthParam.mobileNumber=$scope.proposerDetails.mobileNumber,validateAuthParam.funcType=$scope.p365Labels.functionType.optAuth,validateAuthParam.paramMap.OTP=$scope.p365Labels.functionType.otpGenerate,getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.sendSMS,validateAuthParam,function(createOTP){createOTP.responseCode==$scope.p365Labels.responseCode.success?($scope.createOTPError="",$scope.modalOTP=!0):createOTP.responseCode==$scope.p365Labels.responseCode.blockedMobile?($scope.createOTPError=createOTP.message,$scope.modalOTPError=!0):($scope.createOTPError=$scope.p365Labels.errorMessage.createOTP,$scope.modalOTPError=!0)})},$scope.hideModal=function(){$scope.modalOTP=!1,$scope.proceedPaymentStatus=!0,$scope.authenticate.enteredOTP=""},$scope.hideModalError=function(){$scope.modalOTPError=!1},$scope.resendOTP=function(){var validateAuthParam={paramMap:{}};validateAuthParam.mobileNumber=$scope.proposerDetails.mobileNumber,validateAuthParam.funcType=$scope.p365Labels.functionType.optAuth,validateAuthParam.paramMap.OTP=$scope.p365Labels.functionType.otpGenerate,getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.sendSMS,validateAuthParam,function(createOTP){createOTP.responseCode==$scope.p365Labels.responseCode.success?$scope.invalidOTPError="":$scope.invalidOTPError=$scope.p365Labels.errorMessage.createOTP})},$scope.sendProposalEmail=function(){var proposalDetailsEmail={paramMap:{}};proposalDetailsEmail.funcType=$scope.p365Labels.functionType.proposalDetailsTemplate,proposalDetailsEmail.username=$scope.proposerDetails.emailId.trim(),proposalDetailsEmail.isBCCRequired="Y",proposalDetailsEmail.paramMap.customerName=$scope.proposerDetails.firstName.trim()+" "+$scope.proposerDetails.lastName.trim(),proposalDetailsEmail.paramMap.selectedPolicyType=$scope.p365Labels.insuranceType.car,proposalDetailsEmail.paramMap.quoteId=$scope.responseToken.QUOTE_ID,proposalDetailsEmail.paramMap.premiumAmount=String($scope.selectedProduct.grossPremium),proposalDetailsEmail.paramMap.docId=$scope.responseToken.proposalId,proposalDetailsEmail.paramMap.LOB=String($scope.p365Labels.businessLineType.car),$scope.shortenURL?proposalDetailsEmail.paramMap.url=$scope.shortURLResponse.data.shortURL:($scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",proposalDetailsEmail.paramMap.url=$scope.longURL),RestAPI.invoke($scope.p365Labels.transactionName.sendEmail,proposalDetailsEmail).then(function(emailResponse){if(emailResponse.responseCode==$scope.p365Labels.responseCode.success)if($scope.sendSMS(),1==baseEnvEnabled&&1==agencyPortalEnabled){var frameURL=agencyPortalUrl+proposalDetailsEmail.paramMap.docId+"&lob="+proposalDetailsEmail.paramMap.LOB;$scope.URLforPayment=$sce.trustAsResourceUrl(frameURL),$scope.modalAP=!0,$scope.loading=!1}else $scope.redirectForPayment=!1,$scope.loading=!1,$scope.modalIPOS=!0;else scope.sendSMS(),$rootScope.P365Alert("Policies365",$scope.p365Labels.errorMessage.emailSentFailed,"Ok"),$scope.loading=!1})},$scope.submitProposalData=function(){if($scope.submitProposalClicked=!0,$scope.carProposeFormDetails={},$scope.carProposeFormDetails.proposerDetails=$scope.proposerDetails,$scope.carProposeFormDetails.nominationDetails=$scope.nominationDetails,$scope.carProposeFormDetails.appointeeDetails=$scope.appointeeDetails,$scope.carProposeFormDetails.insuranceDetails=$scope.insuranceDetails,$scope.createCarVehicleDetailsRequest(),$scope.carProposeFormDetails.carrierId=$scope.responseProduct.carrierId,$scope.carProposeFormDetails.productId=$scope.responseProduct.productId,$scope.carProposeFormDetails.QUOTE_ID=$scope.responseProduct.QUOTE_ID,$scope.carProposeFormDetails.businessLineId=$scope.p365Labels.businessLineType.car,$scope.carProposeFormDetails.personalDetailsFlag=$scope.personalDetailsFlag,$scope.breakInInspectionStatus&&($scope.carProposeFormDetails.breakInInspectionStatus=$scope.breakInInspectionStatus),$scope.carProposeFormDetails.organizationDetails={},$scope.personalDetailsFlag||($scope.carProposeFormDetails.organizationDetails.contactPersonName=$scope.organizationDetails.contactPersonName,$scope.carProposeFormDetails.organizationDetails.organizationName=$scope.organizationDetails.organizationName),$scope.loading=!0,$scope.saveProposal)RestAPI.invoke($scope.transactionSaveProposal,$scope.responseProduct).then(function(proposeFormResponse){proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success?($scope.proposalId=proposeFormResponse.data,localStorageService.set("proposalId",$scope.proposalId),$scope.loading=!1,$scope.saveProposal=!1,console.log("Proposal Created/Saved")):($scope.loading=!1,$scope.saveProposal=!1,console.log("Error in Proposal Creation/Saving"))});else{if("undefined"!=String($scope.vehicleInfo.registrationNumber)&&null!=$scope.vehicleInfo.registrationNumber&&($scope.vehicleDetails.registrationNumber=$scope.vehicleDetails.RTOCode.toUpperCase()+$scope.vehicleInfo.registrationNumber.toUpperCase()),delete $scope.carProposeFormDetails.proposalId,$rootScope.agencyPortalEnabled){const localdata=JSON.parse(localStorage.getItem("finalLocalStorage"));$scope.carProposeFormDetails.requestSource=sourceOrigin,localdata&&($scope.carProposeFormDetails.userName=localdata.username,$scope.carProposeFormDetails.agencyId=localdata.agencyId,$scope.carProposeFormDetails.source=sourceOrigin),localStorage.getItem("desiSkillUniqueId")&&(localStorage.getItem("desiSkillUserId")&&($scope.carProposeFormDetails.userName=localStorage.getItem("desiSkillUserId")),$scope.carProposeFormDetails.agencyId=localStorage.getItem("desiSkillAgencyId"))}$scope.carProposeFormDetails.QUOTE_ID?RestAPI.invoke("carProposal",$scope.carProposeFormDetails).then(function(proposeFormResponse){if(proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1){console.log("Proposal updated"),$scope.responseToken=proposeFormResponse.data,$scope.responseToken.paymentGateway=$scope.paymentURL,$scope.responseToken.businessLineId=$scope.p365Labels.businessLineType.car,localStorageService.set("carReponseToken",$scope.responseToken),console.log("Payment service started");var encodeproposalID=String($scope.responseToken.proposalId);String($scope.p365Labels.businessLineType.car);if($scope.encryptedProposalId=proposeFormResponse.data.encryptedProposalId,localStorageService.set("proposalIdEncrypted",$scope.encryptedProposalId),console.log("$scope.encryptedProposalId",$scope.encryptedProposalId),$rootScope.encryptedProposalID=encodeproposalID,$rootScope.encryptedLOB=String($scope.p365Labels.businessLineType.car),1==imauticAutomation)imatCarProposal(localStorageService,$scope,"SubmitProposal",function(shortURLResponse){shortURLResponse.responseCode==$scope.p365Labels.responseCode.success?($scope.shortURLResponse=shortURLResponse,$scope.shortURLResponse.data.shortURL?$scope.shortenURL=$scope.shortURLResponse.data.shortURL:$scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",$scope.sendProposalEmail()):($scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",$scope.sendProposalEmail(),$scope.loading=!1),console.log("$scope.shortURLResponse in bike buy product is:",$scope.shortURLResponse)});else{console.log("Sending payment link to customer.");var body={};body.longURL=sharePaymentLink+String($scope.responseToken.proposalId)+"&lob="+String($scope.p365Labels.businessLineType.car),$scope.longURL=body.longURL,$http({method:"POST",url:getShortURLLink,data:body}).success(function(shortURLResponse){shortURLResponse.responseCode==$scope.p365Labels.responseCode.success?($scope.shortURLResponse=shortURLResponse,$scope.shortenURL=$scope.shortURLResponse.data.shortURL,$scope.sendProposalEmail()):($scope.longURL=""+sharePaymentLink+localStorageService.get("proposalIdEncrypted")+"&lob=3",$scope.sendProposalEmail(),$scope.loading=!1)})}}else if(proposeFormResponse.responseCode==$scope.p365Labels.responseCode.error||proposeFormResponse.responseCode==$scope.p365Labels.responseCode.error1||proposeFormResponse.responseCode==$scope.p365Labels.responseCode.serverError1)$scope.loading=!1,$rootScope.wordPressEnabled&&($scope.proceedPaymentStatus=!0),proposeFormResponse.responseCode,$scope.p365Labels.responseCode.serverError1,proposeFormResponse.message?$rootScope.P365Alert("Policies365",proposeFormResponse.message,"Ok"):$rootScope.P365Alert("Policies365",proposeFormResponse.data,"Ok");else if(proposeFormResponse.responseCode==$scope.p365Labels.responseCode.prevPolicyExpired)$scope.loading=!1,$scope.modalPrevPolExpiredError=!0,$scope.prevPolicyExpiredError=proposeFormResponse.message;else{1==imauticAutomation&&imatEvent("ProposalFailed"),$scope.loading=!1,$rootScope.wordPressEnabled&&($scope.proceedPaymentStatus=!0);proposeFormResponse.responseCode,$scope.p365Labels.validationMessages.buyScreenCnfrmError.replace("INSURER_NAME",$scope.selectedProduct.insuranceCompany);proposeFormResponse.message?$rootScope.P365Alert("Policies365",proposeFormResponse.message,"Ok"):$rootScope.P365Alert("Policies365",proposeFormResponse.data,"Ok")}}):($scope.loading=!1,$rootScope.P365Alert("Policies365",$scope.p365Labels.errorMessage.generalisedErrMsg,"Ok"))}},$scope.redirectToPaymentGateway=function(){$scope.paymentURLParam?$rootScope.affilateUser||$rootScope.agencyPortalEnabled?$window.top.location.href=$scope.paymentServiceResponse.paymentURL+$scope.paymentURLParam:$window.location.href=$scope.paymentServiceResponse.paymentURL+$scope.paymentURLParam:$timeout(function(){$scope.paymentForm.setAction($scope.paymentServiceResponse.paymentURL),$scope.paymentForm.commit(),$scope.$apply()},100)},$scope.proceedForPayment=function(){$scope.proceedPaymentStatus=!1,$scope.submitProposalClicked=!1,$scope.quoteUserInfo.firstName=$scope.proposerDetails.firstName,$scope.quoteUserInfo.lastName=$scope.proposerDetails.lastName,$scope.quoteUserInfo.emailId=$scope.proposerDetails.emailId,$scope.quoteUserInfo.mobileNumber=$scope.proposerDetails.mobileNumber,$scope.quoteUserInfo.termsCondition=!0,localStorageService.set("quoteUserInfo",$scope.quoteUserInfo),$scope.carProposeFormDetails={},$scope.proposerDetails.panNumber="undefined"!=String($scope.proposerDetails.panNumber)?$scope.proposerDetails.panNumber.toUpperCase():"",$scope.insuranceDetails.insuranceType=$scope.responseProduct.proposalRequest.insuranceDetails.insuranceType,$scope.responseProduct.userName&&($scope.selectedProduct.userName=$scope.responseProduct.userName,$scope.carProposeFormDetails.userName=$scope.responseProduct.userName),$scope.responseProduct.agencyId&&($scope.selectedProduct.agencyId=$scope.responseProduct.agencyId,$scope.carProposeFormDetails.agencyId=$scope.responseProduct.agencyId),$scope.carProposeFormDetails.proposerDetails=$scope.proposerDetails,$scope.carProposeFormDetails.nominationDetails=$scope.nominationDetails,$scope.carProposeFormDetails.organizationDetails={},$scope.personalDetailsFlag||($scope.carProposeFormDetails.organizationDetails.contactPersonName=$scope.organizationDetails.contactPersonName,$scope.carProposeFormDetails.organizationDetails.organizationName=$scope.organizationDetails.organizationName),$scope.carProposeFormDetails.appointeeDetails=$scope.appointeeDetails,$scope.carProposeFormDetails.insuranceDetails=$scope.insuranceDetails,$scope.createCarVehicleDetailsRequest(),$scope.referralCode&&($scope.carProposeFormDetails.referralCode=$scope.referralCode),$scope.carProposeFormDetails.carrierId=$scope.responseProduct.carrierId,$scope.carProposeFormDetails.productId=$scope.responseProduct.productId,localStorageService.get("CAR_UNIQUE_QUOTE_ID")?$scope.carProposeFormDetails.QUOTE_ID=localStorageService.get("CAR_UNIQUE_QUOTE_ID"):$scope.carProposeFormDetails.QUOTE_ID=$scope.responseProduct.QUOTE_ID,$scope.carProposeFormDetails.businessLineId=$scope.p365Labels.businessLineType.car,$rootScope.wordPressEnabled?$scope.carProposeFormDetails.source=sourceOrigin:($scope.carProposeFormDetails.requestSource=sourceOrigin,$scope.carProposeFormDetails.source=sourceOrigin),$scope.carProposeFormDetails.QUOTE_ID?($scope.loading=!0,RestAPI.invoke("carProposal",$scope.carProposeFormDetails).then(function(proposeFormResponse){$scope.modalOTP=!1,$scope.authenticate.enteredOTP="",$scope.modalOTPError=!1,$scope.proceedPaymentStatus=!0,proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1?($scope.proposalId=proposeFormResponse.data.proposalId,$scope.encryptedProposalId=proposeFormResponse.data.encryptedProposalId,localStorageService.set("proposalIdEncrypted",$scope.encryptedProposalId),console.log("$scope.encryptedProposalId",$scope.encryptedProposalId),1==imauticAutomation&&imatCarProposal(localStorageService,$scope,"MakePayment",function(shortURLResponse){}),$scope.responseToken=proposeFormResponse.data,$scope.responseToken.paymentGateway=$scope.paymentURL,$scope.responseToken.businessLineId=$scope.p365Labels.businessLineType.car,localStorageService.set("carReponseToken",$scope.responseToken),getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.paymentService,$scope.responseToken,function(paymentDetails){if(paymentDetails.responseCode==$scope.p365Labels.responseCode.success)if($scope.paymentServiceResponse=paymentDetails.data,"GET"==$scope.paymentServiceResponse.method){$scope.paymentURLParam="?";for(var paymentURLParamListLength=$scope.paymentServiceResponse.paramterList.length,i=0;i<paymentURLParamListLength;i++)$scope.paymentURLParam+=i<paymentURLParamListLength-1?$scope.paymentServiceResponse.paramterList[i].name+"="+$scope.paymentServiceResponse.paramterList[i].value+"&":$scope.paymentServiceResponse.paramterList[i].name+"="+$scope.paymentServiceResponse.paramterList[i].value;$scope.redirectForPayment=!0,$scope.loading=!1,$scope.modalIPOS=!0}else $scope.paymentURLParam=null,$scope.redirectForPayment=!0,$scope.loading=!1,$scope.modalIPOS=!0;else{$scope.loading=!1;var buyScreenCnfrmError=paymentDetails.responseCode+" : "+$scope.p365Labels.validationMessages.buyScreenCnfrmError.replace("INSURER_NAME",$scope.selectedProduct.insuranceCompany);$rootScope.P365Alert("Policies365",buyScreenCnfrmError,"Ok")}})):proposeFormResponse.responseCode==$scope.p365Labels.responseCode.error||proposeFormResponse.responseCode==$scope.p365Labels.responseCode.error1||proposeFormResponse.responseCode==$scope.p365Labels.responseCode.serverError1||proposeFormResponse.responseCode==$scope.p365Labels.responseCode.inspectionPending?($scope.loading=!1,proposeFormResponse.responseCode==$scope.p365Labels.responseCode.serverError1||(proposeFormResponse.responseCode,$scope.p365Labels.responseCode.inspectionPending),proposeFormResponse.message?$rootScope.P365Alert("Policies365",proposeFormResponse.message,"Ok"):$rootScope.P365Alert("Policies365",proposeFormResponse.data,"Ok")):proposeFormResponse.responseCode==$scope.p365Labels.responseCode.prevPolicyExpired?($scope.loading=!1,$scope.modalPrevPolExpiredError=!0,$scope.prevPolicyExpiredError=proposeFormResponse.message):(1==imauticAutomation&&imatEvent("ProposalFailed"),$scope.loading=!1,proposeFormResponse.message?$rootScope.P365Alert("Policies365",proposeFormResponse.message,"Ok"):$rootScope.P365Alert("Policies365",proposeFormResponse.data,"Ok"))})):($scope.proceedPaymentStatus=!0,proposeFormResponse.message?$rootScope.P365Alert("Policies365",proposeFormResponse.message,"Ok"):$rootScope.P365Alert("Policies365",proposeFormResponse.data,"Ok"))}},$scope.$watch("proposerDetails.communicationAddress.comDisplayArea",function(newValue){$scope.vehicleDetails.isVehicleAddressSameAsCommun&&$scope.changeRegAddress()}),$scope.$watch("proposerDetails.communicationAddress.comDoorNo",function(newValue){$scope.vehicleDetails.isVehicleAddressSameAsCommun&&$scope.changeRegAddress()}),$scope.$on("setCommAddressByAPI",function(){setTimeout(function(){var googleAddressObject=angular.copy($rootScope.chosenCommPlaceDetails);getAddressFields(googleAddressObject,function(fomattedAddress,formattedCity,formattedState,formattedPincode){$scope.proposerDetails.communicationAddress.comDisplayArea=fomattedAddress,"undefined"!=String(formattedPincode)&&""!=formattedPincode?$scope.calcDefaultAreaDetails(formattedPincode):($scope.proposerDetails.communicationAddress.comPincode="",$scope.proposerDetails.communicationAddress.comState="",$scope.proposerDetails.communicationAddress.comCity=""),$scope.$apply()})},10)}),$scope.$on("setRegAddressByAPI",function(){setTimeout(function(){var googleAddressObject=angular.copy($rootScope.chosenRegPlaceDetails);getAddressFields(googleAddressObject,function(fomattedAddress,formattedCity,formattedState,formattedPincode){$scope.vehicleDetails.registrationAddress.regDisplayArea=fomattedAddress,"undefined"!=String(formattedPincode)&&""!=formattedPincode?$scope.calcDefaultRegAreaDetails(formattedPincode):($scope.vehicleDetails.registrationAddress.regPincode="",$scope.vehicleDetails.registrationAddress.regState="",$scope.vehicleDetails.registrationAddress.regCity=""),$scope.$apply()})},10)}),$scope.calcDefaultAreaDetails=function(areaCode){if(null!=areaCode&&"undefined"!=String(areaCode)&&String(areaCode).length>0){var docType=$scope.p365Labels.documentType.cityDetails,carrierId=$scope.responseProduct.carrierId;$http.get(getSearchServiceLink+docType+"&q="+areaCode+"&id="+carrierId).then(function(response){var areaDetails=JSON.parse(response.data);areaDetails.responseCode==$scope.p365Labels.responseCode.success&&$scope.onSelectPinOrArea(areaDetails.data[0])})}},$scope.calcDefaultRegAreaDetails=function(areaCode){if(null!=areaCode&&"undefined"!=String(areaCode)&&String(areaCode).length>0){var docType=$scope.p365Labels.documentType.cityDetails,carrierId=$scope.responseProduct.carrierId;$http.get(getSearchServiceLink+docType+"&q="+areaCode+"&id="+carrierId).then(function(response){var areaDetails=JSON.parse(response.data);areaDetails.responseCode==$scope.p365Labels.responseCode.success&&$scope.onSelectVehiclePinOrArea(areaDetails.data[0])})}},$scope.onSelectPinOrArea=function(item){$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.selectedProductInputParamCopy=angular.copy($scope.selectedProductInputParam.vehicleInfo);var selState=$scope.selectedProductInputParam.vehicleInfo.state;$scope.proposerDetails.state=selState.toUpperCase(),$scope.proposerDetails.state!=item.state?($scope.selectedProductInputParam.vehicleInfo.state=item.state,$scope.selectedProductInputParam.vehicleInfo.city=item.city,$scope.proposerDetailsCopied=angular.copy(item),$rootScope.P365Confirm("Policies365","There is a change in location and premium would be re-calculated. Do you want to proceed?","No","Yes",function(confirmStatus){confirmStatus?($scope.loading=!0,$scope.carQuoteRequestFormation($scope.selectedProductInputParam),RestAPI.invoke($scope.p365Labels.getRequest.quoteCar,$scope.quote).then(function(proposeFormResponse){if($scope.carRecalculateQuoteRequest=[],proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1)$scope.responseRecalculateCodeList=[],localStorageService.set("CAR_UNIQUE_QUOTE_ID",proposeFormResponse.QUOTE_ID),localStorageService.set("CAR_UNIQUE_QUOTE_ID_ENCRYPTED",proposeFormResponse.encryptedQuoteId),$scope.responseProduct.QUOTE_ID=proposeFormResponse.QUOTE_ID,$scope.carRecalculateQuoteRequest=proposeFormResponse.data,$scope.quoteCalcResponse=[],angular.forEach($scope.carRecalculateQuoteRequest,function(obj,i){var request={},header={};header.transactionName=$scope.p365Labels.transactionName.carQuoteResult,header.deviceId=deviceIdOrigin,request.header=header,request.body=obj,$http({method:"POST",url:getQuoteCalcLink,data:request}).success(function(callback,status){var carQuoteResponse=JSON.parse(callback);if($scope.responseRecalculateCodeList.push(carQuoteResponse.responseCode),carQuoteResponse.responseCode==$scope.p365Labels.responseCode.success1)null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId&&($scope.loading=!1,$scope.premiumDetails.selectedProductDetails=carQuoteResponse.data.quotes[0],$scope.selectedProduct=carQuoteResponse.data.quotes[0]),carQuoteResponse.data.quotes[0].id=carQuoteResponse.messageId,$scope.quoteCalcResponse.push(carQuoteResponse.data.quotes[0]);else if(null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId){$scope.loading=!1,$scope.proposerDetails.pincode="";var screenCnfrmError=$scope.selectedProduct.insuranceCompany+" does not provide Insurance for the selected pincode of the owner. Please change the input or select any other insurer from the quote screen";$rootScope.P365Alert("Policies365",screenCnfrmError,"Ok")}}).error(function(data,status){$scope.responseRecalculateCodeList.push($scope.p365Labels.responseCode.systemError),$scope.loading=!1})});else{$scope.loading=!1,$scope.proposerDetails.communicationAddress.comPincode="";var screenCnfrmError=$scope.selectedProduct.insuranceCompany+" does not provide Insurance for the selected pincode of the owner. Please change the input or select any other insurer from the quote screen";$rootScope.P365Alert("Policies365",screenCnfrmError,"Ok")}}),$scope.proposerDetails.communicationAddress.comDisplayArea=item.address,$scope.proposerDetails.communicationAddress.comPincode=item.pincode,$scope.proposerDetails.communicationAddress.comCity=item.city,$scope.proposerDetails.communicationAddress.comState=item.state,$scope.checkForSameAddress()):($scope.proposerDetails.communicationAddress.comDisplayArea=$scope.selectedProductInputParamCopy.address,$scope.proposerDetails.communicationAddress.comPincode=$scope.selectedProductInputParamCopy.pincode,$scope.proposerDetails.communicationAddress.comCity=$scope.selectedProductInputParamCopy.city,$scope.proposerDetails.communicationAddress.comState=$scope.selectedProductInputParamCopy.state,$scope.checkForSameAddress())})):(item.address&&($scope.proposerDetails.communicationAddress.comDisplayArea=item.address),$scope.proposerDetails.communicationAddress.comPincode=item.pincode,$scope.proposerDetails.communicationAddress.comCity=item.city,$scope.proposerDetails.communicationAddress.comState=item.state,$scope.checkForSameAddress()),$scope.loadPlaceholder(),localStorageService.set("userGeoDetails",item)},$scope.checkForSameAddress=function(){$scope.vehicleDetails.isVehicleAddressSameAsCommun&&($scope.vehicleDetails.registrationAddress.regDoorNo=$scope.proposerDetails.communicationAddress.comDoorNo,$scope.vehicleDetails.registrationAddress.regDisplayArea=$scope.proposerDetails.communicationAddress.comDisplayArea,$scope.vehicleDetails.registrationAddress.regPincode=$scope.proposerDetails.communicationAddress.comPincode,$scope.vehicleDetails.registrationAddress.regCity=$scope.proposerDetails.communicationAddress.comCity,$scope.vehicleDetails.registrationAddress.regState=$scope.proposerDetails.communicationAddress.comState)},$scope.onSelectVehiclePinOrArea=function(item){item.address&&($scope.vehicleDetails.registrationAddress.regDisplayArea=item.address),$scope.vehicleDetails.registrationAddress.regPincode=item.pincode,$scope.vehicleDetails.registrationAddress.regCity=item.city,$scope.vehicleDetails.registrationAddress.regState=item.state,$scope.loadPlaceholder()},$scope.changeRegAddress=function(){$scope.vehicleDetails.isVehicleAddressSameAsCommun?($scope.vehicleDetails.registrationAddress.regDoorNo=$scope.proposerDetails.communicationAddress.comDoorNo,$scope.vehicleDetails.registrationAddress.regDisplayArea=$scope.proposerDetails.communicationAddress.comDisplayArea,$scope.vehicleDetails.registrationAddress.regPincode=$scope.proposerDetails.communicationAddress.comPincode,$scope.vehicleDetails.registrationAddress.regCity=$scope.proposerDetails.communicationAddress.comCity,$scope.vehicleDetails.registrationAddress.regState=$scope.proposerDetails.communicationAddress.comState):($scope.vehicleDetails.registrationAddress={},$scope.vehicleDetails.registrationAddress.regDisplayArea="",$scope.vehicleDetails.registrationAddress.regDoorNo="",$scope.vehicleDetails.registrationAddress.regPincode="",$scope.vehicleDetails.registrationAddress.regCity="",$scope.vehicleDetails.registrationAddress.regState="")},$scope.calcQuoteOnRegistrationNumber=function(regNumber){$scope.selectedProductInputParamCopy=angular.copy($scope.selectedProductInputParam),$scope.selectedProductInputParamCopy.vehicleInfo&&$scope.selectedProductInputParamCopy.vehicleInfo.registrationNumber?$scope.registrationNumberCopy=$scope.selectedProductInputParam.vehicleInfo.registrationNumber.toUpperCase():$scope.registrationNumberCopy="",$scope.newRegistrationNumber=$scope.vehicleDetails.RTOCode.toUpperCase()+regNumber.toUpperCase(),$scope.newRegistrationNumber!=$scope.registrationNumberCopy&&($scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.selectedProductInputParam.vehicleInfo.registrationNumber=$scope.newRegistrationNumber,$scope.selectedProductInputParamCopy.GSTIN&&($scope.selectedProductInputParam.GSTIN=$scope.selectedProductInputParamCopy.GSTIN),$rootScope.P365Confirm($scope.p365Labels.common.p365prompt,$scope.p365Labels.common.regNumberChangeMsg,"No","Yes",function(confirmStatus){if(confirmStatus)$scope.loading=!0,$scope.carQuoteRequestFormation($scope.selectedProductInputParam),RestAPI.invoke($scope.p365Labels.getRequest.quoteCar,$scope.quote).then(function(proposeFormResponse){if($scope.carRecalculateQuoteRequest=[],proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1)$scope.responseRecalculateCodeList=[],$scope.quoteCalcResponse=[],"undefined"!=String($scope.quoteCalcResponse)&&$scope.quoteCalcResponse.length>0&&($scope.quoteCalcResponse.length=0),localStorageService.set("CAR_UNIQUE_QUOTE_ID",proposeFormResponse.QUOTE_ID),localStorageService.set("CAR_UNIQUE_QUOTE_ID_ENCRYPTED",proposeFormResponse.encryptedQuoteId),$scope.carRecalculateQuoteRequest=proposeFormResponse.data,angular.forEach($scope.carRecalculateQuoteRequest,function(obj,i){var request={},header={};header.messageId=messageIDVar,header.campaignID=campaignIDVar,header.source=sourceOrigin,header.transactionName=getCarQuoteResult,header.deviceId=deviceIdOrigin,request.header=header,request.body=obj,$http({method:"POST",url:getQuoteCalcLink,data:request}).success(function(callback,status){var carQuoteResponse=JSON.parse(callback);if($scope.responseRecalculateCodeList.push(carQuoteResponse.responseCode),carQuoteResponse.responseCode==$scope.p365Labels.responseCode.success1)null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId&&($scope.loading=!1,$scope.selectedProductInputParamCopy=angular.copy($scope.selectedProductInputParam),$scope.premiumDetails.selectedProductDetails=carQuoteResponse.data.quotes[0],$scope.selectedProduct=carQuoteResponse.data.quotes[0]),$scope.quoteCalcResponse.push(carQuoteResponse.data.quotes[0]);else if($scope.loading=!1,null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId){$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.selectedProductInputParam.vehicleInfo.registrationNumber="",$scope.vehicleInfo.registrationNumber="",$scope.selectedProductInputParam.vehicleInfo.registrationNumber&&delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,localStorageService.set("carQuoteInputParamaters",$scope.selectedProductInputParam);var screenCnfrmError=$scope.selectedProduct.insuranceCompany+""+$scope.p365Labels.errorMessage.regNumberScreenConfirmErrorMsg;$rootScope.P365Alert($scope.p365Labels.common.p365prompt,screenCnfrmError,"Ok")}}).error(function(data,status){delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,$scope.responseRecalculateCodeList.push($scope.p365Labels.responseCode.systemError),$scope.loading=!1})});else{$scope.loading=!1,$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.vehicleInfo.registrationNumber="",$scope.selectedProductInputParam.vehicleInfo.registrationNumber&&delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,localStorageService.set("carQuoteInputParamaters",$scope.selectedProductInputParam);var screenCnfrmError=$scope.selectedProduct.insuranceCompany+""+$scope.p365Labels.errorMessage.regNumberScreenConfirmErrorMsg;$rootScope.P365Alert($scope.p365Labels.common.p365prompt,screenCnfrmError,"Ok")}});else if($scope.selectedProductInputParam.vehicleInfo=$scope.selectedProductInputParamCopy.vehicleInfo,$scope.selectedProductInputParam.vehicleInfo.registrationNumber){var formatVehicleCode=$scope.selectedProductInputParam.vehicleInfo.registrationNumber;$scope.vehicleInfo.registrationNumber=formatVehicleCode.substring(4)}else $scope.vehicleInfo.registrationNumber="",delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber}))},$scope.checkGSTINNumber=function(selGSTIN){$scope.productValidation.regNumberReQuoteCalc&&selGSTIN&&$scope.calcQuoteOnGSTINNumber(selGSTIN)},$scope.calcQuoteOnGSTINNumber=function(selGSTIN){$scope.selectedProductInputParamCopy=angular.copy($scope.selectedProductInputParam),$scope.selectedProductInputParamCopy.GSTIN?$scope.GSTINCopy=$scope.selectedProductInputParamCopy.GSTIN:$scope.GSTINCopy="",$scope.newGSTINNumber=selGSTIN,$scope.newGSTINNumber!=$scope.GSTINCopy&&($scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.selectedProductInputParam.GSTIN=$scope.newGSTINNumber,$scope.selectedProductInputParamCopy.vehicleInfo.registrationNumber&&($scope.selectedProductInputParam.vehicleInfo.registrationNumber=$scope.selectedProductInputParamCopy.vehicleInfo.registrationNumber),$rootScope.P365Confirm($scope.p365Labels.common.p365prompt,$scope.p365Labels.common.GSTINNumberChangeMsg,"No","Yes",function(confirmStatus){confirmStatus?($scope.loading=!0,$scope.carQuoteRequestFormation($scope.selectedProductInputParam),RestAPI.invoke($scope.p365Labels.getRequest.quoteCar,$scope.quote).then(function(proposeFormResponse){if($scope.carRecalculateQuoteRequest=[],proposeFormResponse.responseCode==$scope.p365Labels.responseCode.success1)$scope.responseRecalculateCodeList=[],$scope.quoteCalcResponse=[],"undefined"!=String($scope.quoteCalcResponse)&&$scope.quoteCalcResponse.length>0&&($scope.quoteCalcResponse.length=0),localStorageService.set("CAR_UNIQUE_QUOTE_ID",proposeFormResponse.QUOTE_ID),localStorageService.set("CAR_UNIQUE_QUOTE_ID_ENCRYPTED",proposeFormResponse.encryptedQuoteId),$scope.carRecalculateQuoteRequest=proposeFormResponse.data,angular.forEach($scope.carRecalculateQuoteRequest,function(obj,i){var request={},header={};header.messageId=messageIDVar,header.campaignID=campaignIDVar,header.source=sourceOrigin,header.transactionName=getCarQuoteResult,header.deviceId=deviceIdOrigin,request.header=header,request.body=obj,$http({method:"POST",url:getQuoteCalcLink,data:request}).success(function(callback,status){var carQuoteResponse=JSON.parse(callback);if($scope.responseRecalculateCodeList.push(carQuoteResponse.responseCode),carQuoteResponse.responseCode==$scope.p365Labels.responseCode.success1)null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId&&($scope.loading=!1,angular.copy($scope.selectedProductInputParam,$scope.selectedProductInputParamCopy),$scope.premiumDetails.selectedProductDetails=carQuoteResponse.data.quotes[0],$scope.selectedProduct=carQuoteResponse.data.quotes[0]),$scope.quoteCalcResponse.push(carQuoteResponse.data.quotes[0]);else if($scope.loading=!1,null!=carQuoteResponse.data&&carQuoteResponse.data.quotes[0].carrierId==$scope.responseProduct.carrierId&&carQuoteResponse.data.quotes[0].productId==$scope.responseProduct.productId){$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.selectedProductInputParam.vehicleInfo.registrationNumber="",$scope.vehicleInfo.registrationNumber="",$scope.proposerDetails.GSTIN="",$scope.selectedProductInputParam.vehicleInfo.registrationNumber&&delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,localStorageService.set("carQuoteInputParamaters",$scope.selectedProductInputParam);var screenCnfrmError=$scope.selectedProduct.insuranceCompany+""+$scope.p365Labels.errorMessage.GSTINNumberScreenConfirmErrorMsg;$rootScope.P365Alert($scope.p365Labels.common.p365prompt,screenCnfrmError,"Ok")}}).error(function(data,status){delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,$scope.proposerDetails.GSTIN="",$scope.responseRecalculateCodeList.push($scope.p365Labels.responseCode.systemError),$scope.loading=!1})});else{$scope.loading=!1,$scope.selectedProductInputParam=localStorageService.get("carQuoteInputParamaters"),$scope.vehicleInfo.registrationNumber="",$scope.proposerDetails.GSTIN="",$scope.selectedProductInputParam.vehicleInfo.registrationNumber&&delete $scope.selectedProductInputParam.vehicleInfo.registrationNumber,localStorageService.set("carQuoteInputParamaters",$scope.selectedProductInputParam);var screenCnfrmError=$scope.selectedProduct.insuranceCompany+""+$scope.p365Labels.errorMessage.GSTINNumberScreenConfirmErrorMsg;$rootScope.P365Alert($scope.p365Labels.common.p365prompt,screenCnfrmError,"Ok")}})):($scope.selectedProductInputParam=$scope.selectedProductInputParamCopy,$scope.selectedProductInputParam.GSTIN?$scope.proposerDetails.GSTIN=$scope.selectedProductInputParam.GSTIN:$scope.proposerDetails.GSTIN="")}))},$scope.checkForSameAddress=function(){$scope.vehicleDetails.isVehicleAddressSameAsCommun&&($scope.vehicleDetails.registrationAddress.regDoorNo=$scope.proposerDetails.communicationAddress.comDoorNo,$scope.vehicleDetails.registrationAddress.regDisplayArea=$scope.proposerDetails.communicationAddress.comDisplayArea,$scope.vehicleDetails.registrationAddress.regPincode=$scope.proposerDetails.communicationAddress.comPincode,$scope.vehicleDetails.registrationAddress.regCity=$scope.proposerDetails.communicationAddress.comCity,$scope.vehicleDetails.registrationAddress.regState=$scope.proposerDetails.communicationAddress.comState)},$scope.getPinCodeAreaList=function(searchValue){var docType=$scope.p365Labels.documentType.cityDetails,carrierId=$scope.responseProduct.carrierId;return $http.get(getSearchServiceLink+docType+"&q="+searchValue+"&id="+carrierId).then(function(response){return JSON.parse(response.data).data})},$scope.changeNomineeRelation=function(){"undefined"!=String($scope.nominationInfo.nominationRelation)&&($scope.nominationDetails.nominationRelation=$scope.nominationInfo.nominationRelation.relationship,$scope.nominationDetails.nominationRelationId=$scope.nominationInfo.nominationRelation.relationshipId),$scope.responseProduct.proposalRequest.nominationDetails&&($scope.nomineeDetailsForm.$dirty=!1)},$scope.changeAppointeeRelation=function(){"undefined"!=String($scope.appointeeInfo.appointeeRelation)&&($scope.appointeeDetails.appointeeRelation=$scope.appointeeInfo.appointeeRelation.relationship,$scope.appointeeDetails.appointeeRelationId=$scope.appointeeInfo.appointeeRelation.relationshipId)},$scope.validAppointeeRelation=function(relation){if("Y"==relation.isApointeeRelationship)return relation.relationship},$scope.validateNomineeDateOfBirth=function(){if($scope.nominationDetails.nomPersonAge=getAgeFromDOB($scope.nominationDetails.nomDateOfBirth),$scope.nominationDetails.nomPersonAge<18){$scope.appointeeStatus=!0;var appointeeDOBOption={};appointeeDOBOption.minimumYearLimit="-"+$scope.productValidation.proposerDateOfBirthMaxLimit+"Y",appointeeDOBOption.maximumYearLimit="-18Y",appointeeDOBOption.changeMonth=!0,appointeeDOBOption.changeYear=!0,appointeeDOBOption.dateFormat="dd/mm/yy",$scope.appointeeDOBOptions=setP365DatePickerProperties(appointeeDOBOption)}else $scope.appointeeStatus=!1;$scope.relationList=$scope.relationList},$scope.calculateAppointeeAge=function(){$scope.appointeeDetails.appointeePersonAge=getAgeFromDOB($scope.appointeeDetails.appointeeDateOfBirth)},$scope.calculateProposerAge=function(){$scope.proposerDetails.personAge=getAgeFromDOB($scope.proposerDetails.dateOfBirth)},$scope.validateAadhar=function(){$scope.proposerDetails.aadharNumber=$scope.proposerDetails.aadharNumber},$scope.validateGSTN=function(){$scope.proposerDetails.GSTN=$scope.proposerDetails.GSTN},$scope.validateRegistrationNumber=function(registrationNumber){"undefined"!=String(registrationNumber)&&((registrationNumber=registrationNumber.replace(/[^a-zA-Z0-9]/gi,"")).trim().match(/^[a-zA-Z]{0,3}[0-9]{1,4}$/)&&registrationNumber.trim().length<=7&&registrationNumber.trim().length>=2?($scope.regNumStatus=!1,$scope.vehicleDetailsForm.RegistrationNumber.$setValidity("RegistrationNumber",!0),$scope.productValidation.regNumberReQuoteCalc&&$scope.calcQuoteOnRegistrationNumber(registrationNumber)):($scope.regNumStatus=!0,$scope.vehicleDetailsForm.RegistrationNumber.$setValidity("RegistrationNumber",!1)),$scope.vehicleInfo.registrationNumber=registrationNumber.trim())}}),$scope.closeModal=function(){$scope.modalPrevPolExpiredError=!1},$scope.backToResultScreen=function(){if($rootScope.baseEnvEnabled&&!$rootScope.wordPressEnabled)$rootScope.mainTabsMenu[0].active=!0,$rootScope.mainTabsMenu[1].active=!1,$scope.carProposeFormDetails.UNIQUE_QUOTE_ID_ENCRYPTED?$location.path("/sharefromAPI").search({docId:$scope.carProposeFormDetails.UNIQUE_QUOTE_ID_ENCRYPTED,LOB:$scope.p365Labels.businessLineType.car}):$location.path("/sharefromAPI").search({docId:$scope.carProposeFormDetails.QUOTE_ID,LOB:$scope.p365Labels.businessLineType.car});else if($scope.carProposeFormDetails.UNIQUE_QUOTE_ID_ENCRYPTED){var shareURL=shareQuoteLink+$scope.carProposeFormDetails.UNIQUE_QUOTE_ID_ENCRYPTED;console.log("encrypted quote id found with share url as: ",shareURL),$window.location.href=shareURL}else{shareURL=shareQuoteLink+$scope.carProposeFormDetails.QUOTE_ID;console.log(" no encrypted quote id found with share url as: ",shareURL),$window.location.href=shareURL}}})}]);