"use strict";angular.module("paySuccessBike",["CoreComponentApp","LocalStorageModule","ngMessages"]).controller("paySuccessBikeController",["RestAPI","$scope","$rootScope","$location","$window","$http","localStorageService","$timeout","$sce",function(RestAPI,$scope,$rootScope,$location,$window,$http,localStorageService,$timeout,$sce){$scope.authenticate={};var proposalId="",bikeProposeFormDetails={},p365UIVar={mobileNumber:"+91 9962411255",mobileNumberTrim:"+919962411255",salesAssistNumber:"(022) 68284343",salesAssistNumberTrim:"02268284343",salesAssistNumberLanding:"022-68284343",claimsNumber:"(022) 42114299",claimsNumberTrim:"02242114299",claimsNumberLanding:"022-42114299",infoEmailId:"contact@policies365.com"};if($location.search().source&&"posp"==$location.search().source&&($scope.pospBackButtonEnabled=!0),$scope.isFromMobileApp=localStorage.getItem("isFromMobileApp"),$scope.isFromMobileApp){proposalId=$location.search().proposalId;RestAPI.invoke("proposalDataReader",{proposalId:proposalId,businessLineId:2}).then(function(response){(response.responseCode=1e3)&&($scope.policyInfo={carrierId:response.data.PolicyTransaction.carrierId,registrationNo:response.data.PolicyTransaction.proposalRequest.vehicleDetails.registrationNumber,policyNo:response.data.PolicyTransaction.bikePolicyResponse.policyNo,idv:response.data.PolicyTransaction.proposalRequest.premiumDetails.insuredDeclareValue,ncb:response.data.PolicyTransaction.proposalRequest.premiumDetails.ncbPercentage,vehicle:response.data.PolicyTransaction.proposalRequest.vehicleDetails.make+" "+response.data.PolicyTransaction.proposalRequest.vehicleDetails.model+" "+response.data.PolicyTransaction.proposalRequest.vehicleDetails.variant,email:response.data.PolicyTransaction.proposalRequest.proposerDetails.emailId,transactionId:response.data.PolicyTransaction.proposalId,premium:response.data.PolicyTransaction.proposalRequest.premiumDetails.grossPremium,validity:response.data.PolicyTransaction.policyStartDate+" to "+response.data.PolicyTransaction.policyExpiryDate,mobileNo:response.data.PolicyTransaction.proposalRequest.proposerDetails.mobileNumber})})}else loadDatbase(function(){if(idepProdEnv&&($rootScope.modalSurvey=!0),console.log("wordPressEnabled",wordPressEnabled),agencyPortalEnabled&&($scope.agencyPortalEnabled=agencyPortalEnabled),wordPressEnabled?($rootScope.wordPressEnabled=wordPressEnabled,$rootScope.wp_path=wp_path):$rootScope.wp_path="",localStorageService.get("bikeReponseToken")?$scope.bikeReponseToken=localStorageService.get("bikeReponseToken"):$scope.bikeReponseToken={},$rootScope.displayTimer=function(maxDuration){$timeout(function(){$rootScope.displayTime=maxDuration-1,maxDuration--,1==$rootScope.displayTime&&($window.top.location.href=$rootScope.affilateURL),$rootScope.displayTime>1&&$rootScope.displayTimer(maxDuration)},1e3)},console.log("$rootScope.affilateURL in paysucess :"+$rootScope.affilateURL),$scope.p365Labels=bikePolicyLabels,$rootScope.title=$scope.p365Labels.policies365Title.PaySuccess,policies365Details?$scope.policies365Details=policies365Details:(console.log("retrieving p365 labels using UI"),$scope.policies365Details=p365UIVar),$location.search().proposalId?proposalId=$location.search().proposalId:$location.search().proposalNo?proposalId=$location.search().proposalNo:localStorageService.get("proposalIdEncrypted")&&(proposalId=localStorageService.get("proposalIdEncrypted")),proposalId){var proposalDocParam={};proposalDocParam.proposalId=proposalId,proposalDocParam.businessLineId=2,RestAPI.invoke("proposalDataReader",proposalDocParam).then(function(proposalDataResponse){if(proposalDataResponse.responsecode==$scope.p365Labels.responseCode.success){if($scope.proposalDataResponse=proposalDataResponse.data.PolicyTransaction,$scope.sendPolicySuccessEmail(),$scope.proposalDataResponse.requestSource&&"posp"==$scope.proposalDataResponse.requestSource&&$location.search("userName",$scope.proposalDataResponse.userName),$scope.proposalDataResponse.bikePolicyResponse.policyNo?1==imauticAutomation&&imatEvent("PaymentGenerated"):1==imauticAutomation&&imatEvent("PaymentSuccess"),bikeProposeFormDetails=$scope.proposalDataResponse.proposalRequest,localStorageService.get("quoteUserInfo")){var quoteUserInfo=localStorageService.get("quoteUserInfo");quoteUserInfo.createLeadStatus=!0,localStorageService.set("quoteUserInfo",quoteUserInfo),$scope.quoteUserInfo&&(messageIDVar=quoteUserInfo.messageId)}if($scope.loading=!1,localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){var rampUniqueId=localStorage.getItem("rampUniqueId"),rampRedirectURL=localStorage.getItem("rampRedirectURL");policyEndDate=$scope.proposalDataResponse.proposalRequest.insuranceDetails.policyEndDate?$scope.proposalDataResponse.proposalRequest.insuranceDetails.policyEndDate:"NA";var policyDetails={rampUniqueId:rampUniqueId,policyDetails:{status:"success",ins_provider_name:$scope.proposalDataResponse.proposalRequest.premiumDetails.insuranceCompany,exp_date:policyEndDate,payment_amount:$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium}};console.log("redirection url is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:rampRedirectURL,headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("ramp api response is: ",callback)}).error(function(data,status){console.log("ramp api response in error is: ",data)})}if(localStorage.getItem("desiSkillUniqueId")){var desiSkillUniqueId=localStorage.getItem("desiSkillUniqueId"),desiSkillAgentId=localStorage.getItem("desiSkillAgentId"),selectedMake="",selectedModel="",selectedVariant="",selectedVehicleDetails={};localStorageService.get("bikeQuoteInputParamaters")?(selectedMake=(selectedVehicleDetails=localStorageService.get("bikeQuoteInputParamaters").vehicleInfo).make,selectedModel=selectedVehicleDetails.model,selectedVariant=selectedVehicleDetails.variant):(selectedMake=$scope.proposalDataResponse.proposalRequest.vehicleDetails.make,selectedModel=$scope.proposalDataResponse.proposalRequest.vehicleDetails.model,selectedVariant=$scope.proposalDataResponse.proposalRequest.vehicleDetails.variant),policyNo=$location.search().policyNo?$location.search().policyNo:$scope.proposalDataResponse.bikePolicyResponse.policyNo;policyDetails={mblNum:$scope.proposalDataResponse.bikePolicyResponse.mobile,txnId:desiSkillUniqueId,make:selectedMake,model:selectedModel,variant:selectedVariant,policyNumber:policyNo,type:"bike",agentId:desiSkillAgentId,premiumAmount:$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium};console.log("policy details  is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:"https://crm.gkms.in/api/insurance/p365_callback.php",headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("ramp api response is: ",callback)}).error(function(data,status){console.log("ramp api response in error is: ",data)})}}else{if($scope.loading=!1,localStorage.getItem("desiSkillUniqueId")){var policyNo;desiSkillUniqueId=localStorage.getItem("desiSkillUniqueId"),desiSkillAgentId=localStorage.getItem("desiSkillAgentId");policyNo=$location.search().policyNo?$location.search().policyNo:$scope.proposalDataResponse.bikePolicyResponse.policyNo;policyDetails={mblNum:$scope.proposalDataResponse.bikePolicyResponse.mobile,txnId:desiSkillUniqueId,make:$scope.proposalDataResponse.proposalRequest.vehicleDetails.make,model:$scope.proposalDataResponse.proposalRequest.vehicleDetails.model,variant:$scope.proposalDataResponse.proposalRequest.vehicleDetails.variant,policyNumber:policyNo,type:"bike",agentId:desiSkillAgentId,premiumAmount:$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium};console.log("policy details  is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:"https://crm.gkms.in/api/insurance/p365_callback.php",headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("ramp api response is: ",callback)}).error(function(data,status){console.log("ramp api response in error is: ",data)})}if(localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){var policyEndDate;rampUniqueId=localStorage.getItem("rampUniqueId"),rampRedirectURL=localStorage.getItem("rampRedirectURL");policyEndDate=$scope.proposalDataResponse.proposalRequest.insuranceDetails.policyEndDate?$scope.proposalDataResponse.proposalRequest.insuranceDetails.policyEndDate:"NA";policyDetails={rampUniqueId:rampUniqueId,policyDetails:{status:"success",ins_provider_name:$scope.proposalDataResponse.proposalRequest.premiumDetails.insuranceCompany,exp_date:policyEndDate,payment_amount:$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium}};console.log("redirection url is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:rampRedirectURL,headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("ramp api response is: ",callback)}).error(function(data,status){console.log("ramp api response in error is: ",data)})}$rootScope.P365Alert("Policies365","Some error Occurred ","Ok")}})}$scope.sendSMS=function(){var validateAuthParam={paramMap:{}};validateAuthParam.mobileNumber=$scope.proposalDataResponse.proposalRequest.proposerDetails.mobileNumber,validateAuthParam.paramMap.firstName=$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName,validateAuthParam.funcType="PaymentSuccess",getDocUsingParam(RestAPI,"sendSMS",validateAuthParam,function(createOTP){createOTP.responseCode==$scope.p365Labels.responseCode.success?console.log("sms sent successfully for payment success"):console.log("unable to  sent sms for payment success")})},$scope.sendPolicySuccessEmail=function(){var proposalDetailsEmail={paramMap:{},funcType:"ProposalSuccessTemplate"};console.log("$scope.proposalDataResponse is: ",$scope.proposalDataResponse),proposalDetailsEmail.username=$scope.proposalDataResponse.proposalRequest.proposerDetails.emailId.trim(),proposalDetailsEmail.paramMap.customerName=$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName.trim()+" "+$scope.proposalDataResponse.proposalRequest.proposerDetails.lastName.trim(),proposalDetailsEmail.paramMap.selectedPolicyType="Bike",RestAPI.invoke("sendEmail",proposalDetailsEmail).then(function(emailResponse){emailResponse.responseCode,$scope.p365Labels.responseCode.success,$scope.sendSMS()})},$scope.redirectURL=function(){if(console.log("rampUniqueId is",localStorage.getItem("rampUniqueId")),console.log("rampRedirectURL is",localStorage.getItem("rampRedirectURL")),localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){localStorage.getItem("rampUniqueId");var rampRedirectURL=localStorage.getItem("rampRedirectURL");$window.location.href=rampRedirectURL}else if(localStorage.getItem("carEagerUniqueId")){var thirdPartyRedirectionURL="http://13.233.36.16:4000/api/job/callback/new/policy/?registration_no="+$scope.proposalDataResponse.proposalRequest.vehicleDetails.registrationNumber+"&policy_holder="+$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName+"&insurance_company="+$scope.proposalDataResponse.proposalRequest.premiumDetails.insuranceCompany+"&policy_no="+$scope.proposalDataResponse.bikePolicyResponse.policyNo+"&premium="+$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium+"&expire="+$scope.proposalDataResponse.proposalRequest.insuranceDetails.policyEndDate+"&cashless=Yes&policy_type="+$scope.proposalDataResponse.proposalRequest.insuranceDetails.insuranceType+"&UniqueId="+localStorage.getItem("carEagerUniqueId");console.log("thirdPartyRedirectionURL is::",thirdPartyRedirectionURL),$window.location.href=$sce.trustAsResourceUrl(thirdPartyRedirectionURL)}else agencyPortalEnabled?idepProdEnv?$window.location.href="https://www.policies365.com":$window.location.href="https://www.policies365.com":$scope.pospBackButtonEnabled?$window.location.href="http://pospuat.policies365.com":(console.log("$rootScope.affilateURL is: ",$rootScope.affilateURL),$window.location.href=$rootScope.affilateURL)},$scope.viewPolicy=function(){$scope.modalOTP=!0,$scope.resendOTP()},$scope.closeAuthenticateForm=function(){$scope.modalOTP=!1},$scope.authenticateUser=function(){$scope.disableOTP=!1;var authenticateUserParam={};authenticateUserParam.mobileNumber=bikeProposeFormDetails.proposerDetails.mobileNumber,authenticateUserParam.OTP=Number($scope.authenticate.enteredOTP),getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.validateOTP,authenticateUserParam,function(createOTP){if(createOTP.responseCode==$scope.p365Labels.responseCode.success){$scope.invalidOTPError="",$scope.modalOTP=!1;var userLoginInfo={};userLoginInfo.username=createOTP.data.firstName,userLoginInfo.mobileNumber=createOTP.data.mobile,userLoginInfo.status=!0,localStorageService.set("userLoginInfo",userLoginInfo),localStorageService.set("userProfileDetails",createOTP.data),$location.path("/dashboard")}else createOTP.responseCode==$scope.p365Labels.responseCode.noRecordsFound?$scope.invalidOTPError=$scope.p365Labels.validationMessages.invalidOTP:createOTP.responseCode==$scope.p365Labels.responseCode.expiredOTP?$scope.invalidOTPError=$scope.p365Labels.validationMessages.expiredOTP:$scope.invalidOTPError=$scope.p365Labels.validationMessages.authOTP})},$scope.resendOTP=function(){var validateLoginParam={paramMap:{}};validateLoginParam.mobileNumber=bikeProposeFormDetails.proposerDetails.mobileNumber,validateLoginParam.funcType=$scope.p365Labels.functionType.optAuth,validateLoginParam.paramMap.OTP=$scope.p365Labels.functionType.otpGenerate,getDocUsingParam(RestAPI,$scope.p365Labels.transactionName.sendSMS,validateLoginParam,function(createOTP){createOTP.responseCode==$scope.p365Labels.responseCode.success?$scope.invalidOTPError="":createOTP.responseCode==$scope.p365Labels.responseCode.blockedMobile?($scope.invalidOTPError=createOTP.message,$scope.disableOTP=!0):$scope.invalidOTPError=$scope.p365Labels.errorMessage.createOTP})}})}]),angular.module("payFailureBike",["CoreComponentApp","LocalStorageModule","ngMessages"]).controller("payFailureBikeController",["RestAPI","$scope","$rootScope","$location","$window","$http","localStorageService","$timeout","$sce",function(RestAPI,$scope,$rootScope,$location,$window,$http,localStorageService,$timeout,$sce){console.log("agencyPortalEnabled in bike failure is : ",agencyPortalEnabled);var pospBackButtonEnabled=!1,p365UIVar={mobileNumber:"+91 9962411255",mobileNumberTrim:"+919962411255",salesAssistNumber:"(022) 68284343",salesAssistNumberTrim:"02268284343",salesAssistNumberLanding:"022-68284343",claimsNumber:"(022) 42114299",claimsNumberTrim:"02242114299",claimsNumberLanding:"022-42114299",infoEmailId:"contact@policies365.com"};agencyPortalEnabled&&($scope.agencyPortalEnabled=agencyPortalEnabled),$location.search().source&&"posp"==$location.search().source&&(pospBackButtonEnabled=!0),loadDatbase(function(){idepProdEnv&&($rootScope.modalSurvey=!0),wordPressEnabled?($rootScope.wordPressEnabled=wordPressEnabled,$rootScope.wp_path=wp_path):$rootScope.wp_path="",$scope.redirectURL=function(){if(localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){var rampUniqueId=localStorage.getItem("rampUniqueId"),rampRedirectURL=localStorage.getItem("rampRedirectURL"),policyDetails="{rampUniqueId:"+rampUniqueId+",policyDetails:{status:failure}}";console.log("redirection url is:"+JSON.stringify(policyDetails)),window.location.href=rampRedirectURL}else if(localStorage.getItem("carEagerUniqueId")){var thirdPartyRedirectionURL="http://13.233.36.16:4000/api/job/callback/new/policy/?registration_no="+$scope.proposalDataResponse.proposalRequest.vehicleDetails.registrationNumber+"&policy_holder="+$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName+"&insurance_company="+$scope.proposalDataResponse.proposalRequest.premiumDetails.insuranceCompany+"&policy_no="+$scope.proposalDataResponse.bikePolicyResponse.policyNo+"&premium="+$scope.proposalDataResponse.proposalRequest.premiumDetails.grossPremium+"&expire="+$scope.proposalDataResponse.proposalRequest.insuranceDetails.policyEndDate+"&cashless=Yes&policy_type="+$scope.proposalDataResponse.proposalRequest.insuranceDetails.insuranceType+"&UniqueId="+localStorage.getItem("carEagerUniqueId");console.log("thirdPartyRedirectionURL is::",thirdPartyRedirectionURL),window.location.href=thirdPartyRedirectionURL}else pospBackButtonEnabled?$window.location.href="http://pospuat.policies365.com":agencyPortalEnabled?idepProdEnv?$window.location.href="https://www.policies365.com":$window.location.href="https://www.policies365.com":$window.location.href=$rootScope.affilateURL},$scope.sendSMS=function(){var validateAuthParam={paramMap:{}};validateAuthParam.mobileNumber=$scope.proposalDataResponse.proposalRequest.proposerDetails.mobileNumber,validateAuthParam.paramMap.firstName=$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName,validateAuthParam.funcType="ProposalFailed",getDocUsingParam(RestAPI,"sendSMS",validateAuthParam,function(createOTP){createOTP.responseCode==$scope.p365Labels.responseCode.success?console.log("sms sent successfully for payment failure"):console.log("unable to  sent sms for payment failure")})},$scope.sendPolicySuccessEmail=function(){var proposalDetailsEmail={paramMap:{},funcType:"ProposalFailureTemplate"};console.log("$scope.proposalDataResponse is: ",$scope.proposalDataResponse),proposalDetailsEmail.username=$scope.proposalDataResponse.proposalRequest.proposerDetails.emailId.trim(),proposalDetailsEmail.paramMap.customerName=$scope.proposalDataResponse.proposalRequest.proposerDetails.firstName.trim()+" "+$scope.proposalDataResponse.proposalRequest.proposerDetails.lastName.trim(),proposalDetailsEmail.paramMap.selectedPolicyType="Two Wheeler",RestAPI.invoke("sendEmail",proposalDetailsEmail).then(function(emailResponse){emailResponse.responseCode,$scope.p365Labels.responseCode.success,$scope.sendSMS()})},$rootScope.displayTimer=function(maxDuration){$timeout(function(){$rootScope.displayTime=maxDuration-1,maxDuration--,1==$rootScope.displayTime&&($window.top.location.href=$rootScope.affilateURL),$rootScope.displayTime>1&&$rootScope.displayTimer(maxDuration)},1e3)},console.log("$rootScope.affilateUser in paysucess :"+$rootScope.affilateUser),$scope.p365Labels=bikePolicyLabels,policies365Details?$scope.policies365Details=policies365Details:(console.log("retrieving p365 labels using UI"),$scope.policies365Details=p365UIVar),$scope.statusCode=$location.search().statusCode?$location.search().statusCode:void 0,$rootScope.title=$scope.p365Labels.policies365Title.PayFailure,console.log("Bike Common Labels Received."),console.log("Bike Proposal Form Param Received. : "+JSON.stringify($scope.bikeProposeFormDetails)),$scope.bikeReponseToken=localStorageService.get("bikeReponseToken"),console.log("Bike Proposal Submission Response Received. : "+JSON.stringify($scope.bikeReponseToken));var quoteUserInfo=localStorageService.get("quoteUserInfo");console.log("Bike Quote User Info Received. : "+JSON.stringify(quoteUserInfo)),quoteUserInfo&&(messageIDVar=quoteUserInfo.messageId,$scope.$apply());var proposalId="";if($location.search().proposalId?proposalId=$location.search().proposalId:$scope.bikeReponseToken&&$scope.bikeReponseToken.proposalId&&(proposalId=$scope.bikeReponseToken.proposalId),proposalId){var proposalDocParam={};proposalDocParam.proposalId=proposalId,proposalDocParam.businessLineId=2,RestAPI.invoke("proposalDataReader",proposalDocParam).then(function(proposalDataResponse){if(proposalDataResponse.responsecode==$scope.p365Labels.responseCode.success){proposalDataResponse=proposalDataResponse.data.PolicyTransaction;console.log("$scope.proposalDataResponse in car failure",proposalDataResponse),$scope.proposalDataResponse=proposalDataResponse,$scope.sendPolicySuccessEmail(),proposalDataResponse.requestSource&&"posp"==proposalDataResponse.requestSource&&$location.search("userName",proposalDataResponse.userName),$scope.loading=!1}if(localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){var rampUniqueId=localStorage.getItem("rampUniqueId"),rampRedirectURL=localStorage.getItem("rampRedirectURL"),policyDetails={rampUniqueId:rampUniqueId,policyDetails:{status:"failure"}};console.log("redirection url is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:rampRedirectURL,headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("ramp api response is: ",callback)}).error(function(data,status){console.log("ramp api response in error is: ",data)})}})}if(localStorage.getItem("rampUniqueId")&&localStorage.getItem("rampRedirectURL")){var rampUniqueId=localStorage.getItem("rampUniqueId"),rampRedirectURL=localStorage.getItem("rampRedirectURL"),policyDetails={rampUniqueId:rampUniqueId,policyDetails:{status:"failure"}};console.log("redirection url is:"+JSON.stringify(policyDetails)),$http({method:"POST",url:rampRedirectURL,headers:{"Content-Type":"text/plain"},data:policyDetails}).success(function(callback,status){console.log("ramp api response is: ",callback)}).error(function(data,status){console.log("ramp api response in error is: ",data)})}}),1==imauticAutomation&&imatEvent("PaymentFailure")}]),angular.module("twoWheelerPolicyPurchase",["LocalStorageModule"]).controller("twoWheelerPolicyPurchaseController",["$scope","localStorageService",function($scope,localStorageService){$scope.policyDocument=localStorageService.get("policyDocDetails"),$scope.businessLineId=localStorageService.get("selectedBusinessLineId"),1==$scope.businessLineId?$scope.lineOfBusiness="Life":2==$scope.businessLineId?$scope.lineOfBusiness="Bike":3==$scope.businessLineId?$scope.lineOfBusiness="Car":5==$scope.businessLineId?$scope.lineOfBusiness="Travel":$scope.lineOfBusiness="Health"}]);